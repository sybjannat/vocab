<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Vocabulary">

  <title>Daily Vocab</title>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --dark: #1f2937;
      --light: #f9fafb;
      --gray: #6b7280;
      --border: #e5e7eb;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f0f4ff 0%, #f8fafc 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      -webkit-tap-highlight-color: transparent;
    }

    .app-container {
      width: 100%;
      max-width: 1200px;
      background: white;
      border-radius: 24px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    /* HEADER */
    .app-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 35px 40px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .app-header h1 {
      font-size: 36px;
      margin-bottom: 12px;
      font-weight: 800;
      letter-spacing: -0.5px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .app-header p {
      opacity: 0.9;
      font-size: 16px;
      font-weight: 500;
      max-width: 500px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* CONNECTION STATUS */
    .connection-status {
      padding: 16px;
      text-align: center;
      font-weight: 600;
      font-size: 15px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .status-online {
      background: #d1fae5;
      color: #065f46;
    }

    .status-offline {
      background: #fef3c7;
      color: #92400e;
    }

    .status-syncing {
      background: #dbeafe;
      color: #1e40af;
    }

    /* TABS */
    .app-tabs {
      display: flex;
      background: var(--light);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
    }

    .app-tab {
      flex: 1;
      padding: 22px 20px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: var(--gray);
      border-bottom: 3px solid transparent;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 15px;
      position: relative;
      overflow: hidden;
    }

    .app-tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 3px;
      background: var(--primary);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateX(-50%);
    }

    .app-tab:hover {
      color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }

    .app-tab:hover::after {
      width: 40px;
    }

    .app-tab.active {
      color: var(--primary);
      background: white;
    }

    .app-tab.active::after {
      width: 100%;
    }

    /* TAB CONTENT */
    .tab-content {
      display: none;
      padding: 35px 40px;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .tab-content.active {
      display: block;
    }

    /* FORM */
    .form-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 24px;
      position: relative;
    }

    .form-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      color: var(--dark);
      font-weight: 600;
      font-size: 15px;
    }

    .form-label .material-icons-round {
      font-size: 20px;
      color: var(--primary);
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 16px 18px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      transition: all 0.3s;
      background: white;
      -webkit-appearance: none;
      min-height: 44px;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.6;
    }

    .form-select {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 16px;
      padding-right: 48px;
    }

    .word-exists-alert {
      margin-top: 8px;
      padding: 12px 16px;
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      color: #92400e;
      font-size: 14px;
      display: none;
      align-items: center;
      gap: 10px;
      animation: slideDown 0.3s ease;
    }

    .word-exists-alert.show {
      display: flex;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ENHANCED CATEGORY DROPDOWN STYLES */
    .enhanced-select-wrapper {
      position: relative;
      width: 100%;
      margin-bottom: 10px;
    }

    .enhanced-select-wrapper::after {
      content: '';
      position: absolute;
      top: 50%;
      right: 16px;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid var(--gray);
      pointer-events: none;
      transition: transform 0.3s ease;
      z-index: 2;
    }

    .enhanced-select-wrapper.open::after {
      transform: translateY(-50%) rotate(180deg);
    }

    .enhanced-select {
      width: 100%;
      padding: 16px 52px 16px 16px;
      border: 2px solid var(--border);
      border-radius: 14px;
      font-size: 16px;
      font-family: inherit;
      font-weight: 500;
      color: var(--dark);
      background-color: white;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      z-index: 1;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 20px;
      padding-right: 48px;
    }

    .enhanced-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
      transform: translateY(-2px);
    }

    .enhanced-select:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }

    .enhanced-select.placeholder {
      color: var(--gray);
    }

    /* Custom dropdown container */
    .custom-dropdown {
      position: relative;
      width: 100%;
    }

    .dropdown-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 14px;
      background: white;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .dropdown-header:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
      transform: translateY(-2px);
    }

    .dropdown-header:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
    }

    .dropdown-header.active {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }

    .selected-option {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .selected-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .selected-text {
      font-weight: 600;
      color: var(--dark);
      font-size: 16px;
    }

    .dropdown-arrow {
      color: var(--gray);
      font-size: 20px;
      transition: transform 0.3s ease;
    }

    .dropdown-header.active .dropdown-arrow {
      transform: rotate(180deg);
      color: var(--primary);
    }

    .dropdown-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--primary);
      border-top: none;
      border-radius: 0 0 14px 14px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      max-height: 350px;
      overflow-y: auto;
      display: none;
      animation: slideDown 0.3s ease;
      margin-top: -2px;
    }

    .dropdown-options.show {
      display: block;
    }

    .dropdown-option {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .dropdown-option:last-child {
      border-bottom: none;
    }

    .dropdown-option:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
      transform: translateX(4px);
    }

    .dropdown-option.selected {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    }

    .option-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .option-text {
      font-weight: 500;
      color: var(--dark);
      flex: 1;
    }

    .option-count {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.05);
      color: var(--gray);
      font-weight: 600;
    }

    .add-category-option {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
      border-top: 1px solid rgba(0, 0, 0, 0.05);
    }

    .add-category-option:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    }

    .add-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .add-text {
      font-weight: 600;
      color: var(--primary);
      font-size: 14px;
    }

    /* Category pill in form */
    .category-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin: 5px 0;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
      animation: fadeIn 0.3s ease;
    }

    .category-pill-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
    }

    /* Responsive dropdown */
    @media (max-width: 768px) {
      .dropdown-header {
        padding: 14px;
      }

      .dropdown-option {
        padding: 12px 14px;
      }

      .selected-text {
        font-size: 15px;
      }

      .option-text {
        font-size: 15px;
      }
    }

    /* BUTTONS */
    .buttons-row {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 35px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 16px 32px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      min-width: 160px;
      min-height: 52px;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.1), 0 2px 4px -1px rgba(99, 102, 241, 0.06);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.1), 0 4px 6px -2px rgba(99, 102, 241, 0.05);
    }

    .btn-secondary {
      background: var(--light);
      color: var(--dark);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: #f3f4f6;
      transform: translateY(-2px);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #0da271 100%);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      color: white;
    }

    .btn-info {
      background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%);
      color: white;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
      min-width: auto;
      min-height: auto;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    /* BUTTON LOADING ANIMATION */
    .btn .material-icons-round.spin {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* FILTER & SORT BAR */
    .filter-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 200px;
    }

    .filter-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--dark);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 100px;
    }

    .filter-select {
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      flex: 1;
      min-width: 150px;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* SEARCH CONTAINER */
    .search-container {
      flex: 2;
      min-width: 300px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 48px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      background: white;
      transition: all 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 20px;
      pointer-events: none;
    }

    /* WORDS LIST */
    .words-container {
      max-height: 600px;
      overflow-y: auto;
      padding-right: 10px;
      margin-bottom: 30px;
      -webkit-overflow-scrolling: touch;
    }

    .words-container::-webkit-scrollbar {
      width: 8px;
    }

    .words-container::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }

    .words-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    .words-container::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .word-card {
      background: white;
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .word-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: var(--primary);
      transition: width 0.3s ease;
    }

    .word-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
    }

    .word-card:hover::before {
      width: 8px;
    }

    .word-card.synced::before {
      background: var(--success);
    }

    .word-card.from-other::before {
      background: var(--secondary);
    }

    .word-card.offline::before {
      background: var(--warning);
    }

    .word-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .word-title-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .word-title {
      font-size: 26px;
      font-weight: 700;
      color: var(--dark);
      line-height: 1.2;
    }

    /* CATEGORY BADGES WITH COLORS */
    .category-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-width: 120px;
      justify-content: center;
    }

    .category-badge .material-icons-round {
      font-size: 14px;
    }

    /* Custom colors will be added via JavaScript */

    .word-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: none;
      background: var(--light);
      color: var(--gray);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .action-btn:hover {
      transform: translateY(-2px);
    }

    .action-btn.pronounce:hover {
      background: #dcfce7;
      color: #166534;
    }

    .action-btn.edit:hover {
      background: #dbeafe;
      color: var(--primary);
    }

    .action-btn.delete:hover {
      background: #fee2e2;
      color: var(--danger);
    }

    .action-btn .material-icons-round {
      font-size: 20px;
    }

    .word-meta {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .word-status {
      font-size: 12px;
      padding: 7px 14px;
      border-radius: 20px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-online-badge {
      background: #d1fae5;
      color: #065f46;
    }

    .status-offline-badge {
      background: #fef3c7;
      color: #92400e;
    }

    .status-synced-badge {
      background: #dbeafe;
      color: #1e40af;
    }

    .device-badge {
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .device-badge.me {
      background: #e0f2fe;
      color: #0369a1;
    }

    .device-badge.other {
      background: #f3e8ff;
      color: #6b21a8;
    }

    .word-date {
      color: var(--gray);
      font-size: 14px;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .word-content {
      margin-top: 20px;
    }

    .meaning-row {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 15px;
    }

    .meaning-icon {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .meaning-icon.bangla {
      background: #dcfce7;
      color: #166534;
    }

    .meaning-icon.english {
      background: #dbeafe;
      color: #1e40af;
    }

    .meaning-icon .material-icons-round {
      font-size: 20px;
    }

    .meaning-text {
      flex: 1;
      color: var(--dark);
      line-height: 1.7;
    }








    // Add to your CSS section
    const style=document.createElement('style');

    style.textContent=` @keyframes popIn {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0;
      }

      70% {
        transform: translate(-50%, -50%) scale(1.1);
        opacity: 1;
      }

      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    .rating-feedback {
      animation: popIn 0.3s ease-out;
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .modal-overlay.active {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    /* Meaning display styles for flashcard */
    .meaning-section {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    .meaning-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .meaning-label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .meaning-text {
      font-size: 16px;
      color: #111827;
      line-height: 1.5;
    }

    .no-meaning {
      color: #9ca3af;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    `;
    document.head.appendChild(style);










    /* ========== MODERN FLASHCARD STYLES ========== */
    .modern-flashcard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 10px;
    }

    .flashcard-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .flashcard-header h2 {
      font-size: 32px;
      color: var(--dark);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .flashcard-header p {
      color: var(--gray);
      font-size: 16px;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* Control Panel */
    .flashcard-control-panel {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .control-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .control-item {
      display: flex;
      flex-direction: column;
    }

    .control-label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--dark);
      font-size: 15px;
    }

    .control-label .material-icons-round {
      color: var(--primary);
      font-size: 20px;
    }

    .modern-select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 15px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 16px;
      appearance: none;
    }

    .modern-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .modern-select:hover {
      border-color: var(--primary);
    }












    /* Action Buttons - Attractive & Perfectly Sized */
    .action-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      align-items: center;
      margin: 40px 0;
      padding: 25px;
      background: white;
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      position: relative;
      overflow: hidden;
    }

    /* Subtle background pattern */
    .action-buttons::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.03) 0%, transparent 50%);
      pointer-events: none;
    }

    /* Button Styles */
    .shuffle-btn,
    .reset-btn {
      padding: 18px 32px;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 56px;
      min-width: 180px;
      position: relative;
      overflow: hidden;
      letter-spacing: 0.3px;
    }

    /* Shuffle Button */
    .shuffle-btn {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.25);
    }

    .shuffle-btn:hover {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(139, 92, 246, 0.35);
    }

    .shuffle-btn:active {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.25);
    }

    /* Reset Button */
    .reset-btn {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      color: #4b5563;
      border: 2px solid #e5e7eb;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .reset-btn:hover {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      color: #dc2626;
      border-color: #fecaca;
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(220, 38, 38, 0.1);
    }

    .reset-btn:active {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(220, 38, 38, 0.05);
    }

    /* Button Icons */
    .action-btn .material-icons-round {
      font-size: 22px;
      transition: transform 0.3s ease;
    }

    .shuffle-btn:hover .material-icons-round {
      transform: rotate(15deg);
    }

    .reset-btn:hover .material-icons-round {
      transform: rotate(-90deg);
    }

    /* Button Ripple Effect */
    .shuffle-btn::after,
    .reset-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .shuffle-btn:active::after,
    .reset-btn:active::after {
      width: 200px;
      height: 200px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .action-buttons {
        flex-direction: column;
        gap: 16px;
        padding: 20px;
        margin: 30px 0;
      }

      .shuffle-btn,
      .reset-btn {
        width: 100%;
        max-width: 320px;
        padding: 16px 28px;
        min-height: 54px;
      }
    }

    @media (max-width: 480px) {
      .action-buttons {
        padding: 18px;
        margin: 25px 0;
        border-radius: 16px;
      }

      .shuffle-btn,
      .reset-btn {
        padding: 15px 24px;
        min-height: 52px;
        font-size: 15px;
      }

      .action-btn .material-icons-round {
        font-size: 20px;
      }
    }

    /* Tablet specific */
    @media (min-width: 769px) and (max-width: 1024px) {
      .action-buttons {
        padding: 22px;
      }

      .shuffle-btn,
      .reset-btn {
        padding: 17px 28px;
        min-width: 160px;
      }
    }

    /* Button container border animation */
    .action-buttons {
      border: 1px solid transparent;
      background: linear-gradient(white, white) padding-box,
        linear-gradient(135deg, #e5e7eb 0%, transparent 50%) border-box;
    }

    /* Focus states for accessibility */
    .shuffle-btn:focus,
    .reset-btn:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }






















    /* Progress Stats */
    .progress-stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .progress-card {
      background: white;
      border-radius: 16px;
      padding: 25px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: all 0.3s;
    }

    .progress-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .progress-icon {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .progress-icon .material-icons-round {
      font-size: 30px;
      color: white;
    }

    .progress-info {
      flex: 1;
    }

    .progress-number {
      font-size: 32px;
      font-weight: 800;
      color: var(--dark);
      line-height: 1;
      margin-bottom: 5px;
    }

    .progress-label {
      font-size: 14px;
      color: var(--gray);
      font-weight: 600;
    }

    /* Empty State */
    .empty-flashcard-state {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 24px;
      border: 2px dashed var(--border);
      margin: 40px 0;
    }

    .empty-icon {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 25px;
    }

    .empty-icon .material-icons-round {
      font-size: 48px;
      color: var(--primary);
    }

    .empty-flashcard-state h3 {
      font-size: 24px;
      color: var(--dark);
      margin-bottom: 12px;
    }

    .empty-flashcard-state p {
      color: var(--gray);
      font-size: 16px;
      max-width: 400px;
      margin: 0 auto 30px;
      line-height: 1.6;
    }

    /* Flashcard Display */
    .flashcard-display-container {
      background: white;
      border-radius: 24px;
      padding: 30px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    }

    .session-progress {
      margin-bottom: 30px;
    }

    .progress-bar {
      height: 8px;
      background: var(--light);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: var(--gray);
    }

    .progress-text span {
      font-weight: 600;
      color: var(--dark);
    }

    /* Modern Flashcard */
    .modern-flashcard {
      width: 100%;
      max-width: 500px;
      height: 400px;
      margin: 0 auto 40px;
      perspective: 1000px;
      cursor: pointer;
    }

    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .modern-flashcard.flipped .card-inner {
      transform: rotateY(180deg);
    }

    .card-front,
    .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 24px;
      padding: 30px;
      display: flex;
      flex-direction: column;
    }

    .card-front {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 2px solid var(--border);
    }

    .card-back {
      background: white;
      border: 2px solid var(--primary);
      transform: rotateY(180deg);
      overflow-y: auto;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-badge {
      padding: 6px 14px;
      background: var(--light);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card-badge.success {
      background: #d1fae5;
      color: #065f46;
    }








    /* Reset Modal Styles */
    .reset-modal-content {
      padding: 10px 0;
      text-align: center;
    }

    .reset-icon {
      margin-bottom: 25px;
    }

    .reset-icon-circle {
      width: 80px;
      height: 80px;
      margin: 0 auto;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 4px solid white;
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.15);
    }

    .reset-icon-circle .material-icons-round {
      font-size: 40px;
      color: #d97706;
    }

    .reset-title {
      font-size: 22px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 12px;
    }

    .reset-message {
      font-size: 15px;
      color: #6b7280;
      line-height: 1.6;
      margin-bottom: 25px;
      max-width: 350px;
      margin-left: auto;
      margin-right: auto;
    }

    .reset-stats {
      background: #fffbeb;
      border: 2px solid #fef3c7;
      border-radius: 16px;
      padding: 20px;
      margin: 25px 0;
    }

    .reset-stat-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 0;
    }

    .reset-stat-item:not(:last-child) {
      border-bottom: 1px solid #fde68a;
    }

    .reset-stat-item .material-icons-round {
      width: 40px;
      height: 40px;
      min-width: 40px;
      background: white;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #d97706;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .stat-info {
      flex: 1;
      text-align: left;
    }

    .stat-label {
      font-size: 13px;
      color: #92400e;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #92400e;
    }

    .reset-warning {
      background: #fef3c7;
      border-radius: 12px;
      padding: 20px;
      margin: 25px 0;
      text-align: left;
    }

    .warning-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-weight: 600;
      color: #92400e;
    }

    .warning-header .material-icons-round {
      font-size: 20px;
    }

    .warning-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .warning-list li {
      padding: 8px 0 8px 28px;
      color: #92400e;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
    }

    .warning-list li:before {
      content: "•";
      position: absolute;
      left: 12px;
      color: #d97706;
      font-size: 18px;
    }

    .reset-actions {
      display: flex;
      gap: 12px;
      margin-top: 30px;
    }

    .reset-cancel-btn,
    .reset-confirm-btn {
      flex: 1;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 52px;
    }

    .reset-cancel-btn {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #6b7280;
      border: 2px solid #e5e7eb;
    }

    .reset-cancel-btn:hover {
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .reset-cancel-btn:active {
      transform: translateY(0);
    }

    .reset-confirm-btn {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: 2px solid #dc2626;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15);
    }

    .reset-confirm-btn:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.25);
    }

    .reset-confirm-btn:active {
      transform: translateY(0);
    }

    .reset-confirm-btn .material-icons-round {
      font-size: 18px;
    }

    /* Responsive adjustments for modal */
    @media (max-width: 768px) {
      .reset-actions {
        flex-direction: column;
      }

      .reset-cancel-btn,
      .reset-confirm-btn {
        width: 100%;
      }

      .reset-stats {
        padding: 15px;
      }

      .reset-stat-item {
        padding: 10px 0;
      }

      .stat-value {
        font-size: 18px;
      }
    }

    @media (max-width: 480px) {
      .reset-title {
        font-size: 20px;
      }

      .reset-message {
        font-size: 14px;
      }

      .warning-list li {
        font-size: 13px;
      }

      .reset-cancel-btn,
      .reset-confirm-btn {
        padding: 14px 20px;
        font-size: 14px;
      }
    }








    /* Reset Modal Styles */
    .reset-modal-content {
      padding: 10px 0;
      text-align: center;
    }

    .reset-icon {
      margin-bottom: 25px;
    }

    .reset-icon-circle {
      width: 80px;
      height: 80px;
      margin: 0 auto;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 4px solid white;
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.15);
    }

    .reset-icon-circle .material-icons-round {
      font-size: 40px;
      color: #d97706;
    }

    .reset-title {
      font-size: 22px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 12px;
    }

    .reset-message {
      font-size: 15px;
      color: #6b7280;
      line-height: 1.6;
      margin-bottom: 25px;
      max-width: 350px;
      margin-left: auto;
      margin-right: auto;
    }

    .reset-stats {
      background: #fffbeb;
      border: 2px solid #fef3c7;
      border-radius: 16px;
      padding: 20px;
      margin: 25px 0;
    }

    .reset-stat-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 0;
    }

    .reset-stat-item:not(:last-child) {
      border-bottom: 1px solid #fde68a;
    }

    .reset-stat-item .material-icons-round {
      width: 40px;
      height: 40px;
      min-width: 40px;
      background: white;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #d97706;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .stat-info {
      flex: 1;
      text-align: left;
    }

    .stat-label {
      font-size: 13px;
      color: #92400e;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #92400e;
    }

    .reset-warning {
      background: #fef3c7;
      border-radius: 12px;
      padding: 20px;
      margin: 25px 0;
      text-align: left;
    }

    .warning-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-weight: 600;
      color: #92400e;
    }

    .warning-header .material-icons-round {
      font-size: 20px;
    }

    .warning-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .warning-list li {
      padding: 8px 0 8px 28px;
      color: #92400e;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
    }

    .warning-list li:before {
      content: "•";
      position: absolute;
      left: 12px;
      color: #d97706;
      font-size: 18px;
    }

    .reset-actions {
      display: flex;
      gap: 12px;
      margin-top: 30px;
    }

    .reset-cancel-btn,
    .reset-confirm-btn {
      flex: 1;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 52px;
    }

    .reset-cancel-btn {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #6b7280;
      border: 2px solid #e5e7eb;
    }

    .reset-cancel-btn:hover {
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .reset-cancel-btn:active {
      transform: translateY(0);
    }

    .reset-confirm-btn {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: 2px solid #dc2626;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15);
    }

    .reset-confirm-btn:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.25);
    }

    .reset-confirm-btn:active {
      transform: translateY(0);
    }

    .reset-confirm-btn .material-icons-round {
      font-size: 18px;
    }

    /* Responsive adjustments for modal */
    @media (max-width: 768px) {
      .reset-actions {
        flex-direction: column;
      }

      .reset-cancel-btn,
      .reset-confirm-btn {
        width: 100%;
      }

      .reset-stats {
        padding: 15px;
      }

      .reset-stat-item {
        padding: 10px 0;
      }

      .stat-value {
        font-size: 18px;
      }
    }

    @media (max-width: 480px) {
      .reset-title {
        font-size: 20px;
      }

      .reset-message {
        font-size: 14px;
      }

      .warning-list li {
        font-size: 13px;
      }

      .reset-cancel-btn,
      .reset-confirm-btn {
        padding: 14px 20px;
        font-size: 14px;
      }
    }





    /* Responsive adjustments for action buttons */
    @media (max-width: 768px) {
      .action-buttons {
        justify-content: center;
        gap: 10px;
      }

      .shuffle-btn,
      .reset-btn {
        flex: 1;
        min-width: 140px;
        justify-content: center;
        padding: 14px 20px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .shuffle-btn,
      .reset-btn {
        width: 100%;
      }
    }

    @media (max-width: 480px) {

      .shuffle-btn,
      .reset-btn {
        padding: 12px 16px;
        font-size: 13px;
      }

      .action-btn .material-icons-round {
        font-size: 16px;
      }
    }










    .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .card-word {
      font-size: 42px;
      font-weight: 800;
      color: var(--dark);
      margin-bottom: 20px;
      line-height: 1.2;
    }

    .card-hint {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--gray);
      font-size: 14px;
      margin-top: 20px;
    }

    .meaning-text {
      font-size: 20px;
      color: var(--dark);
      line-height: 1.6;
      margin-bottom: 25px;
      text-align: center;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 15px;
    }

    .synonyms-text {
      color: var(--secondary);
      font-weight: 500;
      font-size: 16px;
      line-height: 1.5;
    }

    .example-text {
      font-style: italic;
      color: var(--dark);
      font-size: 16px;
      line-height: 1.6;
      padding: 15px;
      background: var(--light);
      border-radius: 12px;
      border-left: 4px solid var(--primary);
    }

    .card-footer {
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .pronounce-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--dark);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pronounce-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .hint-text {
      color: var(--gray);
      font-size: 14px;
      text-align: center;
      padding: 10px;
      background: var(--light);
      border-radius: 10px;
    }

    /* Difficulty Rating */
    .difficulty-rating {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin: 30px 0;
      border: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .rating-title {
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 20px;
    }

    .rating-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .rating-btn {
      padding: 16px;
      border: none;
      border-radius: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      transition: all 0.3s;
    }

    .rating-btn.difficult {
      background: #fee2e2;
      color: #dc2626;
    }

    .rating-btn.unsure {
      background: #fef3c7;
      color: #d97706;
    }

    .rating-btn.good {
      background: #d1fae5;
      color: #059669;
    }

    .rating-btn.easy {
      background: #dbeafe;
      color: #2563eb;
    }

    .rating-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .rating-btn .material-icons-round {
      font-size: 24px;
    }

    /* Navigation Controls */
    .navigation-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
    }

    .nav-btn {
      padding: 14px 28px;
      border: 2px solid var(--border);
      border-radius: 16px;
      background: white;
      color: var(--dark);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s;
      min-width: 140px;
    }

    .nav-btn:hover:not(:disabled) {
      border-color: var(--primary);
      background: var(--light);
      transform: translateY(-2px);
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .center-controls {
      display: flex;
      gap: 15px;
    }

    .control-btn {
      padding: 14px 24px;
      border: 2px solid var(--primary);
      background: var(--primary);
      color: white;
      border-radius: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s;
    }

    .control-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.2);
    }

    /* Session Summary */
    .session-summary {
      background: white;
      border-radius: 24px;
      padding: 40px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      text-align: center;
      margin-top: 40px;
    }

    .summary-header {
      margin-bottom: 40px;
    }

    .summary-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .summary-icon .material-icons-round {
      font-size: 40px;
      color: white;
    }

    .summary-header h3 {
      font-size: 28px;
      color: var(--dark);
      margin-bottom: 10px;
    }

    .summary-header p {
      color: var(--gray);
      font-size: 16px;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin: 40px 0;
    }

    .stat-item {
      padding: 25px;
      background: var(--light);
      border-radius: 16px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .stat-label {
      color: var(--gray);
      font-size: 14px;
      font-weight: 600;
    }

    .summary-progress {
      margin: 40px 0;
    }

    .progress-circle {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 0 auto 20px;
    }

    .circle-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      font-weight: 800;
      color: var(--dark);
    }

    .progress-text {
      color: var(--gray);
      font-size: 14px;
    }

    .summary-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 40px;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .modern-flashcard {
        height: 350px;
        max-width: 450px;
      }

      .card-word {
        font-size: 36px;
      }

      .meaning-text {
        font-size: 18px;
      }
    }

    @media (max-width: 768px) {
      .modern-flashcard {
        height: 300px;
        max-width: 400px;
      }

      .card-word {
        font-size: 32px;
      }

      .progress-stats-container {
        grid-template-columns: repeat(2, 1fr);
      }

      .control-group {
        grid-template-columns: 1fr;
      }

      .rating-buttons {
        grid-template-columns: repeat(2, 1fr);
      }

      .navigation-controls {
        flex-direction: column;
        gap: 15px;
      }

      .nav-btn {
        width: 100%;
        justify-content: center;
      }

      .center-controls {
        width: 100%;
        justify-content: center;
      }

      .summary-actions {
        flex-direction: column;
      }

      .summary-actions .btn {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .modern-flashcard {
        height: 280px;
        max-width: 100%;
      }

      .card-word {
        font-size: 28px;
      }

      .meaning-text {
        font-size: 16px;
      }

      .progress-stats-container {
        grid-template-columns: 1fr;
      }

      .rating-buttons {
        grid-template-columns: 1fr;
      }

      .flashcard-header h2 {
        font-size: 24px;
      }

      .flashcard-header p {
        font-size: 14px;
      }

      .control-label {
        font-size: 14px;
      }

      .modern-select {
        font-size: 14px;
        padding: 12px 14px;
      }
    }


























    /* ========== MODERN QUIZ TAB STYLES ========== */

    /* Quiz Hero Section */
    .quiz-hero {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 30px;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .quiz-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
      opacity: 0.3;
    }

    .quiz-hero-content {
      position: relative;
      z-index: 1;
    }

    .quiz-hero h1 {
      font-size: 32px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .quiz-subtitle {
      font-size: 16px;
      opacity: 0.9;
      margin-bottom: 30px;
      max-width: 500px;
    }

    .quiz-live-stats {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }

    .live-stat {
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(255, 255, 255, 0.15);
      padding: 18px 24px;
      border-radius: 16px;
      backdrop-filter: blur(10px);
      min-width: 180px;
    }

    .live-stat .stat-icon {
      font-size: 32px;
      opacity: 0.9;
    }

    .live-stat .stat-info {
      display: flex;
      flex-direction: column;
    }

    .live-stat .stat-value {
      font-size: 28px;
      font-weight: 800;
      line-height: 1;
    }

    .live-stat .stat-label {
      font-size: 14px;
      opacity: 0.8;
      margin-top: 4px;
    }

    /* Quiz Selection Grid */
    .quiz-selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin: 40px 0;
    }

    .quiz-card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      border: 1px solid var(--border);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .quiz-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border-color: transparent;
    }

    .quiz-card-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    .quiz-card-icon .material-icons-round {
      font-size: 32px;
      color: white;
    }

    .quiz-card-content h3 {
      font-size: 20px;
      color: var(--dark);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .quiz-card-content p {
      color: var(--gray);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 20px;
      min-height: 42px;
    }

    .quiz-card-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 20px;
    }

    .quiz-card-meta .material-icons-round {
      font-size: 18px;
    }

    .quiz-card-action {
      margin-top: auto;
      padding: 12px 24px;
      background: var(--light);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--dark);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      border: none;
      font-family: inherit;
    }

    .quiz-card:hover .quiz-card-action {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Quiz Settings */
    .quiz-settings {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin: 40px 0;
      border: 1px solid var(--border);
    }

    .settings-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 30px;
    }

    .settings-header h3 {
      font-size: 20px;
      color: var(--dark);
    }

    .settings-header .material-icons-round {
      color: var(--primary);
      font-size: 24px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
    }

    .setting-item {
      padding: 20px;
      background: var(--light);
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    .setting-label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-weight: 600;
      color: var(--dark);
      font-size: 15px;
    }

    .setting-label .material-icons-round {
      color: var(--primary);
      font-size: 20px;
    }

    .setting-control {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .setting-slider {
      flex: 1;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--border);
      border-radius: 4px;
      outline: none;
    }

    .setting-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: 4px solid white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .setting-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: 4px solid white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .setting-value {
      font-weight: 700;
      color: var(--primary);
      min-width: 40px;
      text-align: center;
    }

    .setting-select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .setting-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Progress Section */
    .quiz-progress-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin: 40px 0;
      border: 1px solid var(--border);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .section-header h3 {
      font-size: 20px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-text {
      background: none;
      border: none;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-text:hover {
      background: rgba(99, 102, 241, 0.1);
    }

    .progress-chart-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 30px;
    }

    .progress-stat {
      text-align: center;
    }

    .progress-circle {
      width: 120px;
      height: 120px;
      margin: 0 auto 15px;
      border-radius: 50%;
      background: conic-gradient(var(--light) 0% 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .progress-circle::before {
      content: '';
      position: absolute;
      width: 100px;
      height: 100px;
      background: white;
      border-radius: 50%;
    }

    .progress-value {
      position: relative;
      z-index: 1;
      font-size: 24px;
      font-weight: 800;
      color: var(--dark);
    }

    .progress-label {
      color: var(--gray);
      font-size: 14px;
      font-weight: 600;
    }

    .progress-bar-stat {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .bar-label {
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 8px;
      text-align: left;
    }

    .bar-container {
      height: 12px;
      background: var(--light);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 6px;
      transition: width 1s ease-in-out;
    }

    .bar-value {
      font-size: 20px;
      font-weight: 800;
      color: var(--primary);
      text-align: left;
    }

    /* Quiz History */
    .quiz-history-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin: 40px 0;
      border: 1px solid var(--border);
    }

    .history-cards {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      background: var(--light);
      border-radius: 16px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .history-item:hover {
      transform: translateX(5px);
      border-color: var(--primary);
    }

    .history-info {
      flex: 1;
    }

    .history-type {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .history-type .material-icons-round {
      color: var(--primary);
    }

    .history-title {
      font-weight: 600;
      color: var(--dark);
    }

    .history-date {
      font-size: 14px;
      color: var(--gray);
    }

    .history-score {
      text-align: right;
    }

    .score-value {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .score-percent {
      font-size: 14px;
      color: var(--gray);
    }

    .empty-history {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray);
    }

    .empty-history .material-icons-round {
      font-size: 64px;
      opacity: 0.3;
      margin-bottom: 20px;
    }

    .empty-history p {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .empty-history small {
      font-size: 14px;
      opacity: 0.7;
    }

    /* Daily Challenge Card */
    .daily-challenge-card {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: 20px;
      padding: 30px;
      margin: 40px 0;
      color: white;
    }

    .challenge-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 25px;
    }

    .challenge-icon {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .challenge-icon .material-icons-round {
      font-size: 32px;
      color: white;
    }

    .challenge-info h4 {
      font-size: 24px;
      margin-bottom: 4px;
      font-weight: 700;
    }

    .challenge-info p {
      opacity: 0.8;
      font-size: 14px;
    }

    .challenge-status .status-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge.complete {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .status-badge.incomplete {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .challenge-progress {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .progress-text {
      flex: 1;
    }

    .progress-text span {
      display: block;
      margin-bottom: 4px;
    }

    .progress-text span:first-child {
      font-size: 16px;
      font-weight: 500;
    }

    .progress-text span:last-child {
      font-size: 14px;
      opacity: 0.8;
    }

    /* Quiz Area Styling */
    .quiz-area-container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin: 40px 0;
      border: 1px solid var(--border);
    }

    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--light);
    }

    .quiz-timer {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }

    .timer-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--primary);
    }

    .question-container {
      margin-bottom: 30px;
    }

    .question-number {
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .question-text {
      font-size: 24px;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 30px;
      line-height: 1.4;
    }

    .options-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .option-button {
      padding: 18px 24px;
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      color: var(--dark);
      cursor: pointer;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s;
      border: none;
      font-family: inherit;
    }

    .option-button:hover:not(:disabled) {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
      transform: translateY(-2px);
    }

    .option-button.correct {
      background: #d1fae5;
      border-color: #10b981;
      color: #065f46;
    }

    .option-button.incorrect {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }

    .option-button:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }

    .option-letter {
      width: 36px;
      height: 36px;
      min-width: 36px;
      background: var(--light);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--dark);
      font-size: 14px;
    }

    .quiz-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 2px solid var(--light);
    }

    .progress-container {
      flex: 1;
    }

    .progress-bar {
      height: 8px;
      background: var(--light);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 14px;
      color: var(--gray);
    }

    /* Results Area */
    .results-area-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      margin: 40px 0;
      border: 1px solid var(--border);
      text-align: center;
    }

    .results-header {
      margin-bottom: 40px;
    }

    .results-icon {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 25px;
    }

    .results-icon .material-icons-round {
      font-size: 48px;
      color: white;
    }

    .results-title {
      font-size: 32px;
      font-weight: 800;
      color: var(--dark);
      margin-bottom: 12px;
    }

    .results-subtitle {
      color: var(--gray);
      font-size: 16px;
    }

    .results-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin: 40px 0;
    }

    .result-stat {
      padding: 25px;
      background: var(--light);
      border-radius: 16px;
    }

    .result-value {
      font-size: 36px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .result-label {
      color: var(--gray);
      font-size: 14px;
      font-weight: 600;
    }

    .results-breakdown {
      margin: 40px 0;
      text-align: left;
    }

    .breakdown-title {
      font-size: 20px;
      color: var(--dark);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .breakdown-item {
      padding: 15px;
      border-bottom: 1px solid var(--light);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .breakdown-item:last-child {
      border-bottom: none;
    }

    .question-status {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    .question-status.correct {
      background: #d1fae5;
      color: #10b981;
    }

    .question-status.incorrect {
      background: #fee2e2;
      color: #ef4444;
    }

    .results-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 40px;
    }

    /* Category Quiz Modal */
    .category-quiz-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
    }

    .category-quiz-option {
      padding: 20px;
      border: 2px solid var(--border);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      background: white;
    }

    .category-quiz-option:hover {
      border-color: var(--primary);
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .category-quiz-option .material-icons-round {
      font-size: 32px;
      margin-bottom: 10px;
      color: var(--primary);
    }

    .category-quiz-option h4 {
      font-size: 16px;
      color: var(--dark);
      margin-bottom: 8px;
    }

    .category-quiz-option small {
      color: var(--gray);
      font-size: 12px;
    }

    /* Feedback message */
    .feedback {
      animation: slideDown 0.3s ease;
      margin: 20px 0;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .quiz-hero {
        padding: 30px 20px;
      }

      .quiz-hero h1 {
        font-size: 24px;
      }

      .live-stat {
        min-width: 100%;
        flex: 1;
      }

      .quiz-selection-grid {
        grid-template-columns: 1fr;
      }

      .settings-grid {
        grid-template-columns: 1fr;
      }

      .progress-chart-container {
        grid-template-columns: 1fr;
        gap: 30px;
      }

      .challenge-progress {
        flex-direction: column;
        align-items: stretch;
      }

      .results-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .results-actions {
        flex-direction: column;
      }

      .quiz-header {
        flex-direction: column;
        gap: 20px;
        align-items: flex-start;
      }

      .quiz-footer {
        flex-direction: column;
        gap: 20px;
      }
    }

    @media (max-width: 480px) {
      .quiz-card {
        padding: 20px;
      }

      .results-stats {
        grid-template-columns: 1fr;
      }

      .category-quiz-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Cancel Quiz Modal Styles */
    .cancel-quiz-content {
      text-align: center;
      padding: 20px 0;
    }

    .cancel-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      color: #d97706;
      font-size: 40px;
      box-shadow: 0 10px 20px rgba(245, 158, 11, 0.15);
    }

    .cancel-title {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 12px;
    }

    .cancel-message {
      font-size: 16px;
      color: #6b7280;
      line-height: 1.6;
      margin-bottom: 25px;
      max-width: 350px;
      margin-left: auto;
      margin-right: auto;
    }

    .quiz-progress-info {
      background: #fffbeb;
      border: 2px solid #fef3c7;
      border-radius: 16px;
      padding: 20px;
      margin: 25px 0;
      text-align: left;
    }

    .progress-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      color: #92400e;
      font-size: 15px;
    }

    .progress-item:not(:last-child) {
      border-bottom: 1px solid #fde68a;
    }

    .progress-item .material-icons-round {
      font-size: 20px;
      color: #d97706;
    }

    .progress-item strong {
      font-weight: 700;
      color: #92400e;
    }

    .cancel-warning {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 20px;
      background: #fef3c7;
      border-radius: 12px;
      color: #92400e;
      font-weight: 600;
      font-size: 14px;
      margin-top: 20px;
    }

    .cancel-warning .material-icons-round {
      font-size: 20px;
    }

    /* Button animations for cancel modal */
    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .btn-warning:hover {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(245, 158, 11, 0.2);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
    }

    /* Modal header specific styles */
    .modal-header[style*="background: linear-gradient"] {
      position: relative;
      overflow: hidden;
    }

    .modal-header[style*="background: linear-gradient"]::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }


























    /* Update app-tabs for more tabs */
    @media (max-width: 768px) {
      .app-tabs {
        overflow-x: auto;
        padding: 0;
      }

      .app-tab {
        flex: 0 0 auto;
        min-width: 140px;
        padding: 20px 16px;
      }
    }





    .meaning-text strong {
      color: var(--dark);
      font-weight: 700;
    }

    .synonyms {
      color: var(--secondary);
      font-weight: 600;
      margin: 15px 0;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
    }

    .synonyms .material-icons-round {
      font-size: 22px;
    }

    .example {
      background: var(--light);
      padding: 18px;
      border-radius: 12px;
      margin-top: 20px;
      color: var(--dark);
      border-left: 4px solid var(--border);
      line-height: 1.7;
      font-size: 15px;
    }

    .example strong {
      color: var(--dark);
      font-weight: 700;
    }

    /* SYNC TAB */
    .sync-container {
      max-width: 700px;
      margin: 0 auto;
    }

    .sync-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 20px;
      margin: 35px 0;
    }

    .stat-card {
      background: white;
      padding: 28px 24px;
      border-radius: 16px;
      text-align: center;
      border: 1px solid var(--border);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
    }

    .stat-number {
      font-size: 42px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 8px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .stat-label {
      font-size: 15px;
      color: var(--gray);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* MESSAGES */
    .message {
      padding: 18px 22px;
      border-radius: 12px;
      margin: 20px 0;
      font-weight: 600;
      text-align: center;
      animation: slideDownMessage 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    @keyframes slideDownMessage {
      from {
        opacity: 0;
        transform: translateY(-15px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .message-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .message-warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }

    .message-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 70px 20px;
      color: var(--gray);
    }

    .empty-icon {
      font-size: 72px;
      margin-bottom: 24px;
      opacity: 0.5;
      color: var(--primary);
    }

    .empty-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--dark);
    }

    .empty-message {
      font-size: 17px;
      max-width: 400px;
      margin: 0 auto;
      line-height: 1.7;
      color: var(--gray);
    }

    /* MODALS - ENHANCED STYLES */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      padding: 20px;
      backdrop-filter: blur(5px);
    }

    .modal-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .modal {
      background: white;
      border-radius: 24px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      padding: 28px 32px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 24px 24px 0 0;
    }

    .modal-header h3 {
      font-size: 24px;
      color: var(--dark);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-close {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: none;
      background: white;
      color: var(--gray);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .modal-close:hover {
      background: #f3f4f6;
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 32px;
    }

    .modal-footer {
      padding: 24px 32px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 16px;
      background: #fafafa;
      border-radius: 0 0 24px 24px;
    }

    /* DELETE MODAL SPECIFIC STYLES */
    .delete-modal-content {
      text-align: center;
      padding: 20px 0;
    }

    .delete-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 25px;
      color: #dc2626;
      font-size: 40px;
      box-shadow: 0 10px 20px rgba(220, 38, 38, 0.1);
    }

    .delete-title {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 15px;
    }

    .delete-message {
      font-size: 16px;
      color: #6b7280;
      line-height: 1.6;
      margin-bottom: 25px;
    }

    .word-to-delete {
      background: #fef3c7;
      padding: 12px 20px;
      border-radius: 12px;
      margin: 20px 0;
      border: 2px solid #fbbf24;
      font-size: 18px;
      font-weight: 600;
      color: #92400e;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .warning-box {
      background: #fef3c7;
      border: 2px solid #fbbf24;
      border-radius: 12px;
      padding: 20px;
      margin: 25px 0;
      text-align: left;
    }

    .warning-box h4 {
      color: #92400e;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .warning-box ul {
      padding-left: 20px;
      color: #92400e;
    }

    .warning-box li {
      margin: 8px 0;
    }

    /* EDIT MODAL SPECIFIC STYLES */
    .edit-modal-content {
      text-align: center;
      padding-bottom: 20px;
    }

    .edit-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 25px;
      color: #1e40af;
      font-size: 40px;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.1);
    }

    /* CATEGORY MODAL STYLES */
    .category-modal-content {
      max-height: 500px;
      overflow-y: auto;
    }

    .category-tag {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      background: white;
      border: 2px solid var(--border);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin: 8px;
      min-width: 150px;
      justify-content: space-between;
    }

    .category-tag:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .category-tag .material-icons-round {
      font-size: 16px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .category-tag:hover .material-icons-round {
      opacity: 1;
    }

    .category-tag.locked {
      background: #f3f4f6;
      cursor: not-allowed;
    }

    .category-tag.locked .material-icons-round {
      color: #9ca3af;
    }

    .category-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .category-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
    }

    .category-input-group input {
      flex: 1;
      padding: 14px 18px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
    }

    .category-input-group input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .success-box {
      background: #d1fae5;
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }

    .success-box h4 {
      color: #065f46;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* RESPONSIVE */
    @media (max-width: 992px) {
      .filter-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group {
        width: 100%;
      }

      .search-container {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .app-container {
        border-radius: 20px;
      }

      .app-header {
        padding: 28px 24px;
      }

      .app-header h1 {
        font-size: 30px;
      }

      .app-tabs {
        flex-direction: row;
        overflow-x: auto;
        padding: 0;
        -webkit-overflow-scrolling: touch;
        gap: 0;
      }

      .app-tab {
        padding: 20px 16px;
        flex: 0 0 auto;
        min-width: 140px;
      }

      .tab-content {
        padding: 28px 24px;
      }

      .buttons-row {
        flex-direction: column;
        gap: 12px;
      }

















      .btn {
        width: 100%;
        min-width: auto;
      }

      .sync-stats {
        grid-template-columns: 1fr;
      }

      .word-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .word-actions {
        align-self: flex-end;
      }

      .modal {
        max-height: 85vh;
      }

      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 20px;
      }
    }

    @media (max-width: 480px) {
      .app-header h1 {
        font-size: 26px;
        flex-direction: column;
        gap: 8px;
      }

      .word-title {
        font-size: 22px;
      }

      .word-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .meaning-row {
        flex-direction: column;
        gap: 10px;
      }

      .meaning-icon {
        align-self: flex-start;
      }

      .category-tag {
        min-width: 100%;
        margin: 5px 0;
      }
    }
  </style>
</head>

<body>
  <!-- Enhanced Delete Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <div class="modal-header">
        <h3>
          <span class="material-icons-round" style="color: #dc2626;">delete</span>
          Delete Word
        </h3>
        <button class="modal-close" onclick="closeDeleteModal()">
          <span class="material-icons-round">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="delete-modal-content">
          <div class="delete-icon">
            <span class="material-icons-round">warning</span>
          </div>

          <div class="delete-title">Confirm Deletion</div>

          <div class="delete-message">
            Are you sure you want to permanently delete this word?
          </div>

          <div class="word-to-delete">
            <span class="material-icons-round">text_fields</span>
            <span id="deleteWordName">Loading...</span>
          </div>

          <div class="warning-box">
            <h4>
              <span class="material-icons-round">info</span>
              Important Information
            </h4>
            <ul>
              <li>This action cannot be undone</li>
              <li>The word will be deleted from all devices after sync</li>
              <li>Any edits made to this word will be lost</li>
              <li>This word will be removed from all categories</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">
          <span class="material-icons-round">arrow_back</span>
          Cancel
        </button>
        <button class="btn btn-danger" onclick="confirmDeleteWord()" id="confirmDeleteBtn">
          <span class="material-icons-round">delete_forever</span>
          Delete Permanently
        </button>
      </div>
    </div>
  </div>

  <!-- Enhanced Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-header">
        <h3>
          <span class="material-icons-round" style="color: #1e40af;">edit</span>
          Edit Word
        </h3>
        <button class="modal-close" onclick="closeEditModal()">
          <span class="material-icons-round">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="edit-modal-content">
          <div class="edit-icon">
            <span class="material-icons-round">auto_stories</span>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="material-icons-round">text_fields</span>
              Word
            </label>
            <input type="text" id="editWord" class="form-input" placeholder="Enter the word">
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="material-icons-round">category</span>
              Category
            </label>
            <!-- Enhanced Category Dropdown for Edit Modal -->
            <div class="custom-dropdown" id="editCategoryDropdown">
              <div class="dropdown-header" onclick="toggleEditCategoryDropdown()" tabindex="0"
                onkeypress="handleEditCategoryDropdownKeyPress(event)">
                <div class="selected-option">
                  <div class="selected-color" id="editSelectedColor" style="background: #6366f1;"></div>
                  <div class="selected-text" id="editSelectedText">General Vocabulary</div>
                </div>
                <span class="dropdown-arrow material-icons-round">expand_more</span>
              </div>

              <div class="dropdown-options" id="editDropdownOptions">
                <!-- Options will be loaded dynamically -->
              </div>
            </div>

            <!-- Hidden input to store selected value -->
            <input type="hidden" id="editCategory" name="editCategory" value="General Vocabulary">
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="material-icons-round">translate</span>
              Meaning (Bangla)
            </label>
            <textarea id="editBangla" class="form-textarea" placeholder="Enter meaning in Bangla"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="material-icons-round">translate</span>
              Meaning (English)
            </label>
            <textarea id="editEnglish" class="form-textarea" placeholder="Enter meaning in English"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="material-icons-round">swap_horiz</span>
              Synonyms
            </label>
            <input type="text" id="editSynonyms" class="form-input" placeholder="happy, joyful, cheerful">
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="material-icons-round">chat_bubble</span>
              Example Sentence
            </label>
            <textarea id="editExample" class="form-textarea" placeholder="Enter an example sentence"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditModal()">
          <span class="material-icons-round">close</span>
          Cancel
        </button>
        <button class="btn btn-primary" onclick="saveEditedWord()" id="saveEditBtn">
          <span class="material-icons-round">save</span>
          Save Changes
        </button>
      </div>
    </div>
  </div>

  <!-- Enhanced Category Management Modal -->
  <div class="modal-overlay" id="categoryModal">
    <div class="modal">
      <div class="modal-header">
        <h3>
          <span class="material-icons-round" style="color: #8b5cf6;">category</span>
          Manage Categories
        </h3>
        <button class="modal-close" onclick="closeCategoryModal()">
          <span class="material-icons-round">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="category-modal-content">
          <!-- Add New Category -->
          <div class="form-group">
            <label class="form-label">
              <span class="material-icons-round">add_circle</span>
              Add New Category
            </label>
            <div class="category-input-group">
              <input type="text" id="newCategoryName" class="form-input" placeholder="Enter category name">
              <button class="btn btn-primary btn-small" onclick="addCustomCategory()" id="addCategoryBtn">
                <span class="material-icons-round">add</span>
                Add
              </button>
            </div>
          </div>

          <!-- Existing Categories -->
          <div style="margin-top: 30px;">
            <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
              <span class="material-icons-round">folder_open</span>
              Existing Categories
            </h4>
            <div id="categoriesList" class="categories-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
              <!-- Categories loaded dynamically -->
            </div>
          </div>

          <!-- Info Box -->
          <div class="success-box" style="margin-top: 30px;">
            <h4>
              <span class="material-icons-round">info</span>
              Category Management Tips
            </h4>
            <p style="color: #065f46; line-height: 1.6;">
              • <strong>Default categories</strong> (with lock icon) cannot be deleted<br>
              • Deleting a category moves all words to "General Vocabulary"<br>
              • Category colors are automatically assigned<br>
              • You can have unlimited custom categories
            </p>
          </div>

          <!-- Category Color Picker -->
          <div style="margin-top: 30px;">
            <h4 style="margin-bottom: 15px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
              <span class="material-icons-round">palette</span>
              Category Colors
            </h4>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
              <div
                style="width: 40px; height: 40px; border-radius: 10px; background: #6366f1; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"
                onclick="selectCategoryColor('#6366f1')"></div>
              <div
                style="width: 40px; height: 40px; border-radius: 10px; background: #8b5cf6; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"
                onclick="selectCategoryColor('#8b5cf6')"></div>
              <div
                style="width: 40px; height: 40px; border-radius: 10px; background: #10b981; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"
                onclick="selectCategoryColor('#10b981')"></div>
              <div
                style="width: 40px; height: 40px; border-radius: 10px; background: #f59e0b; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"
                onclick="selectCategoryColor('#f59e0b')"></div>
              <div
                style="width: 40px; height: 40px; border-radius: 10px; background: #ef4444; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"
                onclick="selectCategoryColor('#ef4444')"></div>
              <div
                style="width: 40px; height: 40px; border-radius: 10px; background: #3b82f6; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"
                onclick="selectCategoryColor('#3b82f6')"></div>
            </div>
            <div style="margin-top: 15px; font-size: 14px; color: #6b7280;">
              Click a color to use it for new categories
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCategoryModal()">
          <span class="material-icons-round">done</span>
          Done
        </button>
      </div>
    </div>
  </div>

  <!-- Import History Modal -->
  <div class="modal-overlay" id="importHistoryModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3>
          <span class="material-icons-round" style="color: #6366f1;">history</span>
          Import History
        </h3>
        <button class="modal-close" onclick="closeImportHistoryModal()">
          <span class="material-icons-round">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="importHistoryContent">
          <div style="text-align: center; padding: 40px;">
            <div class="material-icons-round" style="font-size: 48px; color: var(--gray); opacity: 0.5;">history</div>
            <div style="margin-top: 15px; color: var(--gray);">Loading import history...</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeImportHistoryModal()">
          <span class="material-icons-round">close</span>
          Close
        </button>
        <button class="btn btn-primary" onclick="refreshImportHistory()">
          <span class="material-icons-round">refresh</span>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="app-container">
    <!-- HEADER -->
    <div class="app-header">
      <h1>
        <span class="material-icons-round" style="font-size: 42px;">auto_stories</span>
        My Daily Vocabulary
      </h1>
      <p id="connectionInfo">Master vocabulary across all devices • Smart sync • Modern interface</p>
    </div>

    <!-- CONNECTION STATUS -->
    <div class="connection-status status-offline" id="connectionStatus">
      <span class="material-icons-round">wifi_off</span>
      <span id="statusText">Checking connection...</span>
    </div>















    <!-- In the app-tabs div, add this tab: -->
    <div class="app-tabs">
      <!-- Existing tabs... -->
      <div class="app-tab active" onclick="switchTab('add')">
        <span class="material-icons-round">add_circle</span>
        Add Word
      </div>
      <div class="app-tab" onclick="switchTab('view')">
        <span class="material-icons-round">library_books</span>
        View All
      </div>
      <div class="app-tab" onclick="switchTab('flashcards')">
        <span class="material-icons-round">style</span>
        Flashcards
      </div>
      <div class="app-tab" onclick="switchTab('quiz')">
        <span class="material-icons-round">quiz</span>
        Daily Quiz
      </div>
      <div class="app-tab" onclick="switchTab('sync')">
        <span class="material-icons-round">sync</span>
        Sync & Settings
      </div>
    </div>











    <!-- MESSAGE AREA -->
    <div id="messageArea"></div>

    <!-- ADD WORD TAB -->
    <div id="add-tab" class="tab-content active">
      <div class="form-container">
        <div class="form-group">
          <label class="form-label">
            <span class="material-icons-round">text_fields</span>
            Word *
          </label>
          <input type="text" id="word" class="form-input" placeholder="Enter the word"
            oninput="checkWordExists(this.value)" onblur="capitalizeWord(this)">
          <div class="word-exists-alert" id="wordExistsAlert">
            <span class="material-icons-round">info</span>
            <span>This word already exists in your vocabulary</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <span class="material-icons-round">category</span>
            Category
          </label>

          <!-- Enhanced Category Dropdown -->
          <div class="custom-dropdown" id="categoryDropdown">
            <div class="dropdown-header" onclick="toggleCategoryDropdown()" tabindex="0"
              onkeypress="handleCategoryDropdownKeyPress(event)">
              <div class="selected-option">
                <div class="selected-color" id="selectedColor" style="background: #6366f1;"></div>
                <div class="selected-text" id="selectedText">General Vocabulary</div>
              </div>
              <span class="dropdown-arrow material-icons-round">expand_more</span>
            </div>

            <div class="dropdown-options" id="dropdownOptions">
              <!-- Options will be loaded dynamically -->
            </div>
          </div>

          <!-- Hidden input to store selected value -->
          <input type="hidden" id="category" name="category" value="General Vocabulary">

          <div style="margin-top: 10px;">
            <button class="btn btn-secondary btn-small" onclick="openCategoryModal()">
              <span class="material-icons-round">settings</span>
              Manage Categories
            </button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <span class="material-icons-round">translate</span>
            Meaning (Bangla)
          </label>
          <textarea id="bangla" class="form-textarea" placeholder="Enter meaning in Bangla"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">
            <span class="material-icons-round">translate</span>
            Meaning (English)
          </label>
          <textarea id="english" class="form-textarea" placeholder="Enter meaning in English"
            onblur="capitalizeFirstWord(this)"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">
            <span class="material-icons-round">swap_horiz</span>
            Synonyms (comma separated)
          </label>
          <input type="text" id="synonyms" class="form-input" placeholder="happy, joyful, cheerful"
            onblur="capitalizeSynonyms(this)">
        </div>

        <div class="form-group">
          <label class="form-label">
            <span class="material-icons-round">chat_bubble</span>
            Example Sentence
          </label>
          <textarea id="example" class="form-textarea" placeholder="Enter an example sentence"
            onblur="sentenceCase(this)"></textarea>
        </div>

        <div class="buttons-row">
          <button class="btn btn-primary" onclick="saveWord()" id="saveBtn">
            <span class="material-icons-round" id="saveIcon">save</span>
            <span id="saveText">Save Word</span>
          </button>
          <button class="btn btn-secondary" onclick="clearForm()">
            <span class="material-icons-round">delete_sweep</span>
            Clear Form
          </button>
        </div>
      </div>
    </div>

    <!-- VIEW WORDS TAB -->
    <div id="view-tab" class="tab-content">
      <div class="filter-bar">
        <div class="search-container">
          <span class="search-icon material-icons-round">search</span>
          <input type="text" id="searchInput" class="search-input" placeholder="Search words, meanings, synonyms..."
            onkeyup="searchWords()">
        </div>

        <div class="filter-group">
          <div class="filter-label">
            <span class="material-icons-round">sort</span>
            Sort by:
          </div>
          <select id="sortSelect" class="filter-select" onchange="sortWords()">
            <option value="date-desc">Newest First</option>
            <option value="date-asc">Oldest First</option>
            <option value="a-z">A to Z</option>
            <option value="z-a">Z to A</option>
            <option value="category">Category</option>
          </select>
        </div>

        <div class="filter-group">
          <div class="filter-label">
            <span class="material-icons-round">filter_alt</span>
            Filter by:
          </div>
          <select id="filterSelect" class="filter-select" onchange="filterWords()">
            <option value="all">All Words</option>
            <option value="my">My Words</option>
            <option value="others">Other Devices</option>
            <!-- Categories loaded dynamically -->
          </select>
        </div>
      </div>

      <div class="words-container" id="wordsList">
        <!-- Words loaded here -->
      </div>

      <div class="buttons-row">
        <button class="btn btn-primary" onclick="exportData()">
          <span class="material-icons-round">download</span>
          Export Data
        </button>
        <button class="btn btn-success" onclick="refreshData()" id="refreshBtn">
          <span class="material-icons-round" id="refreshIcon">refresh</span>
          <span id="refreshText">Refresh</span>
        </button>
        <button class="btn btn-info" onclick="exportServerExcel()">
          <span class="material-icons-round">table_chart</span>
          Server Excel
        </button>
      </div>
    </div>








    <!-- FLASHCARD TAB - MODERN UI -->
    <div id="flashcards-tab" class="tab-content">
      <div class="modern-flashcard-container">
        <!-- Flashcard Header -->
        <div class="flashcard-header">
          <h2><span class="material-icons-round">style</span> Interactive Flashcards</h2>
          <p>Practice vocabulary with smart spaced repetition</p>
        </div>

        <!-- Flashcard Controls -->
        <div class="flashcard-control-panel">
          <div class="control-group">
            <div class="control-item">
              <label class="control-label">
                <span class="material-icons-round">category</span>
                Category
              </label>
              <select id="flashcardCategory" class="modern-select" onchange="loadFlashcards()">
                <option value="all">All Categories</option>
                <!-- Categories will be loaded here -->
              </select>
            </div>

            <div class="control-item">
              <label class="control-label">
                <span class="material-icons-round">filter_alt</span>
                Filter
              </label>
              <select id="flashcardFilter" class="modern-select" onchange="loadFlashcards()">
                <option value="all">All Words</option>
                <option value="unseen">Unseen First</option>
                <option value="difficult">Difficult Words</option>
                <option value="needs_review">Needs Review</option>
                <option value="mastered">Mastered</option>
              </select>
            </div>

            <div class="control-item">
              <label class="control-label">
                <span class="material-icons-round">sort</span>
                Sort
              </label>
              <select id="flashcardSort" class="modern-select" onchange="loadFlashcards()">
                <option value="random">Random</option>
                <option value="difficulty">By Difficulty</option>
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="alphabetical">A to Z</option>
              </select>
            </div>
          </div>

          <div class="action-buttons">
            <button class="action-btn shuffle-btn" onclick="shuffleFlashcards()">
              <span class="material-icons-round">shuffle</span>
              Shuffle
            </button>
            <button class="action-btn reset-btn" onclick="showResetConfirmation()">
              <span class="material-icons-round">restart_alt</span>
              Reset Progress
            </button>
          </div>
        </div>

        <!-- Progress Stats -->
        <div class="progress-stats-container">
          <div class="progress-card">
            <div class="progress-icon" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
              <span class="material-icons-round">auto_stories</span>
            </div>
            <div class="progress-info">
              <div class="progress-number" id="totalCardsCount">0</div>
              <div class="progress-label">Total Cards</div>
            </div>
          </div>

          <div class="progress-card">
            <div class="progress-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
              <span class="material-icons-round">check_circle</span>
            </div>
            <div class="progress-info">
              <div class="progress-number" id="masteredCount">0</div>
              <div class="progress-label">Mastered</div>
            </div>
          </div>

          <div class="progress-card">
            <div class="progress-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
              <span class="material-icons-round">pending</span>
            </div>
            <div class="progress-info">
              <div class="progress-number" id="reviewCount">0</div>
              <div class="progress-label">To Review</div>
            </div>
          </div>

          <div class="progress-card">
            <div class="progress-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
              <span class="material-icons-round">priority_high</span>
            </div>
            <div class="progress-info">
              <div class="progress-number" id="difficultCount">0</div>
              <div class="progress-label">Difficult</div>
            </div>
          </div>
        </div>

        <!-- Flashcard Area -->
        <div class="flashcard-main-area">
          <!-- Empty State -->
          <div class="empty-flashcard-state" id="flashcardEmptyState">
            <div class="empty-icon">
              <span class="material-icons-round">style</span>
            </div>
            <h3>No Flashcards Available</h3>
            <p>Select a category or add more words to start practicing!</p>
            <button class="btn btn-primary" onclick="switchTab('add')">
              <span class="material-icons-round">add_circle</span>
              Add Words
            </button>
          </div>

          <!-- Flashcard Display -->
          <div class="flashcard-display-container" id="flashcardDisplay" style="display: none;">
            <!-- Progress Indicator -->
            <div class="session-progress">
              <div class="progress-bar">
                <div class="progress-fill" id="sessionProgressBar"></div>
              </div>
              <div class="progress-text">
                Card <span id="currentCardNum">1</span> of <span id="totalSessionCards">0</span>
                • <span id="sessionScore">0</span> points
              </div>
            </div>

            <!-- Flashcard -->
            <div class="modern-flashcard" id="flashcard" onclick="flipCard()">
              <div class="card-inner">
                <!-- Front Side -->
                <div class="card-front">
                  <div class="card-header">
                    <span class="card-badge" id="cardDifficulty">New</span>
                    <button class="card-action-btn" onclick="event.stopPropagation(); toggleFavorite()"
                      id="favoriteBtn">
                      <span class="material-icons-round">favorite_border</span>
                    </button>
                  </div>

                  <div class="card-content">
                    <div class="card-word" id="flashcardWord">Loading...</div>
                    <div class="card-hint">
                      <span class="material-icons-round">touch_app</span>
                      Tap card to reveal meaning
                    </div>
                  </div>

                  <div class="card-footer">
                    <div class="pronounce-btn" onclick="event.stopPropagation(); pronounceCurrentWord()">
                      <span class="material-icons-round">volume_up</span>
                      Pronounce
                    </div>
                  </div>
                </div>

                <!-- Back Side -->
                <div class="card-back">
                  <div class="card-header">
                    <span class="card-badge success">Revealed</span>
                    <button class="card-action-btn" onclick="event.stopPropagation(); showHint()" id="hintBtn">
                      <span class="material-icons-round">lightbulb</span>
                    </button>
                  </div>

                  <div class="card-content">
                    <div class="meaning-section">
                      <div class="section-title">
                        <span class="material-icons-round">translate</span>
                        Meaning
                      </div>
                      <div class="meaning-text" id="flashcardMeaning"></div>
                    </div>

                    <div class="synonyms-section" id="synonymsSection" style="display: none;">
                      <div class="section-title">
                        <span class="material-icons-round">swap_horiz</span>
                        Synonyms
                      </div>
                      <div class="synonyms-text" id="flashcardSynonyms"></div>
                    </div>

                    <div class="example-section" id="exampleSection" style="display: none;">
                      <div class="section-title">
                        <span class="material-icons-round">chat_bubble</span>
                        Example
                      </div>
                      <div class="example-text" id="flashcardExample"></div>
                    </div>
                  </div>

                  <div class="card-footer">
                    <div class="hint-text" id="cardHint">
                      Rate your understanding to continue
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Difficulty Rating -->
            <div class="difficulty-rating" id="difficultyRating">
              <div class="rating-title">How well did you know this?</div>
              <div class="rating-buttons">
                <button class="rating-btn difficult" onclick="rateCard('difficult')">
                  <span class="material-icons-round">close</span>
                  <span>Difficult</span>
                </button>
                <button class="rating-btn unsure" onclick="rateCard('unsure')">
                  <span class="material-icons-round">help</span>
                  <span>Unsure</span>
                </button>
                <button class="rating-btn good" onclick="rateCard('good')">
                  <span class="material-icons-round">thumb_up</span>
                  <span>Good</span>
                </button>
                <button class="rating-btn easy" onclick="rateCard('easy')">
                  <span class="material-icons-round">stars</span>
                  <span>Easy</span>
                </button>
              </div>
            </div>

            <!-- Navigation Controls -->
            <div class="navigation-controls">
              <button class="nav-btn prev-btn" onclick="previousCard()" id="prevBtn">
                <span class="material-icons-round">chevron_left</span>
                Previous
              </button>

              <div class="center-controls">
                <button class="control-btn flip-btn" onclick="flipCard()">
                  <span class="material-icons-round">flip</span>
                  Flip Card
                </button>
                <button class="control-btn hint-btn" onclick="showHint(event)" id="showHintBtn">
                  <span class="material-icons-round">lightbulb</span>
                  <span>Show Hints</span>
                </button>
              </div>

              <button class="nav-btn next-btn" onclick="nextCard()" id="nextBtn">
                Next
                <span class="material-icons-round">chevron_right</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Session Summary -->
        <div class="session-summary" id="sessionSummary" style="display: none;">
          <div class="summary-header">
            <div class="summary-icon">
              <span class="material-icons-round">celebration</span>
            </div>
            <h3>Session Complete!</h3>
            <p>Great job practicing your vocabulary</p>
          </div>

          <div class="summary-stats">
            <div class="stat-item">
              <div class="stat-value" id="summaryTotal">0</div>
              <div class="stat-label">Cards Reviewed</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="summaryMastered">0</div>
              <div class="stat-label">Mastered</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="summaryScore">0</div>
              <div class="stat-label">Points Earned</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="summaryTime">0</div>
              <div class="stat-label">Minutes</div>
            </div>
          </div>

          <div class="summary-progress">
            <div class="progress-circle">
              <svg width="120" height="120" viewBox="0 0 120 120">
                <circle cx="60" cy="60" r="54" fill="none" stroke="#e5e7eb" stroke-width="12" />
                <circle cx="60" cy="60" r="54" fill="none" stroke="#6366f1" stroke-width="12" stroke-linecap="round"
                  stroke-dasharray="339.292" stroke-dashoffset="0" id="summaryProgressCircle" />
              </svg>
              <div class="circle-text">
                <span id="summaryPercentage">0%</span>
              </div>
            </div>
            <div class="progress-text">
              Overall Mastery Progress
            </div>
          </div>

          <div class="summary-actions">
            <button class="btn btn-secondary" onclick="reviewDifficultCards()" id="reviewBtn">
              <span class="material-icons-round">replay</span>
              Review Difficult
            </button>
            <button class="btn btn-primary" onclick="startNewSession()">
              <span class="material-icons-round">play_arrow</span>
              New Session
            </button>
            <button class="btn btn-success" onclick="continueSession()">
              <span class="material-icons-round">fast_forward</span>
              Continue
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modern Reset Confirmation Modal -->
    <div class="modal-overlay" id="resetModal">
      <div class="modal" style="max-width: 450px;">
        <div class="modal-header"
          style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e;">
          <h3>
            <span class="material-icons-round">restart_alt</span>
            Reset Progress
          </h3>
          <button class="modal-close" onclick="closeResetModal()">
            <span class="material-icons-round">close</span>
          </button>
        </div>

        <div class="modal-body">
          <div class="reset-modal-content">
            <div class="reset-icon">
              <div class="reset-icon-circle">
                <span class="material-icons-round">warning</span>
              </div>
            </div>

            <div class="reset-title">Reset All Flashcard Progress?</div>

            <div class="reset-message">
              This will clear all your flashcard statistics and learning progress.
            </div>

            <div class="reset-stats">
              <div class="reset-stat-item">
                <span class="material-icons-round">auto_stories</span>
                <div class="stat-info">
                  <div class="stat-label">Total Cards</div>
                  <div class="stat-value" id="resetTotalCards">0</div>
                </div>
              </div>

              <div class="reset-stat-item">
                <span class="material-icons-round">check_circle</span>
                <div class="stat-info">
                  <div class="stat-label">Mastered Cards</div>
                  <div class="stat-value" id="resetMasteredCards">0</div>
                </div>
              </div>

              <div class="reset-stat-item">
                <span class="material-icons-round">trending_up</span>
                <div class="stat-info">
                  <div class="stat-label">Review Points</div>
                  <div class="stat-value" id="resetTotalPoints">0</div>
                </div>
              </div>
            </div>

            <div class="reset-warning">
              <div class="warning-header">
                <span class="material-icons-round">info</span>
                <span>What will be reset:</span>
              </div>
              <ul class="warning-list">
                <li>All difficulty ratings (Difficult/Unsure/Good/Easy)</li>
                <li>Mastered status for all cards</li>
                <li>Review history and timestamps</li>
                <li>Practice statistics and points</li>
              </ul>
            </div>

            <div class="reset-actions">
              <button class="reset-cancel-btn" onclick="closeResetModal()">
                <span class="material-icons-round">arrow_back</span>
                Cancel
              </button>
              <button class="reset-confirm-btn" onclick="confirmResetProgress()">
                <span class="material-icons-round">delete_forever</span>
                Reset Everything
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>











    <!-- DAILY QUIZ TAB - COMPLETE WORKING VERSION -->
    <div id="quiz-tab" class="tab-content">
      <div class="quiz-container">
        <!-- Hero Section -->
        <div class="quiz-hero">
          <div class="quiz-hero-content">
            <h1>
              <span class="material-icons-round">quiz</span>
              Vocabulary Challenge
            </h1>
            <p class="quiz-subtitle">Test your knowledge, build your vocabulary, and track your progress</p>

            <!-- Live Stats -->
            <div class="quiz-live-stats">
              <div class="live-stat">
                <span class="stat-icon material-icons-round">local_fire_department</span>
                <div class="stat-info">
                  <span class="stat-value" id="streakCount">0</span>
                  <span class="stat-label">Day Streak</span>
                </div>
              </div>
              <div class="live-stat">
                <span class="stat-icon material-icons-round">emoji_events</span>
                <div class="stat-info">
                  <span class="stat-value" id="totalQuizzes">0</span>
                  <span class="stat-label">Quizzes Done</span>
                </div>
              </div>
              <div class="live-stat">
                <span class="stat-icon material-icons-round">trending_up</span>
                <div class="stat-info">
                  <span class="stat-value" id="averageScore">0%</span>
                  <span class="stat-label">Avg Score</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quiz Selection Cards -->
        <div class="quiz-selection-grid">
          <div class="quiz-card" onclick="startQuiz('all')">
            <div class="quiz-card-icon" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
              <span class="material-icons-round">all_inclusive</span>
            </div>
            <div class="quiz-card-content">
              <h3>All Words</h3>
              <p>Test all vocabulary from your collection</p>
              <div class="quiz-card-meta">
                <span class="material-icons-round">auto_stories</span>
                <span id="allWordsCount">0 words</span>
              </div>
            </div>
            <button class="quiz-card-action">Start Quiz</button>
          </div>

          <div class="quiz-card" onclick="startQuiz('difficult')">
            <div class="quiz-card-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
              <span class="material-icons-round">whatshot</span>
            </div>
            <div class="quiz-card-content">
              <h3>Difficult Words</h3>
              <p>Focus on words you find challenging</p>
              <div class="quiz-card-meta">
                <span class="material-icons-round">warning</span>
                <span id="difficultWordsCount">0 words</span>
              </div>
            </div>
            <button class="quiz-card-action">Practice</button>
          </div>

          <div class="quiz-card" onclick="startQuiz('random')">
            <div class="quiz-card-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
              <span class="material-icons-round">shuffle</span>
            </div>
            <div class="quiz-card-content">
              <h3>Random Mix</h3>
              <p>Random selection from all categories</p>
              <div class="quiz-card-meta">
                <span class="material-icons-round">shuffle</span>
                <span id="randomWordsCount">5-10 random</span>
              </div>
            </div>
            <button class="quiz-card-action">Quick Quiz</button>
          </div>

          <div class="quiz-card" onclick="openCategoryQuizModal()">
            <div class="quiz-card-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
              <span class="material-icons-round">category</span>
            </div>
            <div class="quiz-card-content">
              <h3>By Category</h3>
              <p>Select specific category to practice</p>
              <div class="quiz-card-meta">
                <span class="material-icons-round">folder_open</span>
                <span id="categoriesCount">0 categories</span>
              </div>
            </div>
            <button class="quiz-card-action">Choose Category</button>
          </div>
        </div>

        <!-- Quiz Settings Panel -->
        <div class="quiz-settings">
          <div class="settings-header">
            <span class="material-icons-round">settings</span>
            <h3>Quiz Settings</h3>
          </div>
          <div class="settings-grid">
            <div class="setting-item">
              <label class="setting-label">
                <span class="material-icons-round">format_list_numbered</span>
                Questions: <span id="questionCountValue">10</span>
              </label>
              <div class="setting-control">
                <input type="range" id="questionCount" min="5" max="20" value="10" class="setting-slider">
              </div>
            </div>
            <div class="setting-item">
              <label class="setting-label">
                <span class="material-icons-round">timer</span>
                Time per Question
              </label>
              <div class="setting-control">
                <select id="timePerQuestion" class="setting-select">
                  <option value="0">No Limit</option>
                  <option value="30">30 seconds</option>
                  <option value="60" selected>1 minute</option>
                  <option value="90">1.5 minutes</option>
                  <option value="120">2 minutes</option>
                </select>
              </div>
            </div>
            <div class="setting-item">
              <label class="setting-label">
                <span class="material-icons-round">school</span>
                Difficulty Level
              </label>
              <div class="setting-control">
                <select id="difficultyLevel" class="setting-select">
                  <option value="easy">Easy (Multiple Choice)</option>
                  <option value="medium" selected>Medium (Mixed)</option>
                  <option value="hard">Hard (Fill in Blanks)</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Quiz Progress & History -->
        <div class="quiz-progress-section">
          <div class="section-header">
            <h3>Your Progress</h3>
            <button class="btn btn-text" onclick="resetQuizStats()">
              <span class="material-icons-round">refresh</span>
              Reset Stats
            </button>
          </div>

          <div class="progress-chart-container">
            <div class="progress-stat">
              <div class="progress-circle" id="accuracyCircle">
                <span class="progress-value">0%</span>
              </div>
              <div class="progress-label">Accuracy</div>
            </div>

            <div class="progress-stat">
              <div class="progress-circle" id="completionCircle">
                <span class="progress-value">0%</span>
              </div>
              <div class="progress-label">Completion</div>
            </div>

            <div class="progress-stat">
              <div class="progress-bar-stat">
                <div class="bar-label">Best Score</div>
                <div class="bar-container">
                  <div class="bar-fill" id="bestScoreBar" style="width: 0%"></div>
                </div>
                <div class="bar-value" id="bestScoreValue">0%</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Quiz History -->
        <div class="quiz-history-section">
          <div class="section-header">
            <h3>Recent Quizzes</h3>
            <button class="btn btn-text" onclick="viewFullHistory()">
              <span class="material-icons-round">history</span>
              View All
            </button>
          </div>

          <div class="history-cards" id="quizHistory">
            <!-- History cards loaded dynamically -->
          </div>
        </div>

        <!-- Daily Challenge -->
        <div class="daily-challenge-card" id="dailyChallengeCard">
          <div class="challenge-header">
            <div class="challenge-icon">
              <span class="material-icons-round">emoji_events</span>
            </div>
            <div class="challenge-info">
              <h4>Daily Challenge</h4>
              <p id="quizDate">Loading date...</p>
            </div>
            <div class="challenge-status" id="dailyStatus">
              <span class="status-badge incomplete">
                <span class="material-icons-round">pending</span>
                Not Started
              </span>
            </div>
          </div>

          <div class="challenge-progress">
            <div class="progress-text">
              <span>Complete daily challenge to maintain streak!</span>
              <span id="streakInfo">Current streak: 0 days</span>
            </div>
            <button class="btn btn-primary" onclick="startDailyChallenge()">
              <span class="material-icons-round">play_arrow</span>
              Start Today's Challenge
            </button>
          </div>
        </div>
      </div>

      <!-- Quiz Area -->
      <div class="quiz-area-container" id="quizArea" style="display: none;">
        <!-- Quiz content loaded dynamically -->
      </div>

      <!-- Results Area -->
      <div class="results-area-container" id="quizResults" style="display: none;">
        <!-- Results loaded dynamically -->
      </div>
    </div>


    <!-- Category Quiz Modal -->
    <div class="modal-overlay" id="categoryQuizModal">
      <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
          <h3>
            <span class="material-icons-round">category</span>
            Select Category
          </h3>
          <button class="modal-close" onclick="closeCategoryQuizModal()">
            <span class="material-icons-round">close</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="category-quiz-grid" id="categoryQuizOptions">
            <!-- Categories loaded dynamically -->
          </div>
        </div>
      </div>
    </div>





    <!-- Enhanced Cancel Quiz Modal -->
    <div class="modal-overlay" id="cancelQuizModal">
      <div class="modal" style="max-width: 450px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
          <h3>
            <span class="material-icons-round">warning</span>
            Cancel Quiz
          </h3>
          <button class="modal-close" onclick="closeCancelModal()" style="color: rgb(19, 13, 13);">
            <span class="material-icons-round">close</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="cancel-quiz-content">
            <div class="cancel-icon">
              <span class="material-icons-round">pause_circle</span>
            </div>

            <div class="cancel-title">Are you sure?</div>

            <div class="cancel-message">
              Your quiz progress will be lost if you cancel now.
            </div>

            <div class="quiz-progress-info">
              <div class="progress-item">
                <span class="material-icons-round">check_circle</span>
                <span>Questions completed: <strong id="completedQuestions">0</strong></span>
              </div>
              <div class="progress-item">
                <span class="material-icons-round">star</span>
                <span>Current score: <strong id="currentScore">0</strong> points</span>
              </div>
              <div class="progress-item">
                <span class="material-icons-round">timer</span>
                <span>Time spent: <strong id="timeSpent">0</strong> min</span>
              </div>
            </div>

            <div class="cancel-warning">
              <span class="material-icons-round">info</span>
              <span>This action cannot be undone</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeCancelModal()">
            <span class="material-icons-round">arrow_back</span>
            Continue Quiz
          </button>
          <button class="btn btn-warning" onclick="confirmCancelQuiz()">
            <span class="material-icons-round">exit_to_app</span>
            Yes, Cancel Quiz
          </button>
        </div>
      </div>
    </div>













    <!-- SYNC TAB -->
    <div id="sync-tab" class="tab-content">
      <div class="sync-container">
        <h3 style="margin-bottom: 24px; color: var(--dark); display: flex; align-items: center; gap: 12px;">
          <span class="material-icons-round">sync</span>
          Multi-Device Sync
        </h3>

        <div class="sync-stats" id="statsContainer">
          <!-- Stats loaded here -->
        </div>

        <!-- EXCEL IMPORT SECTION - ADDED HERE -->
        <div
          style="margin: 35px 0; padding: 24px; background: var(--light); border-radius: 16px; border: 1px solid var(--border);">
          <h4 style="margin-bottom: 18px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
            <span class="material-icons-round">upload_file</span>
            Import from Excel
          </h4>

          <div style="margin-bottom: 20px;">
            <p style="line-height: 1.7; color: var(--gray); margin-bottom: 15px;">
              Import vocabulary words from Excel files. Your Excel file should have these columns:<br>
              <strong>Required:</strong> Word<br>
              <strong>Optional:</strong> Meaning Bangla, Meaning English, Synonyms, Example Sentence, Category
            </p>

            <div class="buttons-row" style="margin-top: 20px; justify-content: flex-start;">
              <button class="btn btn-success" onclick="downloadImportTemplate()">
                <span class="material-icons-round">download</span>
                Download Template
              </button>
            </div>
          </div>

          <div
            style="margin: 20px 0; padding: 20px; background: white; border-radius: 12px; border: 2px dashed var(--border);">
            <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;"
              onchange="handleFileSelect(event)">

            <div style="text-align: center; padding: 20px;">
              <div
                style="width: 80px; height: 80px; margin: 0 auto 15px; background: #dbeafe; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <span class="material-icons-round" style="font-size: 40px; color: #3b82f6;">upload_file</span>
              </div>
              <p style="color: var(--gray); margin-bottom: 15px;">Drag & drop Excel file here or click to browse</p>
              <button class="btn btn-primary" onclick="document.getElementById('excelFileInput').click()">
                <span class="material-icons-round">upload</span>
                Select Excel File
              </button>
              <div style="margin-top: 10px; font-size: 14px; color: var(--gray);">
                Supported formats: .xlsx, .xls
              </div>
            </div>

            <div id="fileInfo" style="margin-top: 15px; display: none;">
              <div style="padding: 15px; background: #f0fdf4; border-radius: 10px; border: 1px solid #10b981;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons-round" style="color: #10b981;">description</span>
                    <div>
                      <div style="font-weight: 600;" id="fileName">file.xlsx</div>
                      <div style="font-size: 14px; color: var(--gray);" id="fileSize">0 KB</div>
                    </div>
                  </div>
                  <button class="action-btn" onclick="clearSelectedFile()" title="Remove file">
                    <span class="material-icons-round">close</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="buttons-row" style="justify-content: flex-start;">
            <button class="btn btn-primary" onclick="importExcelFile()" id="importBtn" disabled>
              <span class="material-icons-round" id="importIcon">upload</span>
              <span id="importText">Import Excel File</span>
            </button>
            <button class="btn btn-secondary" onclick="openImportHistoryModal()">
              <span class="material-icons-round">history</span>
              View Import History
            </button>
          </div>

          <div id="importProgress" style="margin-top: 20px; display: none;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
              <span style="font-weight: 600; color: var(--dark);">Importing...</span>
              <span id="importPercent">0%</span>
            </div>
            <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
              <div id="importProgressBar"
                style="height: 100%; width: 0%; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); transition: width 0.3s;">
              </div>
            </div>
            <div id="importDetails" style="margin-top: 10px; font-size: 14px; color: var(--gray);"></div>
          </div>
        </div>

        <div
          style="margin: 35px 0; padding: 24px; background: var(--light); border-radius: 16px; border: 1px solid var(--border);">
          <h4 style="margin-bottom: 18px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
            <span class="material-icons-round">device_hub</span>
            Device & Server Info
          </h4>
          <p id="deviceInfo" style="line-height: 1.7; margin-bottom: 12px;">Loading device info...</p>
          <p id="serverInfo" style="line-height: 1.7; margin-bottom: 20px;">Checking server status...</p>

          <div id="syncInfo"
            style="padding: 20px; background: white; border-radius: 12px; border: 1px solid var(--border);">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
              <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 800; color: var(--primary);" id="myWordsCount">0</div>
                <div
                  style="font-size: 13px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; margin-top: 6px;">
                  <span class="material-icons-round" style="font-size: 16px;">person</span>
                  My Words
                </div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 800; color: var(--secondary);" id="otherWordsCount">0</div>
                <div
                  style="font-size: 13px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; margin-top: 6px;">
                  <span class="material-icons-round" style="font-size: 16px;">devices</span>
                  From Others
                </div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 800; color: var(--warning);" id="pendingSyncCount">0</div>
                <div
                  style="font-size: 13px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; margin-top: 6px;">
                  <span class="material-icons-round" style="font-size: 16px;">pending</span>
                  Pending Sync
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="buttons-row">
          <button class="btn btn-primary" onclick="syncAllData()" id="syncBtn">
            <span class="material-icons-round" id="syncIcon">sync</span>
            <span id="syncText">Sync All Now</span>
          </button>
          <button class="btn btn-success" onclick="downloadAllFromServer()" id="downloadBtn">
            <span class="material-icons-round" id="downloadIcon">cloud_download</span>
            <span id="downloadText">Get Others' Words</span>
          </button>
          <button class="btn btn-warning" onclick="backupData()" id="backupBtn">
            <span class="material-icons-round" id="backupIcon">backup</span>
            <span id="backupText">Create Backup</span>
          </button>
          <button class="btn btn-danger" onclick="clearAllData()" id="clearBtn">
            <span class="material-icons-round" id="clearIcon">delete_forever</span>
            <span id="clearText">Clear All Data</span>
          </button>
        </div>



















        <div
          style="margin-top: 35px; padding: 24px; background: var(--light); border-radius: 16px; border: 1px solid var(--border);">
          <h4 style="margin-bottom: 16px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
            <span class="material-icons-round">info</span>
            How Sync Works
          </h4>
          <p style="line-height: 1.7; color: var(--gray); margin-bottom: 15px;">
            <strong>1. Add words</strong> on any device - they save locally first<br>
            <strong>2. Click "Sync All Now"</strong> to upload your words and download others' words<br>
            <strong>3. Auto-sync</strong> happens every 2 minutes when online<br>
            <strong>4. All devices</strong> see ALL words from ALL devices<br>
            <strong>5. Deletions sync</strong> to all devices automatically<br>
            <strong>6. Excel Export</strong> Download complete data from server
          </p>
          <p style="color: var(--success); font-weight: 600; display: flex; align-items: center; gap: 8px;">
            <span class="material-icons-round">check_circle</span>
            Last sync: <span id="lastSyncTime">Never</span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIGURATION ==========
    const STORAGE_KEY = 'vocabulary_data_v4';
    const BACKUP_KEY = 'vocabulary_backup_v4';
    const CATEGORIES_KEY = 'vocabulary_categories_v4';

    // Server detection
    function getServerUrl() {
      const protocol = window.location.protocol;
      const hostname = window.location.hostname;
      const port = window.location.port || '8000';

      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return `${protocol}//localhost:${port}`;
      }

      return `${protocol}//${hostname}:${port}`;
    }

    const SERVER_URL = getServerUrl();
    const DEVICE_ID = localStorage.getItem('device_id') || 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const DEVICE_NAME = localStorage.getItem('device_name') || `Device-${DEVICE_ID.substr(0, 8)}`;

    // ========== STATE MANAGEMENT ==========
    let vocabularyApp = {
      words: [],
      categories: [],
      categoryColors: {},
      serverOnline: false,
      currentServerUrl: SERVER_URL,
      editingWordId: null,
      deletingWordId: null,
      selectedCategoryColor: '#6366f1'
    };

    // ========== ENHANCED CATEGORY DROPDOWN ==========
    let isDropdownOpen = false;
    let isEditDropdownOpen = false;

    // Main dropdown functions
    function toggleCategoryDropdown() {
      const dropdown = document.getElementById('categoryDropdown');
      const options = document.getElementById('dropdownOptions');
      const header = dropdown.querySelector('.dropdown-header');

      isDropdownOpen = !isDropdownOpen;

      if (isDropdownOpen) {
        header.classList.add('active');
        options.classList.add('show');
        loadCategoryOptions();

        // Close dropdown when clicking outside
        setTimeout(() => {
          document.addEventListener('click', closeDropdownOnClickOutside);
        }, 10);
      } else {
        closeCategoryDropdown();
      }
    }

    function closeCategoryDropdown() {
      const dropdown = document.getElementById('categoryDropdown');
      const options = document.getElementById('dropdownOptions');
      const header = dropdown.querySelector('.dropdown-header');

      isDropdownOpen = false;
      header.classList.remove('active');
      options.classList.remove('show');
      document.removeEventListener('click', closeDropdownOnClickOutside);
    }

    function closeDropdownOnClickOutside(event) {
      const dropdown = document.getElementById('categoryDropdown');
      const editDropdown = document.getElementById('editCategoryDropdown');
      if (!dropdown.contains(event.target) && !editDropdown.contains(event.target)) {
        closeCategoryDropdown();
        closeEditCategoryDropdown();
      }
    }

    function handleCategoryDropdownKeyPress(event) {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        toggleCategoryDropdown();
      }
    }

    function loadCategoryOptions() {
      const optionsContainer = document.getElementById('dropdownOptions');
      if (!optionsContainer) return;

      // Get word counts per category
      const categoryCounts = {};
      vocabularyApp.words.filter(w => !w.is_deleted).forEach(word => {
        const cat = word.category || 'General Vocabulary';
        categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
      });

      // Get current selection
      const currentCategory = document.getElementById('category').value;

      let html = '';

      vocabularyApp.categories.forEach(category => {
        const color = getCategoryColor(category);
        const count = categoryCounts[category] || 0;
        const isSelected = category === currentCategory;

        html += `
          <div class="dropdown-option ${isSelected ? 'selected' : ''}" 
               onclick="selectCategoryOption('${category.replace(/'/g, "\\'")}')"
               onkeypress="if(event.key === 'Enter') selectCategoryOption('${category.replace(/'/g, "\\'")}')"
               tabindex="0">
            <div class="option-color" style="background: ${color};"></div>
            <div class="option-text">${category}</div>
            <div class="option-count">${count}</div>
          </div>
        `;
      });

      // Add option to create new category
      html += `
        <div class="add-category-option" onclick="openCategoryModal(); closeCategoryDropdown();" tabindex="0">
          <div class="add-icon material-icons-round">add</div>
          <div class="add-text">Create New Category</div>
        </div>
      `;

      optionsContainer.innerHTML = html;
    }

    function selectCategoryOption(category) {
      const color = getCategoryColor(category);

      // Update visual selection
      document.getElementById('selectedColor').style.background = color;
      document.getElementById('selectedText').textContent = category;
      document.getElementById('category').value = category;

      // Show category pill animation
      showCategoryPill(category, color);

      // Close dropdown
      closeCategoryDropdown();
    }

    function showCategoryPill(category, color) {
      const dropdown = document.getElementById('categoryDropdown');

      // Remove existing pill if any
      const existingPill = dropdown.querySelector('.category-pill');
      if (existingPill) {
        existingPill.remove();
      }

      // Create pill
      const pill = document.createElement('div');
      pill.className = 'category-pill';
      pill.innerHTML = `
        <div class="category-pill-color" style="background: ${color};"></div>
        <span>${category}</span>
      `;

      // Insert after dropdown
      dropdown.parentNode.insertBefore(pill, dropdown.nextSibling);

      // Remove pill after 3 seconds
      setTimeout(() => {
        if (pill.parentNode) {
          pill.style.opacity = '0';
          pill.style.transform = 'translateY(-10px)';
          pill.style.transition = 'all 0.3s ease';

          setTimeout(() => {
            if (pill.parentNode) {
              pill.remove();
            }
          }, 300);
        }
      }, 3000);
    }

    // Edit modal dropdown functions
    function toggleEditCategoryDropdown() {
      const dropdown = document.getElementById('editCategoryDropdown');
      const options = document.getElementById('editDropdownOptions');
      const header = dropdown.querySelector('.dropdown-header');

      isEditDropdownOpen = !isEditDropdownOpen;

      if (isEditDropdownOpen) {
        header.classList.add('active');
        options.classList.add('show');
        loadEditCategoryOptions();

        // Close dropdown when clicking outside
        setTimeout(() => {
          document.addEventListener('click', closeEditDropdownOnClickOutside);
        }, 10);
      } else {
        closeEditCategoryDropdown();
      }
    }

    function closeEditCategoryDropdown() {
      const dropdown = document.getElementById('editCategoryDropdown');
      const options = document.getElementById('editDropdownOptions');
      const header = dropdown.querySelector('.dropdown-header');

      isEditDropdownOpen = false;
      header.classList.remove('active');
      options.classList.remove('show');
      document.removeEventListener('click', closeEditDropdownOnClickOutside);
    }

    function closeEditDropdownOnClickOutside(event) {
      const dropdown = document.getElementById('editCategoryDropdown');
      const mainDropdown = document.getElementById('categoryDropdown');
      if (!dropdown.contains(event.target) && !mainDropdown.contains(event.target)) {
        closeEditCategoryDropdown();
        closeCategoryDropdown();
      }
    }

    function handleEditCategoryDropdownKeyPress(event) {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        toggleEditCategoryDropdown();
      }
    }

    function loadEditCategoryOptions() {
      const optionsContainer = document.getElementById('editDropdownOptions');
      if (!optionsContainer) return;

      // Get word counts per category
      const categoryCounts = {};
      vocabularyApp.words.filter(w => !w.is_deleted).forEach(word => {
        const cat = word.category || 'General Vocabulary';
        categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
      });

      // Get current selection from edit modal
      const currentCategory = document.getElementById('editCategory').value;

      let html = '';

      vocabularyApp.categories.forEach(category => {
        const color = getCategoryColor(category);
        const count = categoryCounts[category] || 0;
        const isSelected = category === currentCategory;

        html += `
          <div class="dropdown-option ${isSelected ? 'selected' : ''}" 
               onclick="selectEditCategoryOption('${category.replace(/'/g, "\\'")}')"
               onkeypress="if(event.key === 'Enter') selectEditCategoryOption('${category.replace(/'/g, "\\'")}')"
               tabindex="0">
            <div class="option-color" style="background: ${color};"></div>
            <div class="option-text">${category}</div>
            <div class="option-count">${count}</div>
          </div>
        `;
      });

      // Add option to create new category
      html += `
        <div class="add-category-option" onclick="openCategoryModal(); closeEditCategoryDropdown();" tabindex="0">
          <div class="add-icon material-icons-round">add</div>
          <div class="add-text">Create New Category</div>
        </div>
      `;

      optionsContainer.innerHTML = html;
    }

    function selectEditCategoryOption(category) {
      const color = getCategoryColor(category);

      // Update visual selection in edit modal
      document.getElementById('editSelectedColor').style.background = color;
      document.getElementById('editSelectedText').textContent = category;
      document.getElementById('editCategory').value = category;

      // Show category pill animation
      showEditCategoryPill(category, color);

      // Close dropdown
      closeEditCategoryDropdown();
    }

    function showEditCategoryPill(category, color) {
      const dropdown = document.getElementById('editCategoryDropdown');

      // Remove existing pill if any
      const existingPill = dropdown.querySelector('.category-pill');
      if (existingPill) {
        existingPill.remove();
      }

      // Create pill
      const pill = document.createElement('div');
      pill.className = 'category-pill';
      pill.innerHTML = `
        <div class="category-pill-color" style="background: ${color};"></div>
        <span>${category}</span>
      `;

      // Insert after dropdown
      dropdown.parentNode.insertBefore(pill, dropdown.nextSibling);

      // Remove pill after 3 seconds
      setTimeout(() => {
        if (pill.parentNode) {
          pill.style.opacity = '0';
          pill.style.transform = 'translateY(-10px)';
          pill.style.transition = 'all 0.3s ease';

          setTimeout(() => {
            if (pill.parentNode) {
              pill.remove();
            }
          }, 300);
        }
      }, 3000);
    }

    function initializeEnhancedDropdowns() {
      // Initialize main dropdown
      const currentCategory = document.getElementById('category').value;
      const selectedColor = getCategoryColor(currentCategory);

      if (document.getElementById('selectedColor')) {
        document.getElementById('selectedColor').style.background = selectedColor;
        document.getElementById('selectedText').textContent = currentCategory;
      }

      // Make main dropdown accessible via keyboard
      const dropdownHeader = document.querySelector('#categoryDropdown .dropdown-header');
      if (dropdownHeader) {
        dropdownHeader.setAttribute('tabindex', '0');
        dropdownHeader.setAttribute('role', 'combobox');
        dropdownHeader.setAttribute('aria-expanded', 'false');
        dropdownHeader.setAttribute('aria-haspopup', 'listbox');

        dropdownHeader.addEventListener('keydown', function (e) {
          if (e.key === 'Escape') {
            closeCategoryDropdown();
          } else if (e.key === 'ArrowDown' && !isDropdownOpen) {
            e.preventDefault();
            toggleCategoryDropdown();
          }
        });
      }

      // Initialize edit dropdown if it exists
      if (document.getElementById('editSelectedColor')) {
        const editCurrentCategory = document.getElementById('editCategory').value;
        const editSelectedColor = getCategoryColor(editCurrentCategory);

        document.getElementById('editSelectedColor').style.background = editSelectedColor;
        document.getElementById('editSelectedText').textContent = editCurrentCategory;

        // Make edit dropdown accessible via keyboard
        const editDropdownHeader = document.querySelector('#editCategoryDropdown .dropdown-header');
        if (editDropdownHeader) {
          editDropdownHeader.setAttribute('tabindex', '0');
          editDropdownHeader.setAttribute('role', 'combobox');
          editDropdownHeader.setAttribute('aria-expanded', 'false');
          editDropdownHeader.setAttribute('aria-haspopup', 'listbox');

          editDropdownHeader.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
              closeEditCategoryDropdown();
            } else if (e.key === 'ArrowDown' && !isEditDropdownOpen) {
              e.preventDefault();
              toggleEditCategoryDropdown();
            }
          });
        }
      }
    }

    // ========== TEXT FORMATTING ==========
    function capitalizeWord(input) {
      if (input.value) {
        input.value = input.value
          .toLowerCase()
          .split(' ')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');
      }
    }

    function capitalizeFirstWord(textarea) {
      if (textarea.value) {
        let text = textarea.value.trim();
        if (text.length > 0) {
          text = text.charAt(0).toUpperCase() + text.slice(1);
          textarea.value = text;
        }
      }
    }

    function capitalizeSynonyms(input) {
      if (input.value) {
        input.value = input.value
          .split(',')
          .map(syn => syn.trim().charAt(0).toUpperCase() + syn.trim().slice(1).toLowerCase())
          .join(', ');
      }
    }

    function sentenceCase(textarea) {
      if (textarea.value) {
        let text = textarea.value.trim();
        if (text.length > 0) {
          text = text.charAt(0).toUpperCase() + text.slice(1);
          if (!/[.!?]$/.test(text)) {
            text += '.';
          }
          textarea.value = text;
        }
      }
    }

    // ========== WORD EXISTENCE CHECK ==========
    let checkTimeout = null;
    function checkWordExists(word) {
      if (!word.trim()) {
        document.getElementById('wordExistsAlert').classList.remove('show');
        return;
      }

      if (checkTimeout) clearTimeout(checkTimeout);

      checkTimeout = setTimeout(() => {
        const normalizedWord = word.trim().toLowerCase();
        const exists = vocabularyApp.words.some(w =>
          w.word.toLowerCase() === normalizedWord && !w.is_deleted
        );

        const alertElement = document.getElementById('wordExistsAlert');
        if (exists) {
          alertElement.classList.add('show');
        } else {
          alertElement.classList.remove('show');
        }
      }, 500);
    }

    // ========== PRONUNCIATION ==========
    function pronounceWord(word) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = 'en-US';
        utterance.rate = 0.8;
        utterance.pitch = 1;

        const voices = speechSynthesis.getVoices();
        if (voices.length > 0) {
          const usVoice = voices.find(v => v.lang.includes('en-US'));
          if (usVoice) utterance.voice = usVoice;
        }

        speechSynthesis.speak(utterance);
        showMessage(`Pronouncing: ${word}`, 'info');
      } else {
        showMessage('Text-to-speech not supported', 'error');
      }
    }

    // ========== CATEGORY MANAGEMENT ==========
    function selectCategoryColor(color) {
      vocabularyApp.selectedCategoryColor = color;
    }

    async function loadCategoriesFromServer() {
      try {
        const response = await fetch(`${SERVER_URL}/api/categories`);
        if (response.ok) {
          const serverCategories = await response.json();
          vocabularyApp.categories = serverCategories.map(c => c.name);
          vocabularyApp.categoryColors = {};

          serverCategories.forEach(category => {
            vocabularyApp.categoryColors[category.name] = category.color;
          });

          // Save to localStorage as backup
          saveCategoriesToStorage();

          // Update UI
          updateCategorySelects();
          return true;
        }
      } catch (error) {
        console.log('Failed to load categories from server, using local:', error);
      }

      // Fallback to local storage
      loadCategoriesFromStorage();
      return false;
    }

    function loadCategoriesFromStorage() {
      try {
        const saved = localStorage.getItem(CATEGORIES_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          vocabularyApp.categories = data.categories || [];
          vocabularyApp.categoryColors = data.colors || {};

          // Ensure default categories
          const defaults = ['General Vocabulary', 'Phrase and Idioms', 'Transitional Words'];
          defaults.forEach(cat => {
            if (!vocabularyApp.categories.includes(cat)) {
              vocabularyApp.categories.push(cat);
              if (!vocabularyApp.categoryColors[cat]) {
                vocabularyApp.categoryColors[cat] = cat === 'General Vocabulary' ? '#6366f1' :
                  cat === 'Phrase and Idioms' ? '#8b5cf6' : '#10b981';
              }
            }
          });
        } else {
          // Initialize with defaults
          vocabularyApp.categories = ['General Vocabulary', 'Phrase and Idioms', 'Transitional Words'];
          vocabularyApp.categoryColors = {
            'General Vocabulary': '#6366f1',
            'Phrase and Idioms': '#8b5cf6',
            'Transitional Words': '#10b981'
          };
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }

      updateCategorySelects();
    }

    function saveCategoriesToStorage() {
      try {
        const data = {
          categories: vocabularyApp.categories,
          colors: vocabularyApp.categoryColors,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem(CATEGORIES_KEY, JSON.stringify(data));
      } catch (error) {
        console.error('Error saving categories:', error);
      }
    }

    function updateCategorySelects() {
      // Update all regular selects
      const selects = ['filterSelect'];

      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;

        if (selectId === 'filterSelect') {
          select.innerHTML = `
            <option value="all">All Words</option>
            <option value="my">My Words</option>
            <option value="others">Other Devices</option>
          `;
        } else {
          select.innerHTML = '';
        }

        vocabularyApp.categories.forEach(category => {
          const option = document.createElement('option');
          const color = getCategoryColor(category);
          const textColor = getCategoryTextColor(color);

          if (selectId === 'filterSelect') {
            option.value = 'cat_' + category;
            option.textContent = category;
            select.appendChild(option);
          }
        });
      });

      // Also update the enhanced dropdown if it exists
      const currentCategory = document.getElementById('category').value;
      const selectedColor = getCategoryColor(currentCategory);

      if (document.getElementById('selectedColor')) {
        document.getElementById('selectedColor').style.background = selectedColor;
        document.getElementById('selectedText').textContent = currentCategory;
      }
    }

    function enhanceCategoryDropdowns() {
      const categorySelects = document.querySelectorAll('.select-with-colors');

      categorySelects.forEach(select => {
        // Apply enhanced styles
        select.style.padding = '14px 16px';
        select.style.borderRadius = '12px';
        select.style.border = '2px solid var(--border)';
        select.style.fontSize = '16px';
        select.style.fontWeight = '500';
        select.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`;
        select.style.backgroundRepeat = 'no-repeat';
        select.style.backgroundPosition = 'right 16px center';
        select.style.backgroundSize = '16px';
        select.style.paddingRight = '48px';
        select.style.appearance = 'none';
        select.style.webkitAppearance = 'none';
        select.style.mozAppearance = 'none';
        select.style.cursor = 'pointer';
        select.style.transition = 'all 0.3s';
        select.style.backgroundColor = 'white';

        // Hover and focus effects
        select.addEventListener('mouseenter', function () {
          this.style.borderColor = 'var(--primary)';
          this.style.boxShadow = '0 0 0 3px rgba(99, 102, 241, 0.1)';
        });

        select.addEventListener('mouseleave', function () {
          if (!this.matches(':focus')) {
            this.style.borderColor = 'var(--border)';
            this.style.boxShadow = 'none';
          }
        });

        select.addEventListener('focus', function () {
          this.style.borderColor = 'var(--primary)';
          this.style.boxShadow = '0 0 0 3px rgba(99, 102, 241, 0.1)';
          this.style.outline = 'none';
        });

        select.addEventListener('blur', function () {
          this.style.borderColor = 'var(--border)';
          this.style.boxShadow = 'none';
        });
      });
    }

    function getCategoryColor(category) {
      return vocabularyApp.categoryColors[category] || '#6366f1';
    }

    function getCategoryTextColor(backgroundColor) {
      const hex = backgroundColor.replace('#', '');
      const r = parseInt(hex.substr(0, 2), 16);
      const g = parseInt(hex.substr(2, 2), 16);
      const b = parseInt(hex.substr(4, 2), 16);
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.5 ? '#000000' : '#ffffff';
    }

    // ========== MODAL FUNCTIONS ==========
    function openEditModal(wordId) {
      const word = vocabularyApp.words.find(w => w.id === wordId);
      if (!word) return;

      vocabularyApp.editingWordId = wordId;

      document.getElementById('editWord').value = word.word;
      document.getElementById('editBangla').value = word.bangla || '';
      document.getElementById('editEnglish').value = word.english || '';
      document.getElementById('editSynonyms').value = word.synonyms || '';
      document.getElementById('editExample').value = word.example || '';

      // Set category for enhanced dropdown
      const category = word.category || 'General Vocabulary';
      const color = getCategoryColor(category);

      document.getElementById('editCategory').value = category;
      document.getElementById('editSelectedColor').style.background = color;
      document.getElementById('editSelectedText').textContent = category;

      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      vocabularyApp.editingWordId = null;
    }

    function openDeleteModal(wordId) {
      const word = vocabularyApp.words.find(w => w.id === wordId);
      if (!word) return;

      vocabularyApp.deletingWordId = wordId;
      document.getElementById('deleteWordName').textContent = word.word;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
      vocabularyApp.deletingWordId = null;
    }

    function openCategoryModal() {
      loadCategoriesList();
      document.getElementById('categoryModal').classList.add('active');
    }

    function closeCategoryModal() {
      document.getElementById('categoryModal').classList.remove('active');
      document.getElementById('newCategoryName').value = '';
    }

    function loadCategoriesList() {
      const categoriesList = document.getElementById('categoriesList');
      if (!categoriesList) return;

      categoriesList.innerHTML = '';

      vocabularyApp.categories.forEach((category) => {
        const isDefault = ['General Vocabulary', 'Phrase and Idioms', 'Transitional Words'].includes(category);
        const color = getCategoryColor(category);
        const textColor = getCategoryTextColor(color);

        const tag = document.createElement('div');
        tag.className = `category-tag ${isDefault ? 'locked' : ''}`;
        tag.style.background = color;
        tag.style.color = textColor;
        tag.style.borderColor = color;

        tag.innerHTML = `
              <div style="display: flex; align-items: center; gap: 8px;">
                  <span class="material-icons-round" style="font-size: 16px; color: ${textColor};">folder</span>
                  <span>${category}</span>
              </div>
              <div style="display: flex; gap: 5px;">
                  ${!isDefault ? `
                      <span class="material-icons-round" style="font-size: 16px; color: ${textColor};" 
                            onclick="event.stopPropagation(); renameCategory('${category}')" title="Rename">edit</span>
                      <span class="material-icons-round" style="font-size: 16px; color: ${textColor};" 
                            onclick="event.stopPropagation(); deleteCategoryFromServer('${category}')" title="Delete">delete</span>
                  ` : `<span class="material-icons-round" style="font-size: 16px; color: ${textColor};" title="Default category">lock</span>`}
              </div>
          `;

        categoriesList.appendChild(tag);
      });
    }

    async function addCustomCategory() {
      const categoryName = document.getElementById('newCategoryName').value.trim();
      const addBtn = document.getElementById('addCategoryBtn');

      if (!categoryName) {
        showMessage('Please enter a category name', 'error');
        return;
      }

      if (vocabularyApp.categories.includes(categoryName)) {
        showMessage('Category already exists', 'error');
        return;
      }

      // Show loading
      if (addBtn) {
        addBtn.disabled = true;
        addBtn.innerHTML = '<span class="material-icons-round spin">hourglass_empty</span> Adding...';
      }

      try {
        // Try to add to server first
        if (vocabularyApp.serverOnline) {
          const response = await fetch(`${SERVER_URL}/api/categories/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: categoryName,
              color: vocabularyApp.selectedCategoryColor
            })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to add category');
          }
        }

        // Add locally
        vocabularyApp.categories.push(categoryName);
        vocabularyApp.categoryColors[categoryName] = vocabularyApp.selectedCategoryColor;

        // Update words that might have this category
        vocabularyApp.words.forEach(word => {
          if (word.category === categoryName) {
            word.synced_to_server = false;
          }
        });

        saveCategoriesToStorage();
        updateCategorySelects();
        loadCategoriesList();
        saveToStorage();

        // Update both dropdowns
        loadCategoryOptions();
        if (document.getElementById('editDropdownOptions')) {
          loadEditCategoryOptions();
        }

        document.getElementById('newCategoryName').value = '';
        showMessage(`Category "${categoryName}" added successfully!`, 'success');

      } catch (error) {
        showMessage(error.message, 'error');
      } finally {
        if (addBtn) {
          addBtn.disabled = false;
          addBtn.innerHTML = '<span class="material-icons-round">add</span> Add';
        }
      }
    }

    async function deleteCategoryFromServer(categoryName) {
      if (['General Vocabulary', 'Phrase and Idioms', 'Transitional Words'].includes(categoryName)) {
        showMessage('Cannot delete default categories', 'error');
        return;
      }

      if (!confirm(`Delete category "${categoryName}"? All words in this category will be moved to "General Vocabulary".`)) {
        return;
      }

      try {
        // Try to delete from server first
        if (vocabularyApp.serverOnline) {
          const response = await fetch(`${SERVER_URL}/api/categories/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: categoryName })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to delete category');
          }
        }

        // Delete locally
        const index = vocabularyApp.categories.indexOf(categoryName);
        if (index > -1) {
          vocabularyApp.categories.splice(index, 1);
          delete vocabularyApp.categoryColors[categoryName];
        }

        // Update words
        let movedCount = 0;
        vocabularyApp.words.forEach(word => {
          if (word.category === categoryName && !word.is_deleted) {
            word.category = 'General Vocabulary';
            word.synced_to_server = false;
            movedCount++;
          }
        });

        saveCategoriesToStorage();
        updateCategorySelects();
        loadCategoriesList();
        saveToStorage();
        loadWords();

        // Update both dropdowns
        loadCategoryOptions();
        if (document.getElementById('editDropdownOptions')) {
          loadEditCategoryOptions();
        }

        showMessage(`Category "${categoryName}" deleted. ${movedCount} words moved to General Vocabulary.`, 'success');

      } catch (error) {
        showMessage(error.message, 'error');
      }
    }

    function renameCategory(oldName) {
      if (['General Vocabulary', 'Phrase and Idioms', 'Transitional Words'].includes(oldName)) {
        showMessage('Cannot rename default categories', 'error');
        return;
      }

      const newName = prompt('Enter new name for category:', oldName);
      if (!newName || newName.trim() === '' || newName === oldName) {
        return;
      }

      const trimmedName = newName.trim();

      if (vocabularyApp.categories.includes(trimmedName)) {
        showMessage('Category already exists', 'error');
        return;
      }

      // Update locally
      const index = vocabularyApp.categories.indexOf(oldName);
      if (index > -1) {
        vocabularyApp.categories[index] = trimmedName;
        vocabularyApp.categoryColors[trimmedName] = vocabularyApp.categoryColors[oldName];
        delete vocabularyApp.categoryColors[oldName];
      }

      // Update words
      vocabularyApp.words.forEach(word => {
        if (word.category === oldName) {
          word.category = trimmedName;
          word.synced_to_server = false;
        }
      });

      saveCategoriesToStorage();
      updateCategorySelects();
      loadCategoriesList();
      saveToStorage();
      loadWords();

      // Update both dropdowns
      loadCategoryOptions();
      if (document.getElementById('editDropdownOptions')) {
        loadEditCategoryOptions();
      }

      showMessage(`Category renamed to: "${trimmedName}"`, 'success');
    }

    // ========== STORAGE FUNCTIONS ==========
    function loadFromStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (!data) return [];

        const words = JSON.parse(data);
        return words.filter(word =>
          word && word.word && typeof word.word === 'string' && word.id
        );
      } catch (error) {
        console.error('Error loading from storage:', error);
        return [];
      }
    }

    function saveToStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(vocabularyApp.words));
        updateWordCountDisplay();
        return true;
      } catch (error) {
        console.error('Error saving to storage:', error);
        return false;
      }
    }

    // ========== SERVER CONNECTION ==========
    async function checkServerConnection() {
      const statusElement = document.getElementById('connectionStatus');

      statusElement.className = 'connection-status status-syncing';
      statusElement.innerHTML = `<span class="material-icons-round">search</span><span>Checking connection...</span>`;

      try {
        const response = await fetch(`${SERVER_URL}/api/test`, {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });

        if (response.ok) {
          vocabularyApp.serverOnline = true;

          statusElement.className = 'connection-status status-online';
          statusElement.innerHTML = `
                  <span class="material-icons-round">wifi</span>
                  <span>Connected to server</span>
              `;

          // Load categories from server
          await loadCategoriesFromServer();

          return true;
        }
      } catch (error) {
        console.error('Connection failed:', error);
      }

      vocabularyApp.serverOnline = false;
      statusElement.className = 'connection-status status-offline';
      statusElement.innerHTML = `
          <span class="material-icons-round">wifi_off</span>
          <span>Offline mode</span>
      `;

      loadCategoriesFromStorage();

      return false;
    }

    // ========== WORD MANAGEMENT ==========
    function saveWord() {
      const wordInput = document.getElementById('word').value.trim();

      if (!wordInput) {
        showMessage('Please enter a word', 'error');
        return;
      }

      const newWord = {
        id: 'word_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        word: wordInput,
        category: document.getElementById('category').value,
        bangla: document.getElementById('bangla').value.trim(),
        english: document.getElementById('english').value.trim(),
        synonyms: document.getElementById('synonyms').value.trim(),
        example: document.getElementById('example').value.trim(),
        date: new Date().toISOString(),
        synced_to_server: false,
        device_source: DEVICE_ID,
        is_from_other_device: false,
        is_deleted: false,
        is_edited: false
      };

      // Apply formatting
      newWord.word = newWord.word
        .toLowerCase()
        .split(' ')
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(' ');

      if (newWord.english) {
        newWord.english = newWord.english.charAt(0).toUpperCase() + newWord.english.slice(1);
      }

      if (newWord.synonyms) {
        newWord.synonyms = newWord.synonyms
          .split(',')
          .map(syn => syn.trim().charAt(0).toUpperCase() + syn.trim().slice(1).toLowerCase())
          .join(', ');
      }

      if (newWord.example) {
        newWord.example = newWord.example.trim();
        if (newWord.example.length > 0) {
          newWord.example = newWord.example.charAt(0).toUpperCase() + newWord.example.slice(1);
          if (!/[.!?]$/.test(newWord.example)) {
            newWord.example += '.';
          }
        }
      }

      const saveBtn = document.getElementById('saveBtn');
      const saveIcon = document.getElementById('saveIcon');
      const saveText = document.getElementById('saveText');

      saveBtn.disabled = true;
      saveIcon.textContent = 'hourglass_empty';
      saveText.textContent = 'Saving...';

      vocabularyApp.words.unshift(newWord);
      saveToStorage();
      loadWords();
      updateStats();
      updateWordCounts();

      clearForm();
      showMessage(`Word "${newWord.word}" saved successfully!`, 'success');

      // Try to sync
      if (vocabularyApp.serverOnline) {
        setTimeout(() => syncAllData(), 1000);
      }

      setTimeout(() => {
        saveBtn.disabled = false;
        saveIcon.textContent = 'save';
        saveText.textContent = 'Save Word';
      }, 1000);
    }






    function saveEditedWord() {
      const wordId = vocabularyApp.editingWordId;
      if (!wordId) return;

      const wordIndex = vocabularyApp.words.findIndex(w => w.id === wordId);
      if (wordIndex === -1) return;

      const originalWord = vocabularyApp.words[wordIndex];

      // Update the existing word instead of creating a new one
      vocabularyApp.words[wordIndex] = {
        ...originalWord,
        word: document.getElementById('editWord').value.trim(),
        category: document.getElementById('editCategory').value,
        bangla: document.getElementById('editBangla').value.trim(),
        english: document.getElementById('editEnglish').value.trim(),
        synonyms: document.getElementById('editSynonyms').value.trim(),
        example: document.getElementById('editExample').value.trim(),
        synced_to_server: false,
        is_edited: true,
        last_modified: new Date().toISOString()
      };

      // Apply formatting
      const updatedWord = vocabularyApp.words[wordIndex];

      updatedWord.word = updatedWord.word
        .toLowerCase()
        .split(' ')
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(' ');

      if (updatedWord.english) {
        updatedWord.english = updatedWord.english.charAt(0).toUpperCase() + updatedWord.english.slice(1);
      }

      if (updatedWord.synonyms) {
        updatedWord.synonyms = updatedWord.synonyms
          .split(',')
          .map(syn => syn.trim().charAt(0).toUpperCase() + syn.trim().slice(1).toLowerCase())
          .join(', ');
      }

      if (updatedWord.example) {
        updatedWord.example = updatedWord.example.trim();
        if (updatedWord.example.length > 0) {
          updatedWord.example = updatedWord.example.charAt(0).toUpperCase() + updatedWord.example.slice(1);
          if (!/[.!?]$/.test(updatedWord.example)) {
            updatedWord.example += '.';
          }
        }
      }

      saveToStorage();
      loadWords();
      updateStats();
      updateWordCounts();

      closeEditModal();
      showMessage(`Word "${updatedWord.word}" updated successfully!`, 'success');

      if (vocabularyApp.serverOnline) {
        setTimeout(() => syncAllData(), 1000);
      }
    }



    function confirmDeleteWord() {
      const wordId = vocabularyApp.deletingWordId;
      if (!wordId) return;

      const wordIndex = vocabularyApp.words.findIndex(w => w.id === wordId);
      if (wordIndex === -1) return;

      const deleteBtn = document.getElementById('confirmDeleteBtn');
      const deletedWord = vocabularyApp.words[wordIndex];

      // Show loading on delete button
      if (deleteBtn) {
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<span class="material-icons-round spin">delete</span> Deleting...';
      }

      // Mark as deleted for sync
      deletedWord.is_deleted = true;
      deletedWord.deleted_at = new Date().toISOString();
      deletedWord.synced_to_server = false;

      // Immediately remove from display
      vocabularyApp.words.splice(wordIndex, 1);

      saveToStorage();
      loadWords();
      updateStats();
      updateWordCounts();

      closeDeleteModal();
      showMessage(`Word "${deletedWord.word}" deleted successfully!`, 'success');

      // Auto-sync if online
      if (vocabularyApp.serverOnline) {
        setTimeout(() => {
          syncAllData();
        }, 1000);
      }

      // Reset button
      setTimeout(() => {
        if (deleteBtn) {
          deleteBtn.disabled = false;
          deleteBtn.innerHTML = '<span class="material-icons-round">delete_forever</span> Delete Permanently';
        }
      }, 1000);
    }















    // ========== DATA CLEANUP FUNCTIONS ==========
    function cleanupOrphanedData() {
      // Remove any words that don't have proper word field
      const initialLength = vocabularyApp.words.length;
      vocabularyApp.words = vocabularyApp.words.filter(word =>
        word && word.word && word.word.trim() && word.id
      );

      const cleanedCount = initialLength - vocabularyApp.words.length;
      if (cleanedCount > 0) {
        console.log(`🧹 Cleaned up ${cleanedCount} orphaned words`);
        saveToStorage();
        return cleanedCount;
      }
      return 0;
    }

    function cleanupDuplicates() {
      // Remove duplicate words from same device
      const wordMap = new Map();
      const duplicates = [];

      for (let i = vocabularyApp.words.length - 1; i >= 0; i--) {
        const word = vocabularyApp.words[i];
        const key = `${word.word.toLowerCase()}_${word.device_source}`;

        if (wordMap.has(key) && !word.is_deleted) {
          // Found duplicate - remove the older one
          duplicates.push(word);
          vocabularyApp.words.splice(i, 1);
        } else {
          wordMap.set(key, word);
        }
      }

      if (duplicates.length > 0) {
        console.log(`🗑️ Removed ${duplicates.length} duplicate words`);
        saveToStorage();
      }

      return duplicates.length;
    }










    // ========== SYNC FUNCTIONS ==========
    async function syncAllData() {
      const syncBtn = document.getElementById('syncBtn');
      const syncIcon = document.getElementById('syncIcon');
      const syncText = document.getElementById('syncText');

      if (syncBtn) {
        syncBtn.disabled = true;
        syncIcon.classList.add('spin');
        syncText.textContent = 'Syncing...';
      }

      if (!vocabularyApp.serverOnline) {
        const connected = await checkServerConnection();
        if (!connected) {
          showMessage('Cannot connect to server', 'error');
          resetButton(syncBtn, syncIcon, syncText, 'sync', 'Sync All Now');
          return;
        }
      }

      const statusElement = document.getElementById('connectionStatus');
      statusElement.className = 'connection-status status-syncing';
      statusElement.innerHTML = `<span class="material-icons-round">sync</span><span>Starting full sync...</span>`;

      try {
        // STEP 1: Handle deletions locally first
        // Remove words marked as deleted from local array
        const deletionCount = vocabularyApp.words.filter(w => w.is_deleted).length;
        if (deletionCount > 0) {
          // Create backup of deleted words before removing
          const deletedWords = vocabularyApp.words.filter(w => w.is_deleted);

          // Remove deleted words from local array
          vocabularyApp.words = vocabularyApp.words.filter(w => !w.is_deleted);

          console.log(`🗑️ Removed ${deletionCount} deleted words locally`);
        }

        // STEP 2: Upload local changes (new words, edits)
        const unsyncedWords = vocabularyApp.words.filter(word =>
          word.device_source === DEVICE_ID &&
          !word.synced_to_server
        );

        if (unsyncedWords.length > 0) {
          statusElement.innerHTML = `<span class="material-icons-round">cloud_upload</span><span>Uploading ${unsyncedWords.length} local changes...</span>`;

          // Also upload any deletions we have
          const wordsToUpload = [...unsyncedWords];

          const uploadResult = await uploadToServer(wordsToUpload);

          if (uploadResult && uploadResult.success) {
            // Mark uploaded words as synced
            unsyncedWords.forEach(word => {
              word.synced_to_server = true;
            });
            saveToStorage();

            console.log(`✅ Uploaded ${unsyncedWords.length} words to server`);
          }
        }

        // STEP 3: Download deleted words from server
        statusElement.innerHTML = `<span class="material-icons-round">cloud_download</span><span>Checking for deletions...</span>`;
        const deletionResult = await downloadDeletedWords();

        if (deletionResult && deletionResult.success) {
          console.log(`✅ Processed ${deletionResult.deleted || 0} deletions from server`);
        }

        // STEP 4: Download new/updated words from server
        statusElement.innerHTML = `<span class="material-icons-round">cloud_download</span><span>Downloading new words...</span>`;
        const downloadResult = await downloadAllFromServer();

        // STEP 5: Update last sync time
        const currentTime = new Date().toLocaleString();
        localStorage.setItem('last_sync_time', currentTime);
        document.getElementById('lastSyncTime').textContent = currentTime;

        // STEP 6: Clean up and refresh UI
        saveToStorage();
        loadWords();
        updateStats();
        updateWordCounts();

        statusElement.className = 'connection-status status-online';
        statusElement.innerHTML = `
      <span class="material-icons-round">check_circle</span>
      <span>Sync complete!</span>
    `;

        showMessage('All data synchronized successfully!', 'success');

      } catch (error) {
        console.error('Sync error:', error);
        statusElement.className = 'connection-status status-offline';
        statusElement.innerHTML = `<span class="material-icons-round">error</span><span>Sync failed</span>`;

        showMessage('Sync failed: ' + error.message, 'error');
      } finally {
        resetButton(syncBtn, syncIcon, syncText, 'sync', 'Sync All Now');
      }
    }









    async function downloadDeletedWords() {
      if (!vocabularyApp.serverOnline) return { success: false };

      try {
        const response = await fetch(`${SERVER_URL}/api/deleted_words`);

        if (response.ok) {
          const deletedWords = await response.json();
          let deletedCount = 0;

          // Create a map of local words by server_id
          const localWordsByServerId = new Map();
          const localWordsByContent = new Map();

          vocabularyApp.words.forEach(word => {
            if (word.server_id) {
              localWordsByServerId.set(word.server_id.toString(), word);
            }
            const contentKey = `${word.word}_${word.device_source}`;
            localWordsByContent.set(contentKey, word);
          });

          // Process each deleted word from server
          for (const deletedWord of deletedWords) {
            const serverId = deletedWord.server_id?.toString();

            // Skip if deletion is from current device (we already handled it)
            if (deletedWord.device_id === DEVICE_ID) {
              continue;
            }

            // Find matching local word by server_id
            if (serverId && localWordsByServerId.has(serverId)) {
              const localWord = localWordsByServerId.get(serverId);

              // Mark as deleted and remove from display
              if (!localWord.is_deleted) {
                localWord.is_deleted = true;
                localWord.synced_to_server = true;
                deletedCount++;
                console.log(`Marked word as deleted by server_id: ${localWord.word}`);
              }
            } else {
              // Try to find by word text and device_id (for words without server_id)
              const contentKey = `${deletedWord.word}_${deletedWord.device_id}`;
              if (localWordsByContent.has(contentKey)) {
                const localWord = localWordsByContent.get(contentKey);
                if (!localWord.is_deleted) {
                  localWord.is_deleted = true;
                  localWord.synced_to_server = true;
                  deletedCount++;
                  console.log(`Marked word as deleted by content: ${localWord.word}`);
                }
              }
            }
          }

          // Remove deleted words from array
          vocabularyApp.words = vocabularyApp.words.filter(word => !word.is_deleted);

          if (deletedCount > 0) {
            console.log(`Removed ${deletedCount} words deleted on other devices`);
            showMessage(`Removed ${deletedCount} words deleted on other devices`, 'info');
          }

          return { success: true, deleted: deletedCount };

        } else {
          throw new Error('Failed to fetch deleted words');
        }

      } catch (error) {
        console.error('Error downloading deleted words:', error);
        return { success: false, error: error.message };
      }
    }

    async function downloadAllFromServer() {
      const downloadBtn = document.getElementById('downloadBtn');
      const downloadIcon = document.getElementById('downloadIcon');
      const downloadText = document.getElementById('downloadText');

      if (downloadBtn) {
        downloadBtn.disabled = true;
        downloadIcon.classList.add('spin');
        downloadText.textContent = 'Downloading...';
      }

      if (!vocabularyApp.serverOnline) {
        showMessage('No server connection', 'error');
        resetButton(downloadBtn, downloadIcon, downloadText, 'cloud_download', 'Get Others Words');
        return { success: false };
      }

      try {
        const response = await fetch(`${SERVER_URL}/api/download`);

        if (response.ok) {
          const serverWords = await response.json();

          // Create maps for efficient lookup
          const localWordsByServerId = new Map();
          const localWordsByContent = new Map();

          vocabularyApp.words.forEach(word => {
            if (word.server_id) {
              localWordsByServerId.set(word.server_id.toString(), word);
            }
            const contentKey = `${word.word}_${word.device_source}`;
            localWordsByContent.set(contentKey, word);
          });

          let newWordsCount = 0;
          let updatedWordsCount = 0;

          for (const serverWord of serverWords) {
            const serverId = serverWord.server_id.toString();
            const isFromThisDevice = serverWord.device_id === DEVICE_ID;
            const contentKey = `${serverWord.word}_${serverWord.device_id}`;

            // Skip deleted words from server (already handled by downloadDeletedWords)
            if (serverWord.is_deleted) {
              continue;
            }

            if (localWordsByServerId.has(serverId)) {
              const localWord = localWordsByServerId.get(serverId);

              // Update existing word with server data
              if (!localWord.is_deleted) {
                const serverDate = new Date(serverWord.date_added || serverWord.date);
                const localDate = new Date(localWord.date);

                if (serverDate > localDate) {
                  Object.assign(localWord, {
                    word: serverWord.word,
                    bangla: serverWord.meaning_bangla,
                    english: serverWord.meaning_english,
                    synonyms: serverWord.synonyms,
                    example: serverWord.example_sentence,
                    category: serverWord.category || 'General Vocabulary',
                    date: serverWord.date_added,
                    synced_to_server: true,
                    is_edited: serverWord.is_edited || false,
                    original_id: serverWord.original_id || localWord.original_id
                  });
                  updatedWordsCount++;
                }
              }
            } else if (localWordsByContent.has(contentKey)) {
              // Word exists locally but doesn't have server_id yet
              const localWord = localWordsByContent.get(contentKey);
              if (!localWord.is_deleted) {
                localWord.server_id = serverId;
                localWord.synced_to_server = true;
                localWord.is_edited = serverWord.is_edited || false;
                localWord.original_id = serverWord.original_id || localWord.original_id;
                updatedWordsCount++;
              }
            } else {
              // This is a completely new word from server
              // Check if we have a deleted version of this word
              const existingDeleted = vocabularyApp.words.find(w =>
                w.word === serverWord.word &&
                w.device_source === serverWord.device_id &&
                w.is_deleted
              );

              if (!existingDeleted) {
                const newWord = {
                  id: 'server_' + serverId,
                  word: serverWord.word,
                  bangla: serverWord.meaning_bangla,
                  english: serverWord.meaning_english,
                  synonyms: serverWord.synonyms,
                  example: serverWord.example_sentence,
                  date: serverWord.date_added,
                  category: serverWord.category || 'General Vocabulary',
                  status: 'synced',
                  server_id: serverId,
                  synced_to_server: true,
                  device_source: serverWord.device_id,
                  is_from_other_device: !isFromThisDevice,
                  downloaded_at: new Date().toISOString(),
                  is_deleted: false,
                  is_edited: serverWord.is_edited || false,
                  original_id: serverWord.original_id || null
                };

                vocabularyApp.words.push(newWord);
                newWordsCount++;
              }
            }
          }

          saveToStorage();
          loadWords();
          updateStats();
          updateWordCounts();

          const messages = [];
          if (newWordsCount > 0) messages.push(`${newWordsCount} new`);
          if (updatedWordsCount > 0) messages.push(`${updatedWordsCount} updated`);

          if (messages.length > 0) {
            showMessage(`Downloaded: ${messages.join(', ')} words`, 'success');
          } else {
            showMessage('Already synchronized with server', 'info');
          }

          return {
            success: true,
            newWords: newWordsCount,
            updated: updatedWordsCount
          };

        } else {
          throw new Error('Download failed: ' + response.status);
        }

      } catch (error) {
        console.error('Download error:', error);
        showMessage('Failed to download: ' + error.message, 'error');
        return { success: false, error: error.message };
      } finally {
        resetButton(downloadBtn, downloadIcon, downloadText, 'cloud_download', 'Get Others Words');
      }
    }

    async function uploadToServer(words) {
      if (!vocabularyApp.serverOnline) return { success: false };

      try {
        const wordsData = words.map(word => ({
          word: word.word,
          meaning_bangla: word.bangla,
          meaning_english: word.english,
          synonyms: word.synonyms,
          example_sentence: word.example,
          category: word.category,
          timestamp: word.date,
          device_id: DEVICE_ID,
          device_name: DEVICE_NAME,
          is_deleted: word.is_deleted || false,
          is_edited: word.is_edited || false,
          original_id: word.original_id || null,
          server_id: word.server_id || null
        }));

        const response = await fetch(`${SERVER_URL}/api/sync`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            device_id: DEVICE_ID,
            device_name: DEVICE_NAME,
            words: wordsData
          })
        });

        if (response.ok) {
          const result = await response.json();
          console.log('Upload successful:', result);
          return { success: true, data: result };
        } else {
          const error = await response.text();
          throw new Error('Upload failed: ' + error);
        }
      } catch (error) {
        console.error('Upload error:', error);
        throw error;
      }
    }

    // ========== DISPLAY FUNCTIONS ==========
    let currentSort = 'date-desc';
    let currentFilter = 'all';

    function sortWords() {
      currentSort = document.getElementById('sortSelect').value;
      displayWords(vocabularyApp.words);
    }

    function filterWords() {
      currentFilter = document.getElementById('filterSelect').value;
      displayWords(vocabularyApp.words);
    }

    function searchWords() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      if (!query) {
        displayWords(vocabularyApp.words);
        return;
      }

      const filtered = vocabularyApp.words.filter(word =>
        !word.is_deleted && (
          word.word.toLowerCase().includes(query) ||
          (word.bangla && word.bangla.toLowerCase().includes(query)) ||
          (word.english && word.english.toLowerCase().includes(query)) ||
          (word.synonyms && word.synonyms.toLowerCase().includes(query)) ||
          (word.example && word.example.toLowerCase().includes(query)) ||
          (word.category && word.category.toLowerCase().includes(query))
        )
      );

      displayWords(filtered);
    }

    function displayWords(words) {
      const container = document.getElementById('wordsList');
      if (!container) return;

      let filteredWords = words.filter(w => !w.is_deleted);

      switch (currentFilter) {
        case 'my':
          filteredWords = filteredWords.filter(w => w.device_source === DEVICE_ID);
          break;
        case 'others':
          filteredWords = filteredWords.filter(w => w.device_source !== DEVICE_ID);
          break;
        default:
          if (currentFilter.startsWith('cat_')) {
            const category = currentFilter.substring(4);
            filteredWords = filteredWords.filter(w => w.category === category);
          }
      }

      switch (currentSort) {
        case 'date-desc':
          filteredWords.sort((a, b) => new Date(b.date) - new Date(a.date));
          break;
        case 'date-asc':
          filteredWords.sort((a, b) => new Date(a.date) - new Date(b.date));
          break;
        case 'a-z':
          filteredWords.sort((a, b) => a.word.localeCompare(b.word));
          break;
        case 'z-a':
          filteredWords.sort((a, b) => b.word.localeCompare(a.word));
          break;
        case 'category':
          filteredWords.sort((a, b) => a.category.localeCompare(b.category) || a.word.localeCompare(b.word));
          break;
      }

      if (filteredWords.length === 0) {
        container.innerHTML = `
              <div class="empty-state">
                  <div class="material-icons-round" style="font-size: 48px;">auto_stories</div>
                  <div class="empty-title">No words found</div>
                  <div class="empty-message">${currentFilter !== 'all' ? 'Try changing your filters' : 'Add your first word to get started!'}</div>
              </div>
          `;
        return;
      }

      let html = '';

      filteredWords.forEach((word) => {
        if (!word || !word.word) return;

        const date = new Date(word.date).toLocaleDateString() + ' ' +
          new Date(word.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let cardClass = 'word-card';
        let statusBadge = '';
        let deviceBadge = '';

        const isFromThisDevice = word.device_source === DEVICE_ID;
        const isSynced = word.synced_to_server;

        if (isSynced) {
          cardClass += ' synced';
          statusBadge = `<span class="word-status status-synced-badge"><span class="material-icons-round" style="font-size: 14px;">cloud_done</span> Synced</span>`;
        } else {
          cardClass += ' offline';
          statusBadge = `<span class="word-status status-offline-badge"><span class="material-icons-round" style="font-size: 14px;">device_hub</span> Local</span>`;
        }

        if (word.is_edited) {
          statusBadge += ` <span class="word-status status-synced-badge" style="background: #f3e8ff; color: #6b21a8;"><span class="material-icons-round" style="font-size: 14px;">edit</span> Edited</span>`;
        }

        if (!isFromThisDevice) {
          cardClass += ' from-other';
        }

        // Category badge with color
        const categoryColor = getCategoryColor(word.category || 'General Vocabulary');
        const categoryTextColor = getCategoryTextColor(categoryColor);
        const categoryBadge = `
            <span class="category-badge" style="background: ${categoryColor}; color: ${categoryTextColor}; border-color: ${categoryColor};">
              <span class="material-icons-round" style="font-size: 14px; color: ${categoryTextColor};">folder</span>
              ${word.category || 'General Vocabulary'}
            </span>
          `;

        if (isFromThisDevice) {
          deviceBadge = `<span class="device-badge me"><span class="material-icons-round" style="font-size: 14px;">person</span> You</span>`;
        } else {
          const devicePrefix = word.device_source ? word.device_source.substr(0, 6) + '...' : 'Other';
          deviceBadge = `<span class="device-badge other"><span class="material-icons-round" style="font-size: 14px;">devices</span> ${devicePrefix}</span>`;
        }

        html += `
            <div class="${cardClass}" data-word-id="${word.id}">
              <div class="word-header">
                <div class="word-title-wrapper">
                  <div class="word-title">${word.word}</div>
                  <button class="action-btn pronounce" onclick="pronounceWord('${word.word.replace(/'/g, "\\'")}')" title="Pronounce">
                    <span class="material-icons-round">volume_up</span>
                  </button>
                  ${categoryBadge}
                </div>
                <div class="word-actions">
                  <button class="action-btn edit" onclick="openEditModal('${word.id}')" title="Edit">
                    <span class="material-icons-round">edit</span>
                  </button>
                  <button class="action-btn delete" onclick="openDeleteModal('${word.id}')" title="Delete">
                    <span class="material-icons-round">delete</span>
                  </button>
                </div>
              </div>
              
              <div class="word-meta">
                ${statusBadge}
                ${deviceBadge}
                <span class="word-date"><span class="material-icons-round" style="font-size: 14px;">schedule</span> ${date}</span>
              </div>
              
              <div class="word-content">
                ${word.bangla ? `
                <div class="meaning-row">
                  <div class="meaning-icon bangla">
                    <span class="material-icons-round">translate</span>
                  </div>
                  <div class="meaning-text"><strong>Bangla:</strong> ${word.bangla}</div>
                </div>
                ` : ''}
                
                ${word.english ? `
                <div class="meaning-row">
                  <div class="meaning-icon english">
                    <span class="material-icons-round">translate</span>
                  </div>
                  <div class="meaning-text"><strong>English:</strong> ${word.english}</div>
                </div>
                ` : ''}
                
                ${word.synonyms ? `
                <div class="synonyms">
                  <span class="material-icons-round">swap_horiz</span>
                  <span><strong>Synonyms:</strong> ${word.synonyms}</span>
                </div>
                ` : ''}
                
                ${word.example ? `
                <div class="example">
                  <strong>Example:</strong> "${word.example}"
                </div>
                ` : ''}
              </div>
            </div>
          `;
      });

      container.innerHTML = html;
    }

    function loadWords() {
      displayWords(vocabularyApp.words);
    }

    // ========== UTILITY FUNCTIONS ==========
    function updateWordCountDisplay() {
      const activeWords = vocabularyApp.words.filter(w => !w.is_deleted).length;
      const infoElement = document.getElementById('connectionInfo');

      if (infoElement) {
        if (vocabularyApp.serverOnline) {
          infoElement.textContent = `Connected to: ${SERVER_URL} • ${activeWords} words`;
        } else {
          infoElement.textContent = `Offline mode • ${activeWords} words`;
        }
      }
    }

    function updateDeviceInfo() {
      const deviceInfoElement = document.getElementById('deviceInfo');
      if (deviceInfoElement) {
        const myWords = vocabularyApp.words.filter(w => w.device_source === DEVICE_ID && !w.is_deleted).length;
        const otherWords = vocabularyApp.words.filter(w => !w.is_deleted).length - myWords;

        deviceInfoElement.innerHTML = `
            <strong>Device ID:</strong> ${DEVICE_ID.substr(0, 8)}...<br>
            <strong>My Words:</strong> ${myWords}<br>
            <strong>From Other Devices:</strong> ${otherWords}<br>
            <strong>Categories:</strong> ${vocabularyApp.categories.length}
          `;
      }
    }

    function updateStats() {
      const container = document.getElementById('statsContainer');
      if (!container) return;

      const totalWords = vocabularyApp.words.filter(w => !w.is_deleted).length;
      const myWords = vocabularyApp.words.filter(w => w.device_source === DEVICE_ID && !w.is_deleted).length;
      const otherDeviceWords = totalWords - myWords;
      const pendingSync = vocabularyApp.words.filter(w => !w.synced_to_server && w.device_source === DEVICE_ID && !w.is_deleted).length;

      const categoryCounts = {};
      vocabularyApp.words.filter(w => !w.is_deleted).forEach(word => {
        const cat = word.category || 'General Vocabulary';
        categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
      });

      container.innerHTML = `
          <div class="stat-card">
              <div class="stat-number"><span class="material-icons-round">auto_stories</span>${totalWords}</div>
              <div class="stat-label">All Words</div>
          </div>
          <div class="stat-card">
              <div class="stat-number"><span class="material-icons-round">person</span>${myWords}</div>
              <div class="stat-label">My Words</div>
          </div>
          <div class="stat-card">
              <div class="stat-number"><span class="material-icons-round">devices</span>${otherDeviceWords}</div>
              <div class="stat-label">From Others</div>
          </div>
          <div class="stat-card">
              <div class="stat-number"><span class="material-icons-round">category</span>${Object.keys(categoryCounts).length}</div>
              <div class="stat-label">Categories</div>
          </div>
      `;
    }

    function updateWordCounts() {
      const myWords = vocabularyApp.words.filter(w => w.device_source === DEVICE_ID && !w.is_deleted).length;
      const otherWords = vocabularyApp.words.filter(w => !w.is_deleted).length - myWords;
      const pending = vocabularyApp.words.filter(w => !w.synced_to_server && w.device_source === DEVICE_ID && !w.is_deleted).length;

      document.getElementById('myWordsCount').textContent = myWords;
      document.getElementById('otherWordsCount').textContent = otherWords;
      document.getElementById('pendingSyncCount').textContent = pending;

      updateDeviceInfo();
      updateWordCountDisplay();
    }

    function resetButton(button, icon, textElement, iconName, text) {
      if (button && icon && textElement) {
        setTimeout(() => {
          button.disabled = false;
          icon.classList.remove('spin');
          icon.textContent = iconName;
          textElement.textContent = text;
        }, 1000);
      }
    }






















    // ========== MODERN FLASHCARD SYSTEM ==========

    // ========== FLASHCARD STATE ==========
    let currentFlashcards = [];
    let currentFlashcardIndex = 0;
    let currentFlashcard = null;
    let flashcardSession = null;

    // ========== FLASHCARD INITIALIZATION ==========
    function initializeAllFlashcards() {
      let changed = false;

      vocabularyApp.words.forEach(word => {
        // If word has no flashcard data, add it
        if (!word.flashcard_difficulty) {
          word.flashcard_difficulty = 'unseen';
          changed = true;
        }
        if (!word.flashcard_mastered) {
          word.flashcard_mastered = false;
          changed = true;
        }
        if (!word.flashcard_points) {
          word.flashcard_points = 0;
          changed = true;
        }
        if (!word.flashcard_review_count) {
          word.flashcard_review_count = 0;
          changed = true;
        }
      });

      // Save if anything changed
      if (changed) {
        saveToStorage();
      }

      // Update stats
      updateFlashcardStats();
    }

    // ========== LOAD FLASHCARDS ==========
    function loadFlashcards() {
      // Initialize flashcard properties for all words
      initializeAllFlashcards();

      const category = document.getElementById('flashcardCategory').value;
      const filter = document.getElementById('flashcardFilter').value;
      const sort = document.getElementById('flashcardSort').value;

      let filteredWords = vocabularyApp.words.filter(w => !w.is_deleted);

      // Category filter
      if (category !== 'all') {
        filteredWords = filteredWords.filter(w => w.category === category);
      }

      // Difficulty filter
      if (filter !== 'all') {
        switch (filter) {
          case 'unseen':
            filteredWords = filteredWords.filter(w =>
              !w.flashcard_difficulty || w.flashcard_difficulty === 'unseen'
            );
            break;

          case 'difficult':
            filteredWords = filteredWords.filter(w =>
              w.flashcard_difficulty === 'difficult' && !w.flashcard_mastered
            );
            break;

          case 'needs_review':
            filteredWords = filteredWords.filter(w => {
              // Show cards that are NOT mastered AND need review
              if (w.flashcard_mastered) return false;

              // Show if: unsure, good, or hasn't been rated yet
              return w.flashcard_difficulty === 'unsure' ||
                w.flashcard_difficulty === 'good' ||
                !w.flashcard_difficulty ||
                w.flashcard_difficulty === 'unseen';
            });
            break;

          case 'mastered':
            filteredWords = filteredWords.filter(w => w.flashcard_mastered);
            break;
        }
      }

      // Sorting
      switch (sort) {
        case 'random':
          filteredWords.sort(() => Math.random() - 0.5);
          break;
        case 'difficulty':
          // Sort by difficulty: unseen -> difficult -> unsure -> good -> easy
          const difficultyOrder = { 'unseen': 0, 'difficult': 1, 'unsure': 2, 'good': 3, 'easy': 4 };
          filteredWords.sort((a, b) => {
            const diffA = difficultyOrder[a.flashcard_difficulty || 'unseen'] || 0;
            const diffB = difficultyOrder[b.flashcard_difficulty || 'unseen'] || 0;
            return diffA - diffB;
          });
          break;
        case 'newest':
          filteredWords.sort((a, b) => new Date(b.added_date) - new Date(a.added_date));
          break;
        case 'oldest':
          filteredWords.sort((a, b) => new Date(a.added_date) - new Date(b.added_date));
          break;
        case 'alphabetical':
          filteredWords.sort((a, b) => a.word.localeCompare(b.word));
          break;
      }

      // Store current flashcard session
      currentFlashcards = filteredWords;
      currentFlashcardIndex = 0;

      // Update UI
      if (currentFlashcards.length === 0) {
        document.getElementById('flashcardEmptyState').style.display = 'block';
        document.getElementById('flashcardDisplay').style.display = 'none';
        document.getElementById('sessionSummary').style.display = 'none';

        // Update button states
        document.getElementById('prevBtn').disabled = true;
        document.getElementById('nextBtn').disabled = true;
      } else {
        document.getElementById('flashcardEmptyState').style.display = 'none';
        document.getElementById('flashcardDisplay').style.display = 'block';
        document.getElementById('sessionSummary').style.display = 'none';

        // Start new session
        startNewSession();

        // Load first card
        loadCurrentCard();
      }

      // Update stats
      updateFlashcardStats();
    }

    // ========== UPDATE FLASHCARD STATS ==========
    function updateFlashcardStats() {
      const allWords = vocabularyApp.words.filter(w => !w.is_deleted);

      let total = allWords.length;
      let mastered = 0;
      let review = 0;
      let difficult = 0;
      let totalPoints = 0;

      allWords.forEach(word => {
        // Count mastered
        if (word.flashcard_mastered) {
          mastered++;
        }

        // Count review needed (unsure + good)
        if (word.flashcard_difficulty === 'unsure' || word.flashcard_difficulty === 'good') {
          review++;
        }

        // Count difficult
        if (word.flashcard_difficulty === 'difficult') {
          difficult++;
        }

        // Add points
        totalPoints += (word.flashcard_points || 0);
      });

      // Update the numbers on screen
      document.getElementById('totalCardsCount').textContent = total;
      document.getElementById('masteredCount').textContent = mastered;
      document.getElementById('reviewCount').textContent = review;
      document.getElementById('difficultCount').textContent = difficult;

      // Update points in session
      if (document.getElementById('sessionScore')) {
        document.getElementById('sessionScore').textContent = totalPoints.toFixed(1);
      }

      // Update reset modal stats
      if (document.getElementById('resetTotalCards')) {
        document.getElementById('resetTotalCards').textContent = total;
        document.getElementById('resetMasteredCards').textContent = mastered;
        document.getElementById('resetTotalPoints').textContent = totalPoints.toFixed(1);
      }
    }

    // ========== RATE CARD FUNCTION ==========
    function rateCard(rating) {
      if (!currentFlashcard) {
        showMessage('No flashcard available', 'error');
        return;
      }

      // Find the word in our data
      const card = vocabularyApp.words.find(w => w.id === currentFlashcard.id);
      if (!card) {
        showMessage('Card not found', 'error');
        return;
      }

      // Calculate points
      let pointsEarned = 0;

      if (rating === 'easy') {
        card.flashcard_difficulty = 'easy';
        card.flashcard_mastered = true;
        card.flashcard_review_count = (card.flashcard_review_count || 0) + 1;
        pointsEarned = 1;
      }
      else if (rating === 'good') {
        card.flashcard_difficulty = 'good';
        card.flashcard_mastered = false;
        card.flashcard_review_count = (card.flashcard_review_count || 0) + 1;
        pointsEarned = 0.5;
      }
      else if (rating === 'unsure') {
        card.flashcard_difficulty = 'unsure';
        card.flashcard_mastered = false;
        card.flashcard_review_count = (card.flashcard_review_count || 0) + 1;
        pointsEarned = 0;
      }
      else if (rating === 'difficult') {
        card.flashcard_difficulty = 'difficult';
        card.flashcard_mastered = false;
        card.flashcard_review_count = (card.flashcard_review_count || 0) + 1;
        pointsEarned = 0;
      }

      // Add points
      card.flashcard_points = (card.flashcard_points || 0) + pointsEarned;

      // Save changes
      card.synced_to_server = false;
      saveToStorage();

      // Update session stats
      if (flashcardSession) {
        flashcardSession.score += pointsEarned;
        flashcardSession.cardsReviewed++;

        if (rating === 'easy') {
          flashcardSession.mastered++;
        } else if (rating === 'difficult') {
          flashcardSession.difficult++;
        } else if (rating === 'unsure' || rating === 'good') {
          flashcardSession.needsReview++;
        }

        // Update progress
        flashcardSession.currentIndex++;
        updateSessionProgress();
      }

      // Update stats NOW (not after refresh)
      updateFlashcardStats();

      // Show feedback message
      const messages = {
        'easy': 'Mastered! +1 point',
        'good': 'Good! +0.5 points',
        'unsure': 'Marked as unsure',
        'difficult': 'Marked as difficult'
      };

      showMessage(messages[rating], 'success');

      // Go to next card
      setTimeout(() => {
        nextCard();
      }, 800);
    }

    // ========== SESSION MANAGEMENT ==========
    function startNewSession() {
      if (currentFlashcards.length === 0) return;

      flashcardSession = {
        startTime: new Date(),
        totalCards: currentFlashcards.length,
        currentIndex: 0,
        cardsReviewed: 0,
        mastered: 0,
        needsReview: 0,
        difficult: 0,
        score: 0
      };

      updateSessionProgress();
    }

    function updateSessionProgress() {
      if (!flashcardSession) return;

      const progressPercent = (flashcardSession.currentIndex / flashcardSession.totalCards) * 100;
      const progressBar = document.getElementById('sessionProgressBar');
      if (progressBar) {
        progressBar.style.width = `${progressPercent}%`;
      }

      // Update card counter
      document.getElementById('currentCardNum').textContent = flashcardSession.currentIndex + 1;
      document.getElementById('totalSessionCards').textContent = flashcardSession.totalCards;

      // Update score
      document.getElementById('sessionScore').textContent = flashcardSession.score.toFixed(1);
    }

    function endSession() {
      if (!flashcardSession) return;

      // Calculate session duration
      const endTime = new Date();
      const durationMinutes = Math.round((endTime - flashcardSession.startTime) / 1000 / 60);

      // Update summary
      document.getElementById('summaryTotal').textContent = flashcardSession.cardsReviewed;
      document.getElementById('summaryMastered').textContent = flashcardSession.mastered;
      document.getElementById('summaryScore').textContent = flashcardSession.score.toFixed(1);
      document.getElementById('summaryTime').textContent = durationMinutes || '<1';

      // Calculate mastery percentage
      const totalWords = vocabularyApp.words.filter(w => !w.is_deleted).length;
      const masteredWords = vocabularyApp.words.filter(w => w.flashcard_mastered && !w.is_deleted).length;
      const masteryPercentage = totalWords > 0 ? Math.round((masteredWords / totalWords) * 100) : 0;

      document.getElementById('summaryPercentage').textContent = `${masteryPercentage}%`;

      // Update progress circle
      const circle = document.getElementById('summaryProgressCircle');
      if (circle) {
        const circumference = 2 * Math.PI * 54;
        const offset = circumference - (masteryPercentage / 100) * circumference;
        circle.style.strokeDashoffset = offset;
      }

      // Show summary, hide card display
      document.getElementById('flashcardDisplay').style.display = 'none';
      document.getElementById('sessionSummary').style.display = 'block';

      // Update review button text
      const reviewBtn = document.getElementById('reviewBtn');
      if (flashcardSession.difficult > 0) {
        reviewBtn.textContent = `Review Difficult (${flashcardSession.difficult})`;
      } else {
        reviewBtn.textContent = 'Review Difficult';
      }
    }

    // ========== CARD NAVIGATION ==========
    function loadCurrentCard() {
      if (currentFlashcards.length === 0 || currentFlashcardIndex >= currentFlashcards.length) {
        endSession();
        return;
      }

      currentFlashcard = currentFlashcards[currentFlashcardIndex];

      // Reset card to front side
      const flashcardElement = document.getElementById('flashcard');
      if (flashcardElement) {
        flashcardElement.classList.remove('flipped');
      }

      // Update card content
      document.getElementById('flashcardWord').textContent = currentFlashcard.word;

      // Set meaning text
      const meaningText = [];
      if (currentFlashcard.english) {
        meaningText.push(`<strong>English:</strong> ${currentFlashcard.english}`);
      }
      if (currentFlashcard.bangla) {
        meaningText.push(`<strong>Bangla:</strong> ${currentFlashcard.bangla}`);
      }
      document.getElementById('flashcardMeaning').innerHTML = meaningText.join('<br><br>') || 'No meaning available';

      // Show/hide synonyms
      const synonymsSection = document.getElementById('synonymsSection');
      const synonymsText = document.getElementById('flashcardSynonyms');
      if (currentFlashcard.synonyms) {
        synonymsSection.style.display = 'block';
        synonymsText.textContent = currentFlashcard.synonyms;
      } else {
        synonymsSection.style.display = 'none';
      }

      // Show/hide example
      const exampleSection = document.getElementById('exampleSection');
      const exampleText = document.getElementById('flashcardExample');
      if (currentFlashcard.example) {
        exampleSection.style.display = 'block';
        exampleText.textContent = currentFlashcard.example;
      } else {
        exampleSection.style.display = 'none';
      }

      // Update difficulty badge
      const difficultyBadge = document.getElementById('cardDifficulty');
      const difficulty = currentFlashcard.flashcard_difficulty || 'unseen';
      const difficultyLabels = {
        'unseen': 'New',
        'difficult': 'Difficult',
        'unsure': 'Unsure',
        'good': 'Good',
        'easy': 'Mastered'
      };

      difficultyBadge.textContent = difficultyLabels[difficulty] || 'New';

      // Update button states
      document.getElementById('prevBtn').disabled = currentFlashcardIndex === 0;
      document.getElementById('nextBtn').disabled = currentFlashcardIndex === currentFlashcards.length - 1;

      // Update favorite button
      const favoriteBtn = document.getElementById('favoriteBtn');
      if (currentFlashcard.is_favorite) {
        favoriteBtn.innerHTML = '<span class="material-icons-round" style="color: #ef4444;">favorite</span>';
      } else {
        favoriteBtn.innerHTML = '<span class="material-icons-round">favorite_border</span>';
      }

      // Update hint
      const cardHint = document.getElementById('cardHint');
      if (difficulty === 'unseen') {
        cardHint.textContent = 'This is a new word for you!';
      } else if (difficulty === 'easy') {
        cardHint.textContent = 'You\'ve mastered this word!';
      } else {
        cardHint.textContent = 'Rate your understanding to continue';
      }
    }

    function nextCard() {
      if (currentFlashcardIndex < currentFlashcards.length - 1) {
        currentFlashcardIndex++;
        loadCurrentCard();
      } else {
        endSession();
      }
    }

    function previousCard() {
      if (currentFlashcardIndex > 0) {
        currentFlashcardIndex--;
        loadCurrentCard();
      }
    }

    // ========== CARD INTERACTIONS ==========
    function flipCard() {
      const flashcard = document.getElementById('flashcard');
      if (flashcard) {
        flashcard.classList.toggle('flipped');
      }
    }


    function showHint(event) {
      if (event) {
        event.stopPropagation(); // Prevent card flip when clicking hint button
      }

      if (!currentFlashcard) return;

      // Get the elements
      const synonymsSection = document.getElementById('synonymsSection');
      const exampleSection = document.getElementById('exampleSection');
      const hintBtn = document.getElementById('showHintBtn') ||
        document.querySelector('.hint-btn') ||
        document.querySelector('.control-btn.hint-btn');
      const cardHint = document.getElementById('cardHint');

      // Toggle hint visibility
      const isHintsVisible = synonymsSection.style.display === 'block' ||
        exampleSection.style.display === 'block';

      if (!isHintsVisible) {
        // Show hints
        if (currentFlashcard.synonyms && currentFlashcard.synonyms.trim()) {
          synonymsSection.style.display = 'block';
        }
        if (currentFlashcard.example && currentFlashcard.example.trim()) {
          exampleSection.style.display = 'block';
        }

        // Update hint button text
        if (hintBtn) {
          const icon = hintBtn.querySelector('.material-icons-round');
          if (icon) {
            icon.textContent = 'lightbulb_outline';
          }
          const textSpan = hintBtn.querySelector('span:not(.material-icons-round)');
          if (textSpan) {
            textSpan.textContent = 'Hide Hints';
          }
        }

        if (cardHint) {
          cardHint.textContent = 'Hints are shown';
        }
      } else {
        // Hide hints
        synonymsSection.style.display = 'none';
        exampleSection.style.display = 'none';

        // Update hint button text
        if (hintBtn) {
          const icon = hintBtn.querySelector('.material-icons-round');
          if (icon) {
            icon.textContent = 'lightbulb';
          }
          const textSpan = hintBtn.querySelector('span:not(.material-icons-round)');
          if (textSpan) {
            textSpan.textContent = 'Show Hints';
          }
        }

        if (cardHint) {
          cardHint.textContent = 'Rate your understanding to continue';
        }
      }
    }





    function toggleFavorite() {
      if (!currentFlashcard) return;

      const card = vocabularyApp.words.find(w => w.id === currentFlashcard.id);
      if (card) {
        card.is_favorite = !card.is_favorite;
        card.synced_to_server = false;
        saveToStorage();

        // Update button icon
        const favoriteBtn = document.getElementById('favoriteBtn');
        if (card.is_favorite) {
          favoriteBtn.innerHTML = '<span class="material-icons-round" style="color: #ef4444;">favorite</span>';
          showMessage('Added to favorites', 'success');
        } else {
          favoriteBtn.innerHTML = '<span class="material-icons-round">favorite_border</span>';
          showMessage('Removed from favorites', 'info');
        }
      }
    }

    function pronounceCurrentWord() {
      if (!currentFlashcard) return;

      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(currentFlashcard.word);
        utterance.lang = 'en-US';
        utterance.rate = 0.8;
        utterance.pitch = 1;

        const voices = speechSynthesis.getVoices();
        if (voices.length > 0) {
          const usVoice = voices.find(v => v.lang.includes('en-US'));
          if (usVoice) utterance.voice = usVoice;
        }

        speechSynthesis.speak(utterance);
        showMessage(`Pronouncing: ${currentFlashcard.word}`, 'info');
      } else {
        showMessage('Text-to-speech not supported', 'error');
      }
    }

    // ========== FLASHCARD ACTIONS ==========
    function shuffleFlashcards() {
      if (currentFlashcards.length === 0) return;

      // Shuffle current flashcards
      for (let i = currentFlashcards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [currentFlashcards[i], currentFlashcards[j]] = [currentFlashcards[j], currentFlashcards[i]];
      }

      // Reset to first card
      currentFlashcardIndex = 0;
      loadCurrentCard();

      showMessage('Flashcards shuffled', 'success');
    }

    function reviewDifficultCards() {
      // Set filter to difficult
      document.getElementById('flashcardFilter').value = 'difficult';

      // Reload flashcards
      loadFlashcards();
    }

    function continueSession() {
      document.getElementById('sessionSummary').style.display = 'none';
      document.getElementById('flashcardDisplay').style.display = 'block';
      loadCurrentCard();
    }

    // ========== RESET PROGRESS ==========
    function showResetConfirmation() {
      // Show modal
      document.getElementById('resetModal').classList.add('active');
    }

    function confirmResetProgress() {
      // Reset all flashcard progress
      vocabularyApp.words.forEach(word => {
        word.flashcard_difficulty = 'unseen';
        word.flashcard_mastered = false;
        word.flashcard_points = 0;
        word.flashcard_review_count = 0;
        word.synced_to_server = false;
      });

      // Save changes
      saveToStorage();

      // Update UI
      updateFlashcardStats();

      // Reload current flashcards
      if (document.getElementById('flashcards-tab').classList.contains('active')) {
        loadFlashcards();
      }

      // Close modal
      closeResetModal();

      showMessage('All flashcard progress has been reset', 'success');
    }

    function closeResetModal() {
      document.getElementById('resetModal').classList.remove('active');
    }

    // ========== INITIALIZE FLASHCARD CATEGORIES ==========
    function initializeFlashcardCategories() {
      const flashcardCategorySelect = document.getElementById('flashcardCategory');
      if (!flashcardCategorySelect) return;

      flashcardCategorySelect.innerHTML = '<option value="all">All Categories</option>';

      vocabularyApp.categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        flashcardCategorySelect.appendChild(option);
      });
    }


















    // Update initializeFlashcards to include modal setup
    function initializeFlashcards() {
      console.log('🃏 Initializing modern flashcard system...');

      // Update category select
      updateFlashcardCategories();

      // Load flashcard stats
      loadFlashcardStats();

      // Setup event listeners
      setupFlashcardEventListeners();

      // Setup modal event listeners
      setupModalEventListeners();

      // Load initial cards
      loadFlashcards();

      console.log('✅ Flashcard system initialized');
    }








    // ========== GLOBAL FUNCTION EXPORTS ==========

    // Make functions available globally
    window.showResetConfirmation = showResetConfirmation;
    window.closeResetModal = closeResetModal;
    window.confirmResetProgress = confirmResetProgress;
    window.shuffleFlashcards = shuffleFlashcards;


















    //Switch Tab------------------------------------------------
    // Update the tab switching function to properly initialize quiz
    function switchTab(tabName) {
      document.querySelectorAll('.app-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      event.currentTarget.classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');

      if (tabName === 'view') {
        loadWords();
      } else if (tabName === 'flashcards') {
        setTimeout(() => {
          if (typeof initializeFlashcardTab === 'function') {
            initializeFlashcardTab();
          }
        }, 100);
      } else if (tabName === 'quiz') {
        initializeQuiz();
      } else if (tabName === 'sync') {
        updateStats();
        updateWordCounts();
        checkServerConnection();
      }
    }
















    // ========== MODERN QUIZ SYSTEM - COMPLETE WORKING VERSION ==========

    // Global quiz variables
    let quizQuestions = [];
    let currentQuestionIndex = 0;
    let quizScore = 0;
    let currentQuizType = '';
    let quizTimer = null;
    let timeLeft = 0;
    let quizConfig = {
      questionCount: 10,
      timePerQuestion: 60,
      difficulty: 'medium'
    };
    let quizResults = []; // Track correct/incorrect answers

    // Initialize quiz system
    function initializeQuiz() {
      console.log('🚀 Initializing modern quiz system...');

      // Update date display
      updateQuizDate();

      // Load configuration
      loadQuizConfig();

      // Setup UI event listeners
      setupQuizEventListeners();

      // Load statistics and word counts
      loadQuizStats();
      updateWordCountsDisplay();

      // Load quiz history
      loadQuizHistory();

      // Check daily challenge status
      checkDailyChallenge();

      console.log('✅ Quiz system initialized');
    }

    // Update quiz date display
    function updateQuizDate() {
      const today = new Date();
      const dateString = today.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      const dateElement = document.getElementById('quizDate');
      if (dateElement) {
        dateElement.textContent = dateString;
      }
    }

    // Setup UI event listeners
    function setupQuizEventListeners() {
      // Question count slider
      const questionSlider = document.getElementById('questionCount');
      const questionValue = document.getElementById('questionCountValue');

      if (questionSlider && questionValue) {
        // Set initial value display
        questionValue.textContent = questionSlider.value;

        // Add input event listener
        questionSlider.addEventListener('input', function () {
          questionValue.textContent = this.value;
          quizConfig.questionCount = parseInt(this.value);
          saveQuizConfig();
          updateWordCountsDisplay(); // Update counts since question count changed
        });
      }

      // Time per question selector
      const timeSelect = document.getElementById('timePerQuestion');
      if (timeSelect) {
        timeSelect.addEventListener('change', function () {
          quizConfig.timePerQuestion = parseInt(this.value);
          saveQuizConfig();
        });
      }

      // Difficulty selector
      const difficultySelect = document.getElementById('difficultyLevel');
      if (difficultySelect) {
        difficultySelect.addEventListener('change', function () {
          quizConfig.difficulty = this.value;
          saveQuizConfig();
        });
      }
    }

    // Load quiz configuration
    function loadQuizConfig() {
      const savedConfig = localStorage.getItem('quiz_config');
      if (savedConfig) {
        try {
          quizConfig = JSON.parse(savedConfig);

          // Update UI elements with loaded config
          const questionSlider = document.getElementById('questionCount');
          const questionValue = document.getElementById('questionCountValue');
          const timeSelect = document.getElementById('timePerQuestion');
          const difficultySelect = document.getElementById('difficultyLevel');

          if (questionSlider && questionValue) {
            questionSlider.value = quizConfig.questionCount;
            questionValue.textContent = quizConfig.questionCount;
          }

          if (timeSelect) {
            timeSelect.value = quizConfig.timePerQuestion;
          }

          if (difficultySelect) {
            difficultySelect.value = quizConfig.difficulty;
          }

          console.log('✅ Loaded quiz config:', quizConfig);
        } catch (error) {
          console.error('❌ Error loading quiz config:', error);
          // Reset to defaults
          quizConfig = {
            questionCount: 10,
            timePerQuestion: 60,
            difficulty: 'medium'
          };
        }
      }
    }

    // Save quiz configuration
    function saveQuizConfig() {
      try {
        localStorage.setItem('quiz_config', JSON.stringify(quizConfig));
        console.log('💾 Saved quiz config');
      } catch (error) {
        console.error('❌ Error saving quiz config:', error);
      }
    }

    // Update word counts display
    function updateWordCountsDisplay() {
      const totalWords = vocabularyApp.words.filter(w => !w.is_deleted).length;
      const difficultWords = vocabularyApp.words.filter(w =>
        !w.is_deleted && w.difficulty === 'hard'
      ).length;
      const categoriesCount = vocabularyApp.categories.length;

      // Update displays
      const allWordsElement = document.getElementById('allWordsCount');
      const difficultWordsElement = document.getElementById('difficultWordsCount');
      const categoriesElement = document.getElementById('categoriesCount');
      const randomWordsElement = document.getElementById('randomWordsCount');

      if (allWordsElement) {
        allWordsElement.textContent = `${totalWords} words`;
      }

      if (difficultWordsElement) {
        difficultWordsElement.textContent = `${difficultWords} words`;
      }

      if (categoriesElement) {
        categoriesElement.textContent = `${categoriesCount} categories`;
      }

      if (randomWordsElement) {
        // Calculate random words count (5-10 or available words)
        const randomCount = Math.min(10, Math.max(5, totalWords));
        randomWordsElement.textContent = `${Math.min(quizConfig.questionCount, randomCount)} random`;
      }
    }

    // Start quiz
    function startQuiz(type, category = null) {
      console.log(`🎯 Starting ${type} quiz${category ? ' for category: ' + category : ''}`);

      currentQuizType = type;

      // Hide main quiz UI, show quiz area
      document.querySelector('.quiz-container').style.display = 'none';
      document.getElementById('quizArea').style.display = 'block';
      document.getElementById('quizResults').style.display = 'none';

      // Reset quiz variables
      quizQuestions = [];
      currentQuestionIndex = 0;
      quizScore = 0;
      quizResults = [];

      // Generate questions
      quizQuestions = generateQuizQuestions(type, category);

      if (quizQuestions.length === 0) {
        showMessage('Not enough words to start a quiz. Please add more words first!', 'warning');
        showQuizMain();
        return;
      }

      console.log(`✅ Generated ${quizQuestions.length} questions`);

      // Start the quiz
      showQuestion(currentQuestionIndex);

      // Start timer if enabled
      if (quizConfig.timePerQuestion > 0) {
        startTimer();
      }
    }

    // Generate quiz questions
    function generateQuizQuestions(type, category = null) {
      console.log(`📝 Generating questions for type: ${type}, category: ${category}`);

      // Get available words
      let availableWords = vocabularyApp.words.filter(word =>
        !word.is_deleted &&
        word.word &&
        word.word.trim() &&
        (word.bangla || word.english)
      );

      // Filter by category if specified
      if (category) {
        availableWords = availableWords.filter(word => word.category === category);
      }

      if (availableWords.length === 0) {
        console.log('❌ No words available');
        return [];
      }

      // Filter by type
      switch (type) {
        case 'difficult':
          availableWords = availableWords.filter(word => word.difficulty === 'hard');
          break;
        case 'random':
          // Shuffle for random selection
          availableWords = availableWords.sort(() => Math.random() - 0.5);
          break;
        case 'all':
          // Already have all words
          break;
      }

      // Limit question count based on config
      const questionCount = Math.min(quizConfig.questionCount, availableWords.length);
      const selectedWords = availableWords.slice(0, questionCount);

      console.log(`📊 Selected ${selectedWords.length} words from ${availableWords.length} available`);

      // Generate questions for each word
      const questions = [];

      selectedWords.forEach((word, index) => {
        const question = generateQuestionForWord(word, index);
        if (question) {
          questions.push(question);
        }
      });

      return questions;
    }

    // Generate a question for a specific word
    function generateQuestionForWord(word, index) {
      // Determine question type based on available data and difficulty
      const availableTypes = [];

      if (word.bangla) availableTypes.push('meaning_bangla');
      if (word.english) availableTypes.push('meaning_english');
      if (word.synonyms && word.synonyms.trim()) availableTypes.push('synonym');
      if (word.example && word.example.trim()) availableTypes.push('example');

      if (availableTypes.length === 0) return null;

      // Select question type based on difficulty
      let selectedType;
      switch (quizConfig.difficulty) {
        case 'easy':
          // Prefer meaning questions for easy difficulty
          selectedType = availableTypes.find(t => t.includes('meaning')) || availableTypes[0];
          break;
        case 'hard':
          // Prefer example/synonym for hard difficulty
          selectedType = availableTypes.find(t => t === 'example' || t === 'synonym') || availableTypes[0];
          break;
        default: // medium
          selectedType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
      }

      let question = null;

      switch (selectedType) {
        case 'meaning_bangla':
          question = createMeaningQuestion(word, 'bangla', index);
          break;
        case 'meaning_english':
          question = createMeaningQuestion(word, 'english', index);
          break;
        case 'synonym':
          question = createSynonymQuestion(word, index);
          break;
        case 'example':
          question = createExampleQuestion(word, index);
          break;
      }

      return question;
    }

    // Create meaning question
    function createMeaningQuestion(word, language, index) {
      const isBangla = language === 'bangla';
      const correctAnswer = isBangla ? word.bangla : word.english;

      if (!correctAnswer || correctAnswer.trim() === '') return null;

      const questionText = isBangla
        ? `What is the Bangla meaning of "${word.word}"?`
        : `What is the English meaning of "${word.word}"?`;

      // Get other words for wrong answers
      const otherWords = vocabularyApp.words.filter(w =>
        w.id !== word.id &&
        !w.is_deleted &&
        (isBangla ? w.bangla && w.bangla.trim() : w.english && w.english.trim())
      ).sort(() => Math.random() - 0.5).slice(0, 3);

      const options = [correctAnswer];
      otherWords.forEach(w => {
        const answer = isBangla ? w.bangla : w.english;
        if (answer && answer.trim() && !options.includes(answer)) {
          options.push(answer);
        }
      });

      // Fill with generic options if needed
      while (options.length < 4) {
        const genericOption = `Meaning ${options.length + 1}`;
        if (!options.includes(genericOption)) {
          options.push(genericOption);
        }
      }

      // Shuffle options
      options.sort(() => Math.random() - 0.5);

      return {
        id: `q${index}_${word.id}`,
        type: 'meaning',
        language: language,
        question: questionText,
        correctAnswer: correctAnswer,
        options: options,
        word: word.word,
        points: 10,
        wordData: word
      };
    }

    // Create synonym question
    function createSynonymQuestion(word, index) {
      if (!word.synonyms || word.synonyms.trim() === '') return null;

      const synonyms = word.synonyms.split(',').map(s => s.trim()).filter(s => s);
      if (synonyms.length === 0) return null;

      const correctAnswer = synonyms[0];

      // Get synonyms from other words
      let allSynonyms = [];
      vocabularyApp.words.forEach(w => {
        if (w.id !== word.id && w.synonyms && w.synonyms.trim()) {
          const otherSynonyms = w.synonyms.split(',').map(s => s.trim()).filter(s => s);
          otherSynonyms.forEach(syn => {
            if (syn !== correctAnswer && !allSynonyms.includes(syn)) {
              allSynonyms.push(syn);
            }
          });
        }
      });

      const options = [correctAnswer];
      allSynonyms.sort(() => Math.random() - 0.5).slice(0, 3).forEach(syn => {
        options.push(syn);
      });

      // Fill with generic options if needed
      while (options.length < 4) {
        const genericOption = `Synonym ${options.length + 1}`;
        if (!options.includes(genericOption)) {
          options.push(genericOption);
        }
      }

      options.sort(() => Math.random() - 0.5);

      return {
        id: `q${index}_${word.id}`,
        type: 'synonym',
        question: `Which is a synonym of "${word.word}"?`,
        correctAnswer: correctAnswer,
        options: options,
        word: word.word,
        points: 15,
        wordData: word
      };
    }

    // Create example question
    function createExampleQuestion(word, index) {
      if (!word.example || word.example.trim() === '') return null;

      // Create blank in example
      const example = word.example;
      const wordInExample = word.word;
      const regex = new RegExp(wordInExample.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      const blankedExample = example.replace(regex, '__________');

      const correctAnswer = word.word;

      // Get other words for options
      const otherWords = vocabularyApp.words.filter(w =>
        w.id !== word.id &&
        w.word &&
        w.word.trim() &&
        w.word !== correctAnswer
      ).sort(() => Math.random() - 0.5).slice(0, 3);

      const options = [correctAnswer];
      otherWords.forEach(w => {
        if (w.word && w.word.trim() && !options.includes(w.word)) {
          options.push(w.word);
        }
      });

      // Fill with generic options if needed
      while (options.length < 4) {
        const genericOption = `Word ${options.length + 1}`;
        if (!options.includes(genericOption)) {
          options.push(genericOption);
        }
      }

      options.sort(() => Math.random() - 0.5);

      return {
        id: `q${index}_${word.id}`,
        type: 'example',
        question: `Complete the sentence: "${blankedExample}"`,
        correctAnswer: correctAnswer,
        options: options,
        word: word.word,
        points: 20,
        wordData: word
      };
    }

    // Show question
    function showQuestion(index) {
      if (index >= quizQuestions.length) {
        finishQuiz();
        return;
      }

      const question = quizQuestions[index];
      const progressPercent = ((index + 1) / quizQuestions.length) * 100;

      // Build HTML for the question
      const html = `
    <div class="quiz-header">
      <div>
        <h3>Vocabulary Quiz</h3>
        <div class="question-number">Question ${index + 1} of ${quizQuestions.length}</div>
      </div>
      ${quizConfig.timePerQuestion > 0 ? `
      <div class="quiz-timer">
        <span class="material-icons-round">timer</span>
        <div class="timer-value" id="timerValue">${timeLeft}</div>
      </div>
      ` : ''}
    </div>
    
    <div class="question-container">
      <div class="question-text">${question.question}</div>
      <div class="options-grid" id="optionsGrid">
        ${question.options.map((option, i) => `
          <button class="option-button" onclick="handleAnswerSelection(${i}, '${escapeString(option)}')">
            <div class="option-letter">${String.fromCharCode(65 + i)}</div>
            <div class="option-text">${option}</div>
          </button>
        `).join('')}
      </div>
    </div>
    
    <div class="quiz-footer">
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progressPercent}%"></div>
        </div>
        <div class="progress-text">Score: <strong>${quizScore}</strong> points • Progress: ${index + 1}/${quizQuestions.length}</div>
      </div>

     <button class="btn btn-secondary" onclick="cancelQuiz()">
  <span class="material-icons-round">close</span>
  Cancel Quiz
</button>
    </div>
  `;

      document.getElementById('quizArea').innerHTML = html;

      // Reset and start timer if enabled
      if (quizConfig.timePerQuestion > 0) {
        resetTimer();
        startTimer();
      }
    }

    // Escape string for HTML
    function escapeString(str) {
      return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    // Handle answer selection
    function handleAnswerSelection(selectedIndex, selectedAnswer) {
      const question = quizQuestions[currentQuestionIndex];
      const isCorrect = selectedAnswer === question.correctAnswer;

      // Clear timer
      if (quizTimer) {
        clearInterval(quizTimer);
        quizTimer = null;
      }

      // Store result
      quizResults.push({
        questionId: question.id,
        question: question.question,
        selectedAnswer: selectedAnswer,
        correctAnswer: question.correctAnswer,
        isCorrect: isCorrect,
        points: isCorrect ? question.points : 0
      });

      // Disable all options
      const optionButtons = document.querySelectorAll('.option-button');
      optionButtons.forEach(btn => {
        btn.disabled = true;
        btn.style.cursor = 'not-allowed';
      });

      // Highlight correct and incorrect answers
      optionButtons.forEach((btn, index) => {
        const optionText = btn.querySelector('.option-text').textContent;

        if (optionText === question.correctAnswer) {
          btn.classList.add('correct');
        } else if (index === selectedIndex && !isCorrect) {
          btn.classList.add('incorrect');
        }
      });

      // Update score
      if (isCorrect) {
        quizScore += question.points;
      }

      // Show feedback
      showAnswerFeedback(isCorrect, question.correctAnswer);

      // Move to next question after delay
      setTimeout(() => {
        currentQuestionIndex++;
        if (currentQuestionIndex < quizQuestions.length) {
          showQuestion(currentQuestionIndex);
        } else {
          finishQuiz();
        }
      }, 2000);
    }

    // Show answer feedback
    function showAnswerFeedback(isCorrect, correctAnswer) {
      const feedback = document.createElement('div');
      feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
      feedback.innerHTML = `
    <div style="padding: 20px; border-radius: 12px; margin: 20px 0; background: ${isCorrect ? '#d1fae5' : '#fee2e2'}; border: 2px solid ${isCorrect ? '#10b981' : '#ef4444'};">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span class="material-icons-round" style="color: ${isCorrect ? '#10b981' : '#ef4444'};">${isCorrect ? 'check_circle' : 'error'}</span>
        <div>
          <div style="font-weight: 600; color: ${isCorrect ? '#065f46' : '#991b1b'}">
            ${isCorrect ? 'Correct! +10 points' : 'Incorrect!'}
          </div>
          ${!isCorrect ? `<div style="color: #991b1b; font-size: 14px; margin-top: 4px;">Correct answer: ${correctAnswer}</div>` : ''}
        </div>
      </div>
    </div>
  `;

      const questionContainer = document.querySelector('.question-container');
      if (questionContainer) {
        questionContainer.appendChild(feedback);
      }
    }

    // Timer functions
    function startTimer() {
      if (quizConfig.timePerQuestion > 0 && !quizTimer) {
        quizTimer = setInterval(updateTimer, 1000);
      }
    }

    function resetTimer() {
      if (quizTimer) {
        clearInterval(quizTimer);
        quizTimer = null;
      }
      timeLeft = quizConfig.timePerQuestion;
      updateTimerDisplay();
    }

    function updateTimer() {
      timeLeft--;
      updateTimerDisplay();

      if (timeLeft <= 0) {
        clearInterval(quizTimer);
        quizTimer = null;
        // Auto-submit with no answer (wrong)
        handleTimeUp();
      }
    }

    function updateTimerDisplay() {
      const timerElement = document.getElementById('timerValue');
      if (timerElement) {
        timerElement.textContent = timeLeft;

        // Change color based on time remaining
        if (timeLeft <= 10) {
          timerElement.style.color = '#ef4444';
        } else if (timeLeft <= 30) {
          timerElement.style.color = '#f59e0b';
        } else {
          timerElement.style.color = 'var(--primary)';
        }
      }
    }

    function handleTimeUp() {
      // Auto-select no answer (wrong)
      const question = quizQuestions[currentQuestionIndex];

      // Store result as incorrect due to timeout
      quizResults.push({
        questionId: question.id,
        question: question.question,
        selectedAnswer: null,
        correctAnswer: question.correctAnswer,
        isCorrect: false,
        points: 0,
        timedOut: true
      });

      // Show timeout message
      const timeoutFeedback = document.createElement('div');
      timeoutFeedback.className = 'feedback incorrect';
      timeoutFeedback.innerHTML = `
    <div style="padding: 20px; border-radius: 12px; margin: 20px 0; background: #fee2e2; border: 2px solid #ef4444;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span class="material-icons-round" style="color: #ef4444;">timer_off</span>
        <div>
          <div style="font-weight: 600; color: #991b1b">Time's up!</div>
          <div style="color: #991b1b; font-size: 14px; margin-top: 4px;">Correct answer: ${question.correctAnswer}</div>
        </div>
      </div>
    </div>
  `;

      const questionContainer = document.querySelector('.question-container');
      if (questionContainer) {
        questionContainer.appendChild(timeoutFeedback);
      }

      // Disable all buttons
      const optionButtons = document.querySelectorAll('.option-button');
      optionButtons.forEach(btn => {
        btn.disabled = true;
        btn.style.cursor = 'not-allowed';
      });

      // Highlight correct answer
      optionButtons.forEach(btn => {
        const optionText = btn.querySelector('.option-text').textContent;
        if (optionText === question.correctAnswer) {
          btn.classList.add('correct');
        }
      });

      // Move to next question after delay
      setTimeout(() => {
        currentQuestionIndex++;
        if (currentQuestionIndex < quizQuestions.length) {
          showQuestion(currentQuestionIndex);
        } else {
          finishQuiz();
        }
      }, 2000);
    }

    // Finish quiz
    function finishQuiz() {
      console.log('🏁 Finishing quiz...');

      // Clear timer
      resetTimer();

      // Calculate results
      const totalPossibleScore = quizQuestions.reduce((sum, q) => sum + q.points, 0);
      const scorePercentage = totalPossibleScore > 0 ? Math.round((quizScore / totalPossibleScore) * 100) : 0;
      const correctAnswers = quizResults.filter(r => r.isCorrect).length;
      const totalTime = quizConfig.timePerQuestion * quizQuestions.length;

      console.log(`📊 Results: ${correctAnswers}/${quizQuestions.length} correct, Score: ${scorePercentage}%`);

      // Save results to local storage
      saveQuizResultsToLocal(scorePercentage, correctAnswers, totalTime);

      // Save results to server if online
      saveQuizResultsToServer(scorePercentage, correctAnswers);

      // Show results
      showResults(scorePercentage, correctAnswers, totalPossibleScore, totalTime);
    }

    // Save quiz results to local storage
    function saveQuizResultsToLocal(scorePercentage, correctAnswers, totalTime) {
      try {
        // Load existing stats
        let stats = JSON.parse(localStorage.getItem('quiz_stats')) || {
          streak: 0,
          totalQuizzes: 0,
          totalScore: 0,
          bestScore: 0,
          totalCorrect: 0,
          totalQuestions: 0,
          lastQuizDate: null,
          totalTime: 0
        };

        const today = new Date().toISOString().split('T')[0];
        const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

        // Update streak
        if (stats.lastQuizDate === yesterday) {
          // Quizzed yesterday, increase streak
          stats.streak = (stats.streak || 0) + 1;
        } else if (stats.lastQuizDate !== today) {
          // First quiz today or broken streak
          stats.streak = 1;
        }

        // Update stats
        stats.lastQuizDate = today;
        stats.totalQuizzes = (stats.totalQuizzes || 0) + 1;
        stats.totalScore = (stats.totalScore || 0) + scorePercentage;
        stats.totalCorrect = (stats.totalCorrect || 0) + correctAnswers;
        stats.totalQuestions = (stats.totalQuestions || 0) + quizQuestions.length;
        stats.totalTime = (stats.totalTime || 0) + totalTime;

        if (scorePercentage > stats.bestScore) {
          stats.bestScore = scorePercentage;
        }

        // Save stats
        localStorage.setItem('quiz_stats', JSON.stringify(stats));

        // Save to history
        let history = JSON.parse(localStorage.getItem('quiz_history')) || [];
        history.unshift({
          id: 'quiz_' + Date.now(),
          date: new Date().toISOString(),
          type: currentQuizType,
          score: scorePercentage,
          questions: quizQuestions.length,
          correct: correctAnswers,
          points: quizScore,
          time: totalTime,
          results: quizResults
        });

        // Keep only last 20 quizzes
        if (history.length > 20) {
          history = history.slice(0, 20);
        }

        localStorage.setItem('quiz_history', JSON.stringify(history));

        console.log('💾 Saved quiz results to local storage');

      } catch (error) {
        console.error('❌ Error saving quiz results to local storage:', error);
      }
    }

    // Save quiz results to server
    async function saveQuizResultsToServer(scorePercentage, correctAnswers) {
      if (!vocabularyApp.serverOnline) {
        console.log('🌐 Server offline, skipping server save');
        return;
      }

      try {
        const quizData = {
          device_id: DEVICE_ID,
          device_name: DEVICE_NAME,
          quiz_type: currentQuizType,
          score: scorePercentage,
          questions: quizQuestions.length,
          correct: correctAnswers,
          points: quizScore,
          time_spent: quizConfig.timePerQuestion * quizQuestions.length,
          date: new Date().toISOString(),
          details: {
            config: quizConfig,
            results: quizResults
          }
        };

        const response = await fetch(`${SERVER_URL}/api/save_quiz_result`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(quizData)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('✅ Quiz results saved to server:', result);
          showMessage('Quiz results synced with server!', 'success');
        } else {
          console.log('⚠️ Server save failed, but results saved locally');
        }
      } catch (error) {
        console.error('❌ Error saving quiz results to server:', error);
        // Don't show error to user, local save is sufficient
      }
    }

    // Show results
    function showResults(scorePercentage, correctAnswers, totalPossibleScore, totalTime) {
      // Calculate performance rating
      let performance = '';
      let performanceColor = '';
      let performanceIcon = '';

      if (scorePercentage >= 90) {
        performance = 'Excellent!';
        performanceColor = '#10b981';
        performanceIcon = 'emoji_events';
      } else if (scorePercentage >= 70) {
        performance = 'Good Job!';
        performanceColor = '#3b82f6';
        performanceIcon = 'thumb_up';
      } else if (scorePercentage >= 50) {
        performance = 'Not Bad!';
        performanceColor = '#f59e0b';
        performanceIcon = 'sentiment_satisfied';
      } else {
        performance = 'Keep Practicing!';
        performanceColor = '#ef4444';
        performanceIcon = 'sentiment_dissatisfied';
      }

      const resultsHTML = `
    <div class="results-header">
      <div class="results-icon" style="background: linear-gradient(135deg, ${performanceColor} 0%, ${performanceColor}99 100%);">
        <span class="material-icons-round">${performanceIcon}</span>
      </div>
      <h2 class="results-title">${performance}</h2>
      <p class="results-subtitle">You've completed the ${currentQuizType} quiz</p>
    </div>
    
    <div class="results-stats">
      <div class="result-stat">
        <div class="result-value" style="color: ${performanceColor}">${scorePercentage}%</div>
        <div class="result-label">Score</div>
      </div>
      <div class="result-stat">
        <div class="result-value">${correctAnswers}/${quizQuestions.length}</div>
        <div class="result-label">Correct</div>
      </div>
      <div class="result-stat">
        <div class="result-value">${quizScore}</div>
        <div class="result-label">Points</div>
      </div>
      <div class="result-stat">
        <div class="result-value">${Math.round(totalTime / 60)}m</div>
        <div class="result-label">Time</div>
      </div>
    </div>
    
    <div class="results-breakdown">
      <h3 class="breakdown-title">
        <span class="material-icons-round">analytics</span>
        Question Breakdown
      </h3>
      ${quizResults.map((result, i) => `
        <div class="breakdown-item">
          <div class="question-status ${result.isCorrect ? 'correct' : 'incorrect'}">
            ${result.isCorrect ? '✓' : '✗'}
          </div>
          <div style="flex: 1;">
            <div style="font-weight: 500; color: var(--dark);">${result.question}</div>
            <div style="font-size: 14px; color: var(--gray); margin-top: 4px;">
              ${result.isCorrect ?
          `Your answer: <strong style="color: #10b981;">${result.selectedAnswer}</strong>` :
          `Your answer: <strong style="color: #ef4444;">${result.selectedAnswer || 'No answer'}</strong><br>
                 Correct: <strong style="color: #10b981;">${result.correctAnswer}</strong>`
        }
              ${result.timedOut ? ' <span style="color: #f59e0b;">(Time out)</span>' : ''}
            </div>
          </div>
        </div>
      `).join('')}
    </div>
    
    <div class="results-actions">
      <button class="btn btn-primary" onclick="retryQuiz()">
        <span class="material-icons-round">replay</span>
        Try Again
      </button>
      <button class="btn btn-secondary" onclick="showQuizMain()">
        <span class="material-icons-round">home</span>
        Back to Quizzes
      </button>
      <button class="btn btn-success" onclick="shareResults()">
        <span class="material-icons-round">share</span>
        Share Results
      </button>
    </div>
  `;

      document.getElementById('quizArea').style.display = 'none';
      document.getElementById('quizResults').innerHTML = resultsHTML;
      document.getElementById('quizResults').style.display = 'block';

      // Update statistics display
      loadQuizStats();
      loadQuizHistory();
      checkDailyChallenge();
    }

    // Retry quiz
    function retryQuiz() {
      startQuiz(currentQuizType);
    }

    // Share results
    function shareResults() {
      const score = quizScore;
      const percentage = Math.round((quizResults.filter(r => r.isCorrect).length / quizQuestions.length) * 100);
      const message = `I scored ${score} points (${percentage}%) on the ${currentQuizType} vocabulary quiz! 🎯`;

      if (navigator.share) {
        navigator.share({
          title: 'Vocabulary Quiz Results',
          text: message,
          url: window.location.href
        }).catch(err => {
          console.log('Share cancelled:', err);
          copyToClipboard(message);
        });
      } else {
        copyToClipboard(message);
      }
    }

    // Copy to clipboard
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showMessage('Results copied to clipboard!', 'success');
      }).catch(err => {
        console.error('Failed to copy:', err);
        showMessage('Failed to copy results', 'error');
      });
    }

    // Cancel quiz with enhanced modal
    function cancelQuiz() {
      // Calculate progress data
      const completedQuestions = currentQuestionIndex;
      const timeSpent = quizConfig.timePerQuestion > 0 ?
        Math.round(((quizConfig.timePerQuestion * completedQuestions) - timeLeft) / 60) :
        Math.round((quizConfig.timePerQuestion * completedQuestions) / 60);

      // Update modal content
      document.getElementById('completedQuestions').textContent = completedQuestions;
      document.getElementById('currentScore').textContent = quizScore;
      document.getElementById('timeSpent').textContent = timeSpent || 0;

      // Show the cancel modal
      document.getElementById('cancelQuizModal').classList.add('active');
    }

    // Close cancel modal
    function closeCancelModal() {
      document.getElementById('cancelQuizModal').classList.remove('active');
    }

    // Confirm cancel quiz
    function confirmCancelQuiz() {
      // Close the modal
      closeCancelModal();

      // Show confirmation message
      showMessage('Quiz cancelled. Your progress has been lost.', 'warning');

      // Return to main quiz screen
      setTimeout(() => {
        showQuizMain();
      }, 1000);
    }

    // Also update the cancel button in the quiz to use the new function:
    // In your showQuestion function, change this line:
    // From: <button class="btn btn-secondary" onclick="cancelQuiz()">
    // To: <button class="btn btn-secondary" onclick="showCancelConfirmation()">

    // Or keep it as cancelQuiz() since we're replacing that function





    // Show main quiz UI
    function showQuizMain() {
      document.getElementById('quizArea').style.display = 'none';
      document.getElementById('quizResults').style.display = 'none';
      document.querySelector('.quiz-container').style.display = 'block';

      // Refresh stats when returning to main
      loadQuizStats();
      loadQuizHistory();
      updateWordCountsDisplay();
      checkDailyChallenge();
    }

    // Load quiz statistics
    function loadQuizStats() {
      try {
        const stats = JSON.parse(localStorage.getItem('quiz_stats')) || {
          streak: 0,
          totalQuizzes: 0,
          totalScore: 0,
          bestScore: 0,
          totalCorrect: 0,
          totalQuestions: 0
        };

        // Update UI elements
        document.getElementById('streakCount').textContent = stats.streak || 0;
        document.getElementById('totalQuizzes').textContent = stats.totalQuizzes || 0;

        const averageScore = stats.totalQuizzes > 0 ?
          Math.round(stats.totalScore / stats.totalQuizzes) : 0;
        document.getElementById('averageScore').textContent = `${averageScore}%`;

        // Update progress circles
        updateProgressCircles(stats);

        // Update streak info
        document.getElementById('streakInfo').textContent = `Current streak: ${stats.streak} days`;

      } catch (error) {
        console.error('Error loading quiz stats:', error);
      }
    }

    // Update progress circles
    function updateProgressCircles(stats) {
      // Accuracy circle
      const accuracy = stats.totalQuestions > 0 ?
        Math.round((stats.totalCorrect / stats.totalQuestions) * 100) : 0;
      const accuracyCircle = document.getElementById('accuracyCircle');
      if (accuracyCircle) {
        accuracyCircle.style.background = `conic-gradient(var(--primary) 0% ${accuracy}%, var(--light) ${accuracy}% 100%)`;
        accuracyCircle.querySelector('.progress-value').textContent = `${accuracy}%`;
      }

      // Completion circle (quizzes completed vs potential)
      const completionCircle = document.getElementById('completionCircle');
      if (completionCircle) {
        // Simple completion metric based on quiz count
        const completion = Math.min(100, (stats.totalQuizzes || 0) * 10);
        completionCircle.style.background = `conic-gradient(var(--secondary) 0% ${completion}%, var(--light) ${completion}% 100%)`;
        completionCircle.querySelector('.progress-value').textContent = `${completion}%`;
      }

      // Best score bar
      const bestScoreBar = document.getElementById('bestScoreBar');
      const bestScoreValue = document.getElementById('bestScoreValue');
      if (bestScoreBar && bestScoreValue) {
        bestScoreBar.style.width = `${stats.bestScore || 0}%`;
        bestScoreValue.textContent = `${stats.bestScore || 0}%`;
      }
    }

    // Load quiz history
    function loadQuizHistory() {
      try {
        const history = JSON.parse(localStorage.getItem('quiz_history')) || [];
        const container = document.getElementById('quizHistory');

        if (!container) return;

        if (history.length === 0) {
          container.innerHTML = `
        <div class="empty-history">
          <span class="material-icons-round">quiz</span>
          <p>No quiz history yet</p>
          <small>Complete your first quiz to see history here!</small>
        </div>
      `;
          return;
        }

        const historyHTML = history.slice(0, 5).map(quiz => {
          const date = new Date(quiz.date);
          const dateString = date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric'
          });
          const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

          const scoreColor = quiz.score >= 80 ? '#10b981' :
            quiz.score >= 60 ? '#f59e0b' : '#ef4444';

          return `
        <div class="history-item">
          <div class="history-info">
            <div class="history-type">
              <span class="material-icons-round">quiz</span>
              <span class="history-title">${quiz.type.charAt(0).toUpperCase() + quiz.type.slice(1)} Quiz</span>
            </div>
            <div class="history-date">${dateString} • ${timeString}</div>
            <div style="font-size: 14px; color: var(--gray); margin-top: 4px;">
              ${quiz.correct}/${quiz.questions} correct • ${quiz.points} points
            </div>
          </div>
          <div class="history-score">
            <div class="score-value" style="color: ${scoreColor}">${quiz.score}%</div>
            <div class="score-percent">Score</div>
          </div>
        </div>
      `;
        }).join('');

        container.innerHTML = historyHTML;
      } catch (error) {
        console.error('Error loading quiz history:', error);
      }
    }

    // Check daily challenge
    function checkDailyChallenge() {
      try {
        const stats = JSON.parse(localStorage.getItem('quiz_stats')) || { lastQuizDate: null };
        const today = new Date().toISOString().split('T')[0];
        const isCompletedToday = stats.lastQuizDate === today;

        const dailyStatus = document.getElementById('dailyStatus');
        if (dailyStatus) {
          if (isCompletedToday) {
            dailyStatus.innerHTML = `
          <span class="status-badge complete">
            <span class="material-icons-round">check_circle</span>
            Completed Today
          </span>
        `;
          } else {
            dailyStatus.innerHTML = `
          <span class="status-badge incomplete">
            <span class="material-icons-round">pending</span>
            Not Started
          </span>
        `;
          }
        }
      } catch (error) {
        console.error('Error checking daily challenge:', error);
      }
    }

    // Start daily challenge
    function startDailyChallenge() {
      startQuiz('random');
    }

    // Category quiz modal
    function openCategoryQuizModal() {
      const modal = document.getElementById('categoryQuizModal');
      const grid = document.getElementById('categoryQuizOptions');

      if (!modal || !grid) return;

      // Clear existing options
      grid.innerHTML = '';

      // Add category options
      let hasCategories = false;

      vocabularyApp.categories.forEach(category => {
        const wordCount = vocabularyApp.words.filter(w =>
          !w.is_deleted && w.category === category
        ).length;

        if (wordCount > 0) {
          hasCategories = true;

          const option = document.createElement('div');
          option.className = 'category-quiz-option';
          option.onclick = () => {
            startCategoryQuiz(category);
          };

          const color = getCategoryColor(category);

          option.innerHTML = `
        <span class="material-icons-round" style="color: ${color}">folder_open</span>
        <h4>${category}</h4>
        <small>${wordCount} words available</small>
      `;

          grid.appendChild(option);
        }
      });

      if (!hasCategories) {
        grid.innerHTML = `
      <div style="text-align: center; padding: 40px; color: var(--gray);">
        <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">folder_open</span>
        <p style="margin-top: 15px;">No categories with words yet</p>
        <small>Add words with categories first</small>
      </div>
    `;
      }

      modal.classList.add('active');
    }

    function closeCategoryQuizModal() {
      const modal = document.getElementById('categoryQuizModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    function startCategoryQuiz(category) {
      closeCategoryQuizModal();
      startQuiz('category', category);
    }

    // Reset quiz stats
    function resetQuizStats() {
      if (confirm('Are you sure you want to reset all quiz statistics? This cannot be undone.')) {
        try {
          localStorage.removeItem('quiz_stats');
          localStorage.removeItem('quiz_history');
          loadQuizStats();
          loadQuizHistory();
          showMessage('Quiz statistics have been reset', 'success');
        } catch (error) {
          console.error('Error resetting quiz stats:', error);
          showMessage('Error resetting statistics', 'error');
        }
      }
    }

    // View full history
    function viewFullHistory() {
      // For now, just show all history in the current view
      const history = JSON.parse(localStorage.getItem('quiz_history')) || [];
      const container = document.getElementById('quizHistory');

      if (!container || history.length === 0) return;

      const fullHistoryHTML = history.map(quiz => {
        const date = new Date(quiz.date);
        const dateString = date.toLocaleDateString('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
        const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const scoreColor = quiz.score >= 80 ? '#10b981' :
          quiz.score >= 60 ? '#f59e0b' : '#ef4444';

        return `
      <div class="history-item">
        <div class="history-info">
          <div class="history-type">
            <span class="material-icons-round">quiz</span>
            <span class="history-title">${quiz.type.charAt(0).toUpperCase() + quiz.type.slice(1)} Quiz</span>
          </div>
          <div class="history-date">${dateString} • ${timeString}</div>
          <div style="font-size: 14px; color: var(--gray); margin-top: 4px;">
            ${quiz.correct}/${quiz.questions} correct • ${quiz.points} points • ${Math.round(quiz.time / 60)} minutes
          </div>
        </div>
        <div class="history-score">
          <div class="score-value" style="color: ${scoreColor}">${quiz.score}%</div>
          <div class="score-percent">Score</div>
        </div>
      </div>
    `;
      }).join('');

      container.innerHTML = fullHistoryHTML;

      showMessage('Showing all quiz history', 'info');
    }

    // Get category color
    function getCategoryColor(category) {
      return vocabularyApp.categoryColors[category] || '#6366f1';
    }

    // Initialize quiz when tab is opened
    document.addEventListener('DOMContentLoaded', function () {
      // Make sure quiz functions are available globally
      window.startQuiz = startQuiz;
      window.openCategoryQuizModal = openCategoryQuizModal;
      window.startDailyChallenge = startDailyChallenge;
      window.resetQuizStats = resetQuizStats;
      window.viewFullHistory = viewFullHistory;
      window.handleAnswerSelection = handleAnswerSelection;
      window.cancelQuiz = cancelQuiz;
      window.retryQuiz = retryQuiz;
      window.showQuizMain = showQuizMain;
      window.shareResults = shareResults;
    });


































    // ========== BUTTON FUNCTIONS ==========
    async function backupData() {
      const backupBtn = document.getElementById('backupBtn');
      const backupIcon = document.getElementById('backupIcon');
      const backupText = document.getElementById('backupText');

      if (backupBtn) {
        backupBtn.disabled = true;
        backupIcon.classList.add('spin');
        backupText.textContent = 'Backing up...';
      }

      try {
        const activeWords = vocabularyApp.words.filter(w => !w.is_deleted);
        const backup = {
          timestamp: new Date().toISOString(),
          version: '4.1',
          device_id: DEVICE_ID,
          wordCount: activeWords.length,
          categories: vocabularyApp.categories,
          categoryColors: vocabularyApp.categoryColors,
          words: activeWords
        };

        const dataStr = JSON.stringify(backup, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        const fileName = `vocabulary_backup_${new Date().toISOString().split('T')[0]}.json`;

        const link = document.createElement('a');
        link.setAttribute('href', dataUri);
        link.setAttribute('download', fileName);
        link.click();

        showMessage(`Backup created with ${activeWords.length} words`, 'success');

      } catch (error) {
        console.error('Backup error:', error);
        showMessage('Backup failed', 'error');
      } finally {
        resetButton(backupBtn, backupIcon, backupText, 'backup', 'Create Backup');
      }
    }

    async function clearAllData() {
      const activeWords = vocabularyApp.words.filter(w => !w.is_deleted).length;
      if (activeWords === 0) {
        showMessage('No data to clear', 'info');
        return;
      }

      if (!confirm(`Clear ALL ${activeWords} local words? This cannot be undone!`)) {
        return;
      }

      const clearBtn = document.getElementById('clearBtn');
      const clearIcon = document.getElementById('clearIcon');
      const clearText = document.getElementById('clearText');

      if (clearBtn) {
        clearBtn.disabled = true;
        clearIcon.classList.add('spin');
        clearText.textContent = 'Clearing...';
      }

      try {
        await backupData();

        vocabularyApp.words = [];
        localStorage.removeItem(STORAGE_KEY);

        loadWords();
        updateStats();
        updateWordCounts();

        showMessage('All local data cleared', 'success');

      } catch (error) {
        showMessage('Error clearing data', 'error');
      } finally {
        resetButton(clearBtn, clearIcon, clearText, 'delete_forever', 'Clear All Data');
      }
    }

    function refreshData() {
      const refreshBtn = document.getElementById('refreshBtn');
      const refreshIcon = document.getElementById('refreshIcon');
      const refreshText = document.getElementById('refreshText');

      if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshIcon.classList.add('spin');
        refreshText.textContent = 'Refreshing...';
      }

      loadWords();
      updateStats();
      updateWordCounts();

      setTimeout(() => {
        resetButton(refreshBtn, refreshIcon, refreshText, 'refresh', 'Refresh');
        showMessage('Word list refreshed', 'success');
      }, 1000);
    }

    function exportData() {
      const activeWords = vocabularyApp.words.filter(w => !w.is_deleted);
      const data = {
        version: '4.1',
        exportedAt: new Date().toISOString(),
        device_id: DEVICE_ID,
        wordCount: activeWords.length,
        categories: vocabularyApp.categories,
        categoryColors: vocabularyApp.categoryColors,
        words: activeWords
      };

      const dataStr = JSON.stringify(data, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      const fileName = `vocabulary_export_${new Date().toISOString().split('T')[0]}.json`;

      const link = document.createElement('a');
      link.setAttribute('href', dataUri);
      link.setAttribute('download', fileName);
      link.click();

      showMessage(`Exported ${activeWords.length} words`, 'success');
    }

    async function exportServerExcel() {
      if (!vocabularyApp.serverOnline) {
        showMessage('No server connection', 'error');
        return;
      }

      try {
        const response = await fetch(`${SERVER_URL}/api/export_excel`);
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `vocabulary_all_devices_${new Date().toISOString().split('T')[0]}.xlsx`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          showMessage('Excel file downloaded from server', 'success');
        } else {
          throw new Error('Export failed');
        }
      } catch (error) {
        console.error('Excel export failed:', error);
        showMessage('Failed to download Excel file', 'error');
      }
    }

    function clearForm() {
      document.getElementById('word').value = '';
      document.getElementById('bangla').value = '';
      document.getElementById('english').value = '';
      document.getElementById('synonyms').value = '';
      document.getElementById('example').value = '';
      document.getElementById('wordExistsAlert').classList.remove('show');
    }

    // ========== TAB SWITCHING ==========
    function switchTab(tabName) {
      // Remove active class from all tabs
      document.querySelectorAll('.app-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Remove active class from all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // Add active class to clicked tab
      event.currentTarget.classList.add('active');

      // Show the corresponding tab content
      const tabContent = document.getElementById(tabName + '-tab');
      if (tabContent) {
        tabContent.classList.add('active');












        // Initialize the tab content
        switch (tabName) {
          case 'view':
            loadWords();
            break;
          case 'flashcards':
            if (typeof initializeFlashcards === 'function') {
              setTimeout(() => {
                initializeFlashcards();
                loadFlashcards();
              }, 50);
            }
            break;
          case 'quiz':
            // Initialize quiz with a small delay to ensure DOM is ready
            setTimeout(() => {
              if (typeof initializeQuiz === 'function') {
                initializeQuiz();
              }
            }, 100);
            break;
          case 'sync':
            updateStats();
            updateWordCounts();
            checkServerConnection();
            break;
        }
      }
    }

























    // ========== MESSAGES ==========
    function showMessage(text, type) {
      const area = document.getElementById('messageArea');
      if (!area) return;

      area.innerHTML = '';

      const message = document.createElement('div');
      message.className = `message message-${type}`;
      message.innerHTML = `
          <span class="material-icons-round">
              ${type === 'success' ? 'check_circle' :
          type === 'error' ? 'error' :
            type === 'warning' ? 'warning' : 'info'}
          </span>
          ${text}
      `;

      area.appendChild(message);

      setTimeout(() => {
        message.style.opacity = '0';
        message.style.transition = 'opacity 0.5s';
        setTimeout(() => {
          if (message.parentNode === area) {
            area.removeChild(message);
          }
        }, 500);
      }, 4000);
    }

    // ========== EXCEL IMPORT FUNCTIONS ==========
    let selectedFile = null;

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Check file type
      if (!file.name.match(/\.(xlsx|xls)$/i)) {
        showMessage('Please select an Excel file (.xlsx or .xls)', 'error');
        return;
      }

      // Check file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        showMessage('File size should be less than 10MB', 'error');
        return;
      }

      selectedFile = file;

      // Display file info
      document.getElementById('fileInfo').style.display = 'block';
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);

      // Enable import button
      document.getElementById('importBtn').disabled = false;

      showMessage(`Selected file: ${file.name}`, 'info');
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function clearSelectedFile() {
      selectedFile = null;
      document.getElementById('excelFileInput').value = '';
      document.getElementById('fileInfo').style.display = 'none';
      document.getElementById('importBtn').disabled = true;
      document.getElementById('importProgress').style.display = 'none';
    }

    async function downloadImportTemplate() {
      try {
        const response = await fetch(`${SERVER_URL}/api/import_template`);

        if (!response.ok) {
          throw new Error('Failed to download template');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'vocabulary_import_template.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showMessage('Import template downloaded successfully!', 'success');
      } catch (error) {
        console.error('Template download error:', error);
        showMessage('Failed to download template: ' + error.message, 'error');
      }
    }

    async function importExcelFile() {
      if (!selectedFile) {
        showMessage('Please select an Excel file first', 'error');
        return;
      }

      const importBtn = document.getElementById('importBtn');
      const importIcon = document.getElementById('importIcon');
      const importText = document.getElementById('importText');
      const progressDiv = document.getElementById('importProgress');
      const progressBar = document.getElementById('importProgressBar');
      const progressPercent = document.getElementById('importPercent');
      const progressDetails = document.getElementById('importDetails');

      // Show progress
      progressDiv.style.display = 'block';
      progressBar.style.width = '10%';
      progressPercent.textContent = '10%';
      progressDetails.innerHTML = 'Preparing upload...';

      // Disable import button
      importBtn.disabled = true;
      importIcon.classList.add('spin');
      importText.textContent = 'Importing...';

      const formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('device_id', DEVICE_ID);
      formData.append('device_name', DEVICE_NAME);

      try {
        progressBar.style.width = '30%';
        progressPercent.textContent = '30%';
        progressDetails.innerHTML = 'Uploading file to server...';

        const response = await fetch(`${SERVER_URL}/api/import_excel`, {
          method: 'POST',
          body: formData
        });

        progressBar.style.width = '70%';
        progressPercent.textContent = '70%';
        progressDetails.innerHTML = 'Processing data...';

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.message || 'Import failed');
        }

        progressBar.style.width = '100%';
        progressPercent.textContent = '100%';

        // Update details
        progressDetails.innerHTML = `
            <div style="color: var(--success);">
              <strong>Import Complete!</strong><br>
              Total rows: ${result.details.total_rows}<br>
              Imported: ${result.details.imported}<br>
              Skipped: ${result.details.skipped}
            </div>
          `;

        showMessage(`Successfully imported ${result.details.imported} words from Excel file!`, 'success');

        // Clear file selection
        clearSelectedFile();

        // Refresh data
        setTimeout(() => {
          downloadAllFromServer();
          progressDiv.style.display = 'none';
        }, 2000);

      } catch (error) {
        console.error('Import error:', error);
        progressBar.style.width = '100%';
        progressPercent.textContent = '100%';
        progressDetails.innerHTML = `<div style="color: var(--danger);">Import failed: ${error.message}</div>`;

        showMessage('Import failed: ' + error.message, 'error');
      } finally {
        setTimeout(() => {
          importBtn.disabled = false;
          importIcon.classList.remove('spin');
          importText.textContent = 'Import Excel File';
        }, 2000);
      }
    }

    function openImportHistoryModal() {
      document.getElementById('importHistoryModal').classList.add('active');
      loadImportHistory();
    }

    function closeImportHistoryModal() {
      document.getElementById('importHistoryModal').classList.remove('active');
    }

    async function loadImportHistory() {
      const content = document.getElementById('importHistoryContent');

      try {
        const response = await fetch(`${SERVER_URL}/api/import_history?device_id=${DEVICE_ID}`);

        if (!response.ok) {
          throw new Error('Failed to load import history');
        }

        const result = await response.json();

        if (!result.imports || result.imports.length === 0) {
          content.innerHTML = `
              <div style="text-align: center; padding: 40px;">
                <div class="material-icons-round" style="font-size: 48px; color: var(--gray); opacity: 0.5;">history</div>
                <div style="margin-top: 15px; color: var(--gray);">No import history found</div>
              </div>
            `;
          return;
        }

        let html = `
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: var(--light);">
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border);">File</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border);">Time</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border);">Results</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border);">Status</th>
                  </tr>
                </thead>
                <tbody>
          `;

        result.imports.forEach(importItem => {
          const date = new Date(importItem.timestamp).toLocaleString();
          const statusColor = importItem.status === 'success' ? 'var(--success)' : 'var(--danger)';

          html += `
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 12px;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="material-icons-round" style="font-size: 18px; color: var(--gray);">description</span>
                    <div style="font-weight: 500;">${importItem.filename}</div>
                  </div>
                </td>
                <td style="padding: 12px; color: var(--gray); font-size: 14px;">${date}</td>
                <td style="padding: 12px;">
                  <div style="font-size: 14px;">
                    <span style="color: var(--success);">${importItem.imported_rows}✓</span>
                    <span style="color: var(--gray); margin: 0 5px;">/</span>
                    <span>${importItem.total_rows} total</span>
                    ${importItem.skipped_rows > 0 ?
              `<span style="color: var(--warning); margin-left: 8px;">${importItem.skipped_rows} skipped</span>` : ''}
                  </div>
                </td>
                <td style="padding: 12px;">
                  <span style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; background: ${statusColor === 'var(--success)' ? '#d1fae5' : '#fee2e2'}; color: ${statusColor}; font-weight: 600; font-size: 12px;">
                    <span class="material-icons-round" style="font-size: 14px;">${importItem.status === 'success' ? 'check_circle' : 'error'}</span>
                    ${importItem.status === 'success' ? 'Success' : 'Failed'}
                  </span>
                </td>
              </tr>
            `;
        });

        html += `
                </tbody>
              </table>
            </div>
          `;

        content.innerHTML = html;

      } catch (error) {
        console.error('Error loading import history:', error);
        content.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <div class="material-icons-round" style="font-size: 48px; color: var(--danger);">error</div>
              <div style="margin-top: 15px; color: var(--danger);">Failed to load import history</div>
              <div style="margin-top: 10px; color: var(--gray); font-size: 14px;">${error.message}</div>
            </div>
          `;
      }
    }

    function refreshImportHistory() {
      loadImportHistory();
    }

    // ========== AUTO SYNC ==========
    function setupAutoSync() {
      // Auto-sync every 2 minutes when online
      setInterval(async () => {
        if (navigator.onLine && vocabularyApp.serverOnline) {
          const pending = vocabularyApp.words.filter(w =>
            w.device_source === DEVICE_ID &&
            (!w.synced_to_server || w.is_edited || w.is_deleted)
          ).length;

          if (pending > 0) {
            console.log(`Auto-syncing ${pending} pending changes...`);
            try {
              await syncAllData();
            } catch (error) {
              console.log('Auto-sync failed:', error);
            }
          }

          // Also check for remote deletions periodically
          try {
            await downloadDeletedWords();
            loadWords();
            updateStats();
            updateWordCounts();
          } catch (error) {
            console.log('Auto-check for deletions failed:', error);
          }
        }
      }, 120000); // 2 minutes
    }

    // ========== UPDATED INITIALIZATION ==========
    async function initializeApp() {
      console.log('Initializing Vocabulary Pro v4.2 with all fixes...');

      // Set device ID and name
      if (!localStorage.getItem('device_id')) {
        localStorage.setItem('device_id', DEVICE_ID);
      }
      if (!localStorage.getItem('device_name')) {
        localStorage.setItem('device_name', DEVICE_NAME);
      }

      // Load data
      vocabularyApp.words = loadFromStorage();

      // Load categories
      await loadCategoriesFromServer();

      console.log(`Loaded ${vocabularyApp.words.filter(w => !w.is_deleted).length} words, ${vocabularyApp.categories.length} categories`);

      // Update UI
      loadWords();
      updateStats();
      updateWordCounts();

      // Enhance category dropdowns
      enhanceCategoryDropdowns();

      // Initialize enhanced dropdowns
      initializeEnhancedDropdowns();

      // Load last sync time
      const lastSync = localStorage.getItem('last_sync_time');
      if (lastSync) {
        document.getElementById('lastSyncTime').textContent = lastSync;
      } else {
        document.getElementById('lastSyncTime').textContent = 'Never';
      }

      // Preload speech synthesis
      if ('speechSynthesis' in window) {
        speechSynthesis.getVoices();
      }

      // Check server connection
      await checkServerConnection();

      // On first load, check for remote deletions
      if (vocabularyApp.serverOnline) {
        setTimeout(async () => {
          try {
            await downloadDeletedWords();
            await downloadAllFromServer();
            loadWords();
            updateStats();
            updateWordCounts();
          } catch (error) {
            console.log('Initial sync failed:', error);
          }
        }, 2000);
      }

      // Setup auto-sync
      setupAutoSync();

      // Setup network listeners
      window.addEventListener('online', async () => {
        showMessage('Internet connection restored', 'info');
        await checkServerConnection();

        // Sync immediately when coming back online
        if (vocabularyApp.serverOnline) {
          setTimeout(() => {
            syncAllData();
          }, 3000);
        }
      });

      window.addEventListener('offline', () => {
        showMessage('Working offline', 'warning');
        document.getElementById('connectionStatus').className = 'connection-status status-offline';
        document.getElementById('connectionStatus').innerHTML = `<span class="material-icons-round">wifi_off</span><span>Offline mode</span>`;
      });

      // Auto-save every 30 seconds
      setInterval(() => {
        if (vocabularyApp.words.length > 0) {
          saveToStorage();
        }
      }, 30000);

      // Show welcome message
      const activeWords = vocabularyApp.words.filter(w => !w.is_deleted).length;
      if (activeWords === 0) {
        showMessage('Welcome to Vocabulary Pro! Add your first word to get started.', 'info');
      } else {
        const myWords = vocabularyApp.words.filter(w => w.device_source === DEVICE_ID && !w.is_deleted).length;
        const otherWords = activeWords - myWords;
        showMessage(`Loaded ${activeWords} words (${myWords} yours, ${otherWords} from others)`, 'success');
      }
    }

    // Add drag and drop functionality
    document.addEventListener('DOMContentLoaded', function () {
      // Wait a bit for DOM to be fully loaded
      setTimeout(() => {
        const fileInput = document.getElementById('excelFileInput');
        if (!fileInput) return;

        const dropZone = fileInput.parentElement;

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });

        // Highlight drop zone when dragging over
        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });






        setTimeout(() => {
          initializeAllFlashcards();
          initializeFlashcardCategories();
        }, 100)


        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        function highlight(e) {
          dropZone.style.borderColor = 'var(--primary)';
          dropZone.style.background = 'rgba(99, 102, 241, 0.05)';
        }

        function unhighlight(e) {
          dropZone.style.borderColor = 'var(--border)';
          dropZone.style.background = 'white';
        }

        // Check notification status
        setTimeout(checkNotificationStatusOnLoad, 1500);


        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;

          if (files.length > 0) {
            const file = files[0];

            // Check file type
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
              showMessage('Please select an Excel file (.xlsx or .xls)', 'error');
              return;
            }

            // Create a new FileList-like object
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);

            // Assign to input
            fileInput.files = dataTransfer.files;

            // Trigger change event
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
          }
        }
      }, 1000);
    });

    // Start the app
    document.addEventListener('DOMContentLoaded', initializeApp);

    // Auto-save before unload
    window.addEventListener('beforeunload', () => {
      if (vocabularyApp.words.length > 0) {
        saveToStorage();
      }
    });
  </script>
</body>

</html>